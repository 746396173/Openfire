{
  ClassLoader oldLoader=Thread.currentThread().getContextClassLoader();
  Thread.currentThread().setContextClassLoader(pluginLoader);
  final PluginModule module=new PluginModule();
  com.google.inject.Module tempModule;
  if (moduleClazz == null) {
    tempModule=null;
  }
 else {
    tempModule=moduleClazz.newInstance();
  }
  final com.google.inject.Module pluginModule=tempModule;
  AbstractPlugin plugin=Guice.createInjector(new AbstractModule(){
    protected void configure(){
      install(module);
      if (pluginModule != null) {
        install(pluginModule);
      }
      bind(pluginClazz);
    }
  }
).getInstance(pluginClazz);
  Thread.currentThread().setContextClassLoader(oldLoader);
  return plugin;
}
