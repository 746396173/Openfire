{
  XmlPullParser xpp=reader.getXPPParser();
  StringBuilder sb;
  StreamError error;
  if ("jabber:server:dialback".equals(xpp.getNamespace("db"))) {
    StreamID streamID=sessionManager.nextStreamID();
    sb=new StringBuilder();
    sb.append("<stream:stream");
    sb.append(" xmlns:stream=\"http://etherx.jabber.org/streams\"");
    sb.append(" xmlns=\"jabber:server\" xmlns:db=\"jabber:server:dialback\"");
    sb.append(" id=\"");
    sb.append(streamID.toString());
    sb.append("\">");
    connection.deliverRawText(sb.toString());
    try {
      Element doc=reader.parseDocument().getRootElement();
      if ("db".equals(doc.getNamespacePrefix()) && "result".equals(doc.getName())) {
        if (validateRemoteDomain(doc,streamID)) {
          String hostname=doc.attributeValue("from");
          IncomingServerSession session=sessionManager.createIncomingServerSession(connection,streamID);
          session.setAddress(new JID(null,hostname,null));
          session.addValidatedDomain(hostname);
          return session;
        }
      }
 else       if ("db".equals(doc.getNamespacePrefix()) && "verify".equals(doc.getName())) {
        String verifyFROM=doc.attributeValue("from");
        String verifyTO=doc.attributeValue("to");
        String key=doc.getTextTrim();
        String id=doc.attributeValue("id");
        Log.debug("AS - Verifying key for host: " + verifyFROM + " id: "+ id);
        String expectedKey=AuthFactory.createDigest(id,secretKey);
        boolean verified=expectedKey.equals(key);
        sb=new StringBuilder();
        sb.append("<db:verify");
        sb.append(" from=\"" + verifyTO + "\"");
        sb.append(" to=\"" + verifyFROM + "\"");
        sb.append(" type=\"");
        sb.append(verified ? "valid" : "invalid");
        sb.append("\" id=\"" + id + "\"/>");
        connection.deliverRawText(sb.toString());
        Log.debug("AS - Key was: " + (verified ? "VALID" : "INVALID") + " for host: "+ verifyFROM+ " id: "+ id);
        connection.close();
        Log.debug("AS - Connection closed for host: " + verifyFROM + " id: "+ id);
        sb=null;
        return null;
      }
 else {
        error=new StreamError(StreamError.Condition.invalid_xml);
        sb=new StringBuilder();
        sb.append(error.toXML());
        connection.deliverRawText(sb.toString());
        connection.close();
        return null;
      }
    }
 catch (    Exception e) {
      Log.error("An error occured while creating a server session",e);
      connection.close();
      return null;
    }
  }
 else {
    error=new StreamError(StreamError.Condition.invalid_namespace);
    sb=new StringBuilder();
    sb.append(error.toXML());
    connection.deliverRawText(sb.toString());
    connection.close();
    return null;
  }
  return null;
}
