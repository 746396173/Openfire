{
  XPPPacketReader reader=null;
  Writer writer=null;
  StreamError error;
  Log.debug("RS - Trying to connect to Authoritative Server: " + hostname + ":"+ port);
  Socket socket=SocketFactory.getDefault().createSocket(host,port);
  socket.setSoTimeout(60000);
  Log.debug("RS - Connection to AS: " + hostname + ":"+ port+ " successfull");
  try {
    reader=new XPPPacketReader();
    reader.setXPPFactory(FACTORY);
    reader.getXPPParser().setInput(new InputStreamReader(socket.getInputStream(),CHARSET));
    writer=new BufferedWriter(new OutputStreamWriter(socket.getOutputStream(),CHARSET));
    StringBuilder stream=new StringBuilder();
    stream.append("<stream:stream");
    stream.append(" xmlns:stream=\"http://etherx.jabber.org/streams\"");
    stream.append(" xmlns=\"jabber:server\"");
    stream.append(" xmlns:db=\"jabber:server:dialback\">");
    writer.write(stream.toString());
    writer.flush();
    stream=null;
    XmlPullParser xpp=reader.getXPPParser();
    for (int eventType=xpp.getEventType(); eventType != XmlPullParser.START_TAG; ) {
      eventType=xpp.next();
    }
    if ("jabber:server:dialback".equals(xpp.getNamespace("db"))) {
      Log.debug("RS - Asking AS to verify dialback key for id" + streamID);
      StringBuilder sb=new StringBuilder();
      sb.append("<db:verify");
      sb.append(" from=\"" + serverName + "\"");
      sb.append(" to=\"" + hostname + "\"");
      sb.append(" id=\"" + streamID + "\">");
      sb.append(key);
      sb.append("</db:verify>");
      writer.write(sb.toString());
      writer.flush();
      sb=null;
      try {
        Element doc=reader.parseDocument().getRootElement();
        if ("db".equals(doc.getNamespacePrefix()) && "verify".equals(doc.getName())) {
          if (!streamID.equals(doc.attributeValue("id"))) {
            error=new StreamError(StreamError.Condition.invalid_id);
            sb=new StringBuilder();
            sb.append(error.toXML());
            writer.write(sb.toString());
            writer.flush();
            throw new RemoteConnectionFailedException("Invalid ID");
          }
 else           if (!serverName.equals(doc.attributeValue("to"))) {
            error=new StreamError(StreamError.Condition.host_unknown);
            sb=new StringBuilder();
            sb.append(error.toXML());
            writer.write(sb.toString());
            writer.flush();
            throw new RemoteConnectionFailedException("Host unknown");
          }
 else           if (!hostname.equals(doc.attributeValue("from"))) {
            error=new StreamError(StreamError.Condition.invalid_from);
            sb=new StringBuilder();
            sb.append(error.toXML());
            writer.write(sb.toString());
            writer.flush();
            throw new RemoteConnectionFailedException("Invalid From");
          }
 else {
            boolean valid="valid".equals(doc.attributeValue("type"));
            Log.debug("RS - Key was " + (valid ? "" : "NOT ") + "VERIFIED by the Authoritative Server for: "+ hostname);
            return valid;
          }
        }
 else {
          Log.debug("db:verify answer was: " + doc.asXML());
        }
      }
 catch (      DocumentException e) {
        Log.error("An error occured connecting to the Authoritative Server",e);
        throw new RemoteConnectionFailedException("Error connecting to the Authoritative Server");
      }
    }
 else {
      error=new StreamError(StreamError.Condition.invalid_namespace);
      StringBuilder sb=new StringBuilder();
      sb.append(error.toXML());
      writer.write(sb.toString());
      writer.flush();
      throw new RemoteConnectionFailedException("Invalid namespace");
    }
  }
  finally {
    try {
      Log.debug("RS - Closing connection to Authoritative Server: " + hostname);
      StringBuilder sb=new StringBuilder();
      sb.append("</stream:stream>");
      writer.write(sb.toString());
      writer.flush();
      socket.close();
    }
 catch (    IOException ioe) {
    }
  }
  return false;
}
