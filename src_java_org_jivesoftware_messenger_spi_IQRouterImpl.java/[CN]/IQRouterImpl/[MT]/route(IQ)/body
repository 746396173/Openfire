{
  if (packet == null) {
    throw new NullPointerException();
  }
  Session session=SessionManager.getInstance().getSession(packet.getFrom());
  if (session == null || session.getStatus() == Session.STATUS_AUTHENTICATED || (isLocalServer(packet.getTo()) && ("jabber:iq:auth".equals(packet.getChildNamespace()) || "jabber:iq:register".equals(packet.getChildNamespace())))) {
    handle(packet);
  }
 else {
    packet.setRecipient(packet.getOriginatingSession().getAddress());
    packet.setSender(null);
    packet.setError(XMPPError.Code.UNAUTHORIZED);
    try {
      packet.getOriginatingSession().process(packet);
    }
 catch (    UnauthorizedException ue) {
      Log.error(ue);
    }
  }
}
