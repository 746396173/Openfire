{
  try {
    matchLock.writeLock().lock();
    if ((transitions & TRANSITION_MATCH_MATCH) != 0) {
      matchMatchListeners.put(tmpl,listener);
    }
    if ((transitions & TRANSITION_MATCH_NOMATCH) != 0) {
      matchNoMatchListeners.put(tmpl,listener);
    }
    if ((transitions & TRANSITION_NOMATCH_MATCH) != 0) {
      noMatchMatchListeners.put(tmpl,listener);
    }
    List templates=(List)listeners.get(listener);
    if (templates == null) {
      templates=new LinkedList();
      listeners.put(listener,templates);
    }
    templates.add(tmpl);
    return new ServiceEventRegistrationImpl(this,listener,EVENT_ID,sequenceID);
  }
  finally {
    matchLock.writeLock().unlock();
  }
}
