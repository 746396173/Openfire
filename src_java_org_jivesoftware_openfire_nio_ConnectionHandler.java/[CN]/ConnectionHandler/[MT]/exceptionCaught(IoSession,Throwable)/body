{
  if (cause instanceof IOException) {
    Log.info("ConnectionHandler reports IOException for session: " + session,cause);
  }
 else   if (cause instanceof ProtocolDecoderException) {
    Log.warn("Closing session due to exception: " + session,cause);
    final StreamError error;
    if (cause.getCause() != null && cause.getCause() instanceof XMLNotWellFormedException) {
      error=new StreamError(StreamError.Condition.not_well_formed);
    }
 else {
      error=new StreamError(StreamError.Condition.internal_server_error);
    }
    final Connection connection=(Connection)session.getAttribute(CONNECTION);
    connection.deliverRawText(error.toXML());
    session.close();
  }
 else {
    Log.error("ConnectionHandler reports unexpected exception for session: " + session,cause);
  }
}
