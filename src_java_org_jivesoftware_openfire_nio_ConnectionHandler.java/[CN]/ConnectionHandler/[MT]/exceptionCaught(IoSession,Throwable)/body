{
  Log.warn("Closing session due to exception: " + session,cause);
  try {
    final StreamError error;
    if (cause != null && (cause instanceof XMLNotWellFormedException || (cause.getCause() != null && cause.getCause() instanceof XMLNotWellFormedException))) {
      error=new StreamError(StreamError.Condition.not_well_formed);
    }
 else {
      error=new StreamError(StreamError.Condition.internal_server_error);
    }
    final Connection connection=(Connection)session.getAttribute(CONNECTION);
    connection.deliverRawText(error.toXML());
  }
  finally {
    session.close(false);
  }
}
