{
  IQ reply=IQ.createResultIQ(iq);
  String domain=XMPPServer.getInstance().getServerInfo().getXMPPDomain();
  try {
    Log.info("CallControlComponent - handleIQSet\n" + iq);
    Element element=iq.getChildElement();
    String namespace=element.getNamespaceURI();
    String request=element.getName();
    String confJid=null;
    String confId=null;
    if ("dial".equals(request) && "urn:xmpp:rayo:1".equals(namespace)) {
      Log.info("CallControlComponent - Dial");
      String from=element.attributeValue("from");
      String to=element.attributeValue("to");
      for (Iterator i=element.elementIterator("header"); i.hasNext(); ) {
        Element header=(Element)i.next();
        String name=header.attributeValue("name");
        String value=header.attributeValue("value");
        if ("JvbRoomName".equals(name))         confJid=value;
      }
      if (confJid == null) {
        reply.setError(PacketError.Condition.item_not_found);
        Log.error("No JvbRoomName header found");
      }
 else {
        if (conferences.containsKey(confJid)) {
          confId=conferences.get(confJid);
          String callId=Long.toHexString(System.currentTimeMillis());
          Log.info("Got dial request " + from + " -> "+ to+ " confId "+ confId+ " callId "+ callId);
          String callResource="xmpp:" + callId + "@"+ getJID();
          final Element childElement=reply.setChildElement("ref","urn:xmpp:rayo:1");
          childElement.addAttribute("uri",(String)"xmpp:" + callId + "@"+ getJID());
          childElement.addAttribute("id",(String)callId);
          Conference conference=null;
          for (          Conference conf : getVideobridge().getConferences()) {
            if (conf.getID().equals(confId)) {
              conference=conf;
              break;
            }
          }
          if (conference != null) {
            makeCall(conference,confJid,to,callId);
          }
 else {
            Log.error("CallControlComponent - can't find conference " + confId);
            reply.setError(PacketError.Condition.item_not_found);
          }
        }
 else {
          Log.error("CallControlComponent - focus not ready " + confJid);
          reply.setError(PacketError.Condition.item_not_found);
        }
      }
    }
 else     if ("accept".equals(request) && "urn:xmpp:rayo:1".equals(namespace)) {
      Log.info("CallControlComponent - Accept");
      String confName=null;
      for (Iterator i=element.elementIterator("header"); i.hasNext(); ) {
        Element header=(Element)i.next();
        String name=header.attributeValue("name");
        String value=header.attributeValue("value");
        if ("JvbRoomId".equals(name))         confId=value;
        if ("JvbRoomName".equals(name))         confName=value;
      }
      if (confId != null && confName != null) {
        Log.info("CallControlComponent - Accept register " + confId + " "+ confName);
        conferences.put(confName,confId);
      }
 else {
        reply.setError(PacketError.Condition.item_not_found);
        Log.error("No JvbRoomName or JvbRoomId header found");
      }
    }
 else     if ("hangup".equals(request) && "urn:xmpp:rayo:1".equals(namespace)) {
      Log.info("CallControlComponent - HangUp");
      String callId=iq.getTo().getNode();
      hangupCall(callId);
    }
 else     if ("record".equals(request) && "urn:xmpp:rayo:record:1".equals(namespace)) {
      Log.info("CallControlComponent - Record");
      String token=null;
      String state=null;
      String confName=null;
      for (Iterator i=element.elementIterator("hint"); i.hasNext(); ) {
        Element hint=(Element)i.next();
        String name=hint.attributeValue("name");
        String value=hint.attributeValue("value");
        if ("JvbToken".equals(name))         token=value;
        if ("JvbState".equals(name))         state=value;
        if ("JvbRoomName".equals(name))         confName=value;
      }
      if (token != null && state != null && confName != null) {
        if (conferences.containsKey(confName)) {
          confId=conferences.get(confName);
          Conference conference=null;
          for (          Conference conf : getVideobridge().getConferences()) {
            if (conf.getID().equals(confId)) {
              conference=conf;
              break;
            }
          }
          if (conference != null) {
            recordCall(conference,token,state);
          }
 else {
            Log.error("CallControlComponent - can't find conference " + confId);
            reply.setError(PacketError.Condition.item_not_found);
          }
        }
 else {
          Log.error("CallControlComponent - focus not ready " + confName);
          reply.setError(PacketError.Condition.item_not_found);
        }
      }
 else {
        reply.setError(PacketError.Condition.item_not_found);
        Log.error("No JvbRoomName, JvbToken or JvbState headers found");
      }
    }
 else {
      Log.warn("CallControlComponent - Unknown");
      reply.setError(PacketError.Condition.item_not_found);
    }
  }
 catch (  Exception e) {
    Log.error("CallControlComponent handleIQSet",e);
    reply.setError(PacketError.Condition.internal_server_error);
  }
  return reply;
}
