{
  if (isClosed()) {
    deliverer.deliver(packet);
  }
 else {
    try {
      InterceptorManager.getInstance().invokeInterceptors(packet,session,false,false);
      boolean errorDelivering=false;
      boolean allowedToWrite=false;
      try {
        requestWriting();
        allowedToWrite=true;
        xmlSerializer.write(packet.getElement());
        if (flashClient) {
          writer.write('\0');
        }
        xmlSerializer.flush();
      }
 catch (      Exception e) {
        Log.debug("Error delivering packet" + "\n" + this.toString(),e);
        errorDelivering=true;
      }
 finally {
        if (allowedToWrite) {
          releaseWriting();
        }
      }
      if (errorDelivering) {
        close();
        deliverer.deliver(packet);
      }
 else {
        InterceptorManager.getInstance().invokeInterceptors(packet,session,false,true);
        session.incrementServerPacketCount();
      }
    }
 catch (    PacketRejectedException e) {
    }
  }
}
