{
  Branch parent=document;
  int depth=0;
  int type=xpp.getEventType();
  for (boolean endFound=false; ; type=xpp.next()) {
switch (type) {
case XMLStreamConstants.END_DOCUMENT:
      throw new DocumentException("End of document");
case XMLStreamConstants.START_ELEMENT:
    depth++;
  Element newElement;
if (xpp.getNamespaceURI().equals("jabber:client")) {
  newElement=DocumentHelper.createElement(xpp.getLocalName());
}
 else {
  newElement=DocumentHelper.createElement(QName.get(xpp.getLocalName(),xpp.getNamespaceURI()));
}
for (int i=0; i < xpp.getAttributeCount(); i++) {
newElement.addAttribute(xpp.getAttributeLocalName(i),xpp.getAttributeValue(i));
}
parent.add(newElement);
parent=newElement;
break;
case XMLStreamConstants.END_ELEMENT:
depth--;
if (parent != null) {
parent=parent.getParent();
}
if (depth <= 0) {
endFound=true;
}
break;
case XMLStreamConstants.CDATA:
String cdata=xpp.getText();
if (parent != null) {
parent.add(DocumentHelper.createCDATA(cdata));
}
 else {
throw new DocumentException(LocaleUtils.getLocalizedString("admin.error.packet.text"));
}
break;
case XMLStreamConstants.CHARACTERS:
String chars=xpp.getText();
if (parent != null) {
parent.add(DocumentHelper.createText(chars));
}
 else {
throw new DocumentException(LocaleUtils.getLocalizedString("admin.error.packet.text"));
}
break;
case XMLStreamConstants.COMMENT:
parent.add(DocumentHelper.createComment(xpp.getText()));
break;
case XMLStreamConstants.ENTITY_REFERENCE:
Log.warn("Unexpected entity reference event occurred " + xpp.getText());
break;
default :
Log.warn("Unknown XML event occurred " + type);
}
if (endFound) {
break;
}
}
return document;
}
