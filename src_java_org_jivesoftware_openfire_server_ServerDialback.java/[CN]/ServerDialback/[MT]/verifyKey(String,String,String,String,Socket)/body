{
  XMPPPacketReader reader;
  Writer writer=null;
  socket.setSoTimeout(RemoteServerManager.getSocketTimeout());
  VerifyResult result=VerifyResult.error;
  try {
    reader=new XMPPPacketReader();
    reader.setXPPFactory(FACTORY);
    reader.getXPPParser().setInput(new InputStreamReader(socket.getInputStream(),CHARSET));
    writer=new BufferedWriter(new OutputStreamWriter(socket.getOutputStream(),CHARSET));
    StringBuilder stream=new StringBuilder();
    stream.append("<stream:stream");
    stream.append(" xmlns:stream=\"http://etherx.jabber.org/streams\"");
    stream.append(" xmlns=\"jabber:server\"");
    stream.append(" xmlns:db=\"jabber:server:dialback\"");
    stream.append(" version=\"1.0\">");
    writer.write(stream.toString());
    writer.flush();
    XmlPullParser xpp=reader.getXPPParser();
    for (int eventType=xpp.getEventType(); eventType != XmlPullParser.START_TAG; ) {
      eventType=xpp.next();
    }
    if ((xpp.getAttributeValue("","version") != null) && (xpp.getAttributeValue("","version").equals("1.0"))) {
      Document doc;
      try {
        doc=reader.parseDocument();
      }
 catch (      DocumentException e) {
        Log.warn("XML Error!",e);
        return VerifyResult.error;
      }
      Element features=doc.getRootElement();
      Element starttls=features.element("starttls");
      if (starttls != null) {
        if (starttls.element("required") != null) {
          Log.error("TLS required for db:verify but cannot yet do this.");
        }
      }
    }
    if ("jabber:server:dialback".equals(xpp.getNamespace("db"))) {
      Log.debug("ServerDialback: RS - Asking AS to verify dialback key for id" + streamID);
      StringBuilder sb=new StringBuilder();
      sb.append("<db:verify");
      sb.append(" from=\"").append(recipient).append("\"");
      sb.append(" to=\"").append(hostname).append("\"");
      sb.append(" id=\"").append(streamID).append("\">");
      sb.append(key);
      sb.append("</db:verify>");
      writer.write(sb.toString());
      writer.flush();
      try {
        Element doc=reader.parseDocument().getRootElement();
        if ("db".equals(doc.getNamespacePrefix()) && "verify".equals(doc.getName())) {
          if (!streamID.equals(doc.attributeValue("id"))) {
            writer.write(new StreamError(StreamError.Condition.invalid_id).toXML());
            writer.flush();
            throw new RemoteConnectionFailedException("Invalid ID");
          }
 else           if (isHostUnknown(doc.attributeValue("to"))) {
            writer.write(new StreamError(StreamError.Condition.host_unknown).toXML());
            writer.flush();
            throw new RemoteConnectionFailedException("Host unknown");
          }
 else           if (!hostname.equals(doc.attributeValue("from"))) {
            writer.write(new StreamError(StreamError.Condition.invalid_from).toXML());
            writer.flush();
            throw new RemoteConnectionFailedException("Invalid From");
          }
 else           if ("valid".equals(doc.attributeValue("type"))) {
            Log.debug("ServerDialback: RS - Key was VERIFIED by the Authoritative Server for: {}",hostname);
            result=VerifyResult.valid;
          }
 else           if ("invalid".equals(doc.attributeValue("type"))) {
            Log.debug("ServerDialback: RS - Key was NOT VERIFIED by the Authoritative Server for: {}",hostname);
            result=VerifyResult.invalid;
          }
 else {
            Log.debug("ServerDialback: RS - Key was ERRORED by the Authoritative Server for: {}",hostname);
            result=VerifyResult.error;
          }
        }
 else {
          Log.debug("ServerDialback: db:verify answer was: " + doc.asXML());
        }
      }
 catch (      DocumentException|RuntimeException e) {
        Log.error("An error occured connecting to the Authoritative Server",e);
        throw new RemoteConnectionFailedException("Error connecting to the Authoritative Server");
      }
    }
 else {
      writer.write(new StreamError(StreamError.Condition.invalid_namespace).toXML());
      writer.flush();
      throw new RemoteConnectionFailedException("Invalid namespace");
    }
  }
  finally {
    try {
      Log.debug("ServerDialback: RS - Closing connection to Authoritative Server: " + hostname);
      StringBuilder sb=new StringBuilder();
      sb.append("</stream:stream>");
      writer.write(sb.toString());
      writer.flush();
      socket.close();
    }
 catch (    IOException ioe) {
    }
  }
  return result;
}
