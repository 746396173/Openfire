{
  Element item;
  String affiliation=null;
  String roleAttribute=null;
  boolean hasJID=((Element)itemsList.get(0)).attributeValue("jid") != null;
  boolean hasNick=((Element)itemsList.get(0)).attributeValue("nick") != null;
  if (!hasJID && !hasNick) {
    for (Iterator items=itemsList.iterator(); items.hasNext(); ) {
      item=(Element)items.next();
      affiliation=item.attributeValue("affiliation");
      roleAttribute=item.attributeValue("role");
      Element result=reply.setChildElement("query","http://jabber.org/protocol/muc#admin");
      Element metaData;
      if ("outcast".equals(affiliation)) {
        if (MUCRole.ADMINISTRATOR != senderRole.getAffiliation() && MUCRole.OWNER != senderRole.getAffiliation()) {
          throw new ForbiddenException();
        }
        for (        String jid : room.getOutcasts()) {
          metaData=result.addElement("item","http://jabber.org/protocol/muc#admin");
          metaData.addAttribute("affiliation","outcast");
          metaData.addAttribute("jid",jid);
        }
      }
 else       if ("member".equals(affiliation)) {
        if (!room.isMembersOnly() && MUCRole.ADMINISTRATOR != senderRole.getAffiliation() && MUCRole.OWNER != senderRole.getAffiliation()) {
          throw new ForbiddenException();
        }
        for (        String jid : room.getMembers()) {
          metaData=result.addElement("item","http://jabber.org/protocol/muc#admin");
          metaData.addAttribute("affiliation","member");
          metaData.addAttribute("jid",jid);
          try {
            List<MUCRole> roles=room.getOccupantsByBareJID(jid);
            MUCRole role=roles.get(0);
            metaData.addAttribute("role",role.getRoleAsString());
            metaData.addAttribute("nick",role.getNickname());
          }
 catch (          UserNotFoundException e) {
          }
        }
      }
 else       if ("moderator".equals(roleAttribute)) {
        if (MUCRole.ADMINISTRATOR != senderRole.getAffiliation() && MUCRole.OWNER != senderRole.getAffiliation()) {
          throw new ForbiddenException();
        }
        for (        MUCRole role : room.getModerators()) {
          metaData=result.addElement("item","http://jabber.org/protocol/muc#admin");
          metaData.addAttribute("role","moderator");
          metaData.addAttribute("jid",role.getChatUser().getAddress().toString());
          metaData.addAttribute("nick",role.getNickname());
          metaData.addAttribute("affiliation",role.getAffiliationAsString());
        }
      }
 else       if ("participant".equals(roleAttribute)) {
        if (MUCRole.MODERATOR != senderRole.getRole()) {
          throw new ForbiddenException();
        }
        for (        MUCRole role : room.getParticipants()) {
          metaData=result.addElement("item","http://jabber.org/protocol/muc#admin");
          metaData.addAttribute("role","participant");
          metaData.addAttribute("jid",role.getChatUser().getAddress().toString());
          metaData.addAttribute("nick",role.getNickname());
          metaData.addAttribute("affiliation",role.getAffiliationAsString());
        }
      }
 else {
        reply.setError(PacketError.Condition.bad_request);
      }
    }
  }
 else {
    JID jid=null;
    String nick;
    String target=null;
    boolean hasAffiliation=((Element)itemsList.get(0)).attributeValue("affiliation") != null;
    List<Presence> presences=new ArrayList<Presence>(itemsList.size());
    for (Iterator items=itemsList.iterator(); items.hasNext(); ) {
      try {
        item=(Element)items.next();
        target=(hasAffiliation ? item.attributeValue("affiliation") : item.attributeValue("role"));
        if (hasJID) {
          jid=new JID(item.attributeValue("jid"));
        }
 else {
          nick=item.attributeValue("nick");
          jid=room.getOccupant(nick).getChatUser().getAddress();
        }
        room.lock.writeLock().lock();
        try {
          if ("moderator".equals(target)) {
            presences.add(room.addModerator(jid,senderRole));
          }
 else           if ("participant".equals(target)) {
            presences.add(room.addParticipant(jid,item.elementTextTrim("reason"),senderRole));
          }
 else           if ("visitor".equals(target)) {
            presences.add(room.addVisitor(jid,senderRole));
          }
 else           if ("member".equals(target)) {
            boolean hadAffiliation=room.getAffiliation(jid.toBareJID()) != MUCRole.NONE;
            presences.addAll(room.addMember(jid.toBareJID(),null,senderRole));
            if (!hadAffiliation && room.isMembersOnly()) {
              room.sendInvitation(jid,null,senderRole);
            }
          }
 else           if ("outcast".equals(target)) {
            presences.addAll(room.addOutcast(jid.toBareJID(),item.elementTextTrim("reason"),senderRole));
          }
 else           if ("none".equals(target)) {
            if (hasAffiliation) {
              presences.addAll(room.addNone(jid.toBareJID(),senderRole));
            }
 else {
              if (MUCRole.MODERATOR != senderRole.getRole()) {
                throw new ForbiddenException();
              }
              presences.add(room.kickOccupant(jid,senderRole.getChatUser().getAddress(),item.elementTextTrim("reason")));
            }
          }
 else {
            reply.setError(PacketError.Condition.bad_request);
          }
        }
  finally {
          room.lock.writeLock().unlock();
        }
      }
 catch (      UserNotFoundException e) {
      }
    }
    for (    Presence presence : presences) {
      room.send(presence);
    }
  }
}
