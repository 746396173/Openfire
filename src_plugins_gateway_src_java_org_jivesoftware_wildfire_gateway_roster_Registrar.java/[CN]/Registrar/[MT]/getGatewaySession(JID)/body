{
  SubscriptionInfo info=registrar.get(NormalizedJID.wrap(jid));
  if (info == null) {
    throw new IllegalStateException("Please register before attempting to get a session");
  }
  if (!sessions.containsKey(jid)) {
    info.jid=jid;
    GatewaySession session=this.gateway.getSessionFactory().newInstance(info);
    session.login();
    logger.info("Creating session for: " + jid);
    sessions.put(jid,session);
  }
  return sessions.get(jid);
}
