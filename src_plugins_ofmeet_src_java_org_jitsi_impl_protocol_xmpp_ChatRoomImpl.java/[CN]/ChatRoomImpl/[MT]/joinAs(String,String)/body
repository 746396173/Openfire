{
  try {
    muc.addPresenceInterceptor(new PacketInterceptor(){
      @Override public void interceptPacket(      Packet packet){
        if (packet instanceof Presence) {
          lastPresenceSent=(Presence)packet;
        }
      }
    }
);
    String roomPassword=null;
    if (room != null && room.isPasswordProtected()) {
      roomPassword=room.getPassword();
    }
    logger.info("joinAs " + nickname + " "+ password+ " "+ roomPassword);
    try {
      if (password == null) {
        if (roomPassword != null)         muc.join(nickname,roomPassword);
 else         muc.join(nickname);
      }
 else       muc.join(nickname,password);
    }
 catch (    Exception e) {
      muc.create(nickname);
    }
    this.myNickName=nickname;
    Form config=muc.getConfigurationForm();
    Form answer=config.createAnswerForm();
    FormField whois=new FormField("muc#roomconfig_whois");
    whois.addValue("anyone");
    answer.addField(whois);
    muc.sendConfigurationForm(answer);
  }
 catch (  XMPPException e) {
    throw new OperationFailedException("Failed to join the room",OperationFailedException.GENERAL_ERROR,e);
  }
}
