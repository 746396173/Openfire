{
  ChannelHandler route=null;
  String nodeJID=node.getNode() == null ? "" : node.getNode();
  String resourceJID=node.getResource() == null ? "" : node.getResource();
  routeLock.writeLock().lock();
  try {
    Object nameRoutes=routes.get(node.getDomain());
    if (nameRoutes instanceof Hashtable) {
      Object resourceRoutes=((Hashtable)nameRoutes).get(nodeJID);
      if (resourceRoutes instanceof Hashtable) {
        route=(ChannelHandler)((Hashtable)resourceRoutes).remove(resourceJID);
        if (((Hashtable)resourceRoutes).isEmpty()) {
          ((Hashtable)nameRoutes).remove(nodeJID);
          if (((Hashtable)nameRoutes).isEmpty()) {
            routes.remove(node.getDomain());
          }
        }
      }
 else {
        ((Hashtable)nameRoutes).remove(nodeJID);
      }
    }
 else     if (nameRoutes != null) {
      if (((RoutableChannelHandler)nameRoutes).getAddress().equals(node)) {
        routes.remove(node.getDomain());
      }
    }
  }
 catch (  Exception e) {
    Log.error("Error removing route",e);
  }
 finally {
    routeLock.writeLock().unlock();
  }
  return route;
}
