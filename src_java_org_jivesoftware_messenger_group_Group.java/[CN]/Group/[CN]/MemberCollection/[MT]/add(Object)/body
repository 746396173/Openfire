{
  String username=(String)member;
  try {
    username=Stringprep.nodeprep(username);
    UserManager.getInstance().getUser(username);
  }
 catch (  Exception e) {
    throw new IllegalArgumentException("Invalid user.",e);
  }
  boolean alreadyGroupUser=false;
  if (adminCollection) {
    alreadyGroupUser=members.contains(username);
  }
 else {
    alreadyGroupUser=administrators.contains(username);
  }
  if (users.add(username)) {
    if (alreadyGroupUser) {
      provider.updateMember(name,username,adminCollection);
    }
 else {
      provider.addMember(name,username,adminCollection);
    }
    if (adminCollection) {
      Map params=new HashMap();
      params.put("admin",username);
      if (alreadyGroupUser) {
        GroupEventDispatcher.dispatchEvent(Group.this,GroupEventDispatcher.EventType.member_removed,params);
      }
      GroupEventDispatcher.dispatchEvent(Group.this,GroupEventDispatcher.EventType.admin_added,params);
    }
 else {
      Map params=new HashMap();
      params.put("member",username);
      if (alreadyGroupUser) {
        GroupEventDispatcher.dispatchEvent(Group.this,GroupEventDispatcher.EventType.admin_removed,params);
      }
      GroupEventDispatcher.dispatchEvent(Group.this,GroupEventDispatcher.EventType.member_added,params);
    }
    if (alreadyGroupUser) {
      if (adminCollection) {
        if (members.contains(username)) {
          members.remove(username);
        }
      }
 else {
        if (administrators.contains(username)) {
          administrators.remove(username);
        }
      }
    }
    return true;
  }
  return false;
}
