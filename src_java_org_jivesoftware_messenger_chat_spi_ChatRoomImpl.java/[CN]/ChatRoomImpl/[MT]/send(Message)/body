{
  String resource=packet.getRecipient().getResource();
  if (resource == null || resource.trim().length() == 0) {
    resource=null;
  }
  if (resource == null && Message.GROUP_CHAT == packet.getType()) {
    historyStrategy.addMessage(packet);
    broadcast(packet);
  }
 else   if (resource != null && (Message.CHAT == packet.getType() || Message.NORMAL == packet.getType())) {
    ChatRole member=members.get(resource.toLowerCase());
    if (member != null) {
      packet.setRecipient(member.getChatUser().getAddress());
      router.route(packet);
    }
  }
 else {
    packet=(Message)packet.createDeepCopy();
    packet.setError(XMPPError.Code.BAD_REQUEST);
    packet.setRecipient(packet.getSender());
    packet.setSender(role.getRoleAddress());
    router.route(packet);
  }
}
