{
  boolean success=false;
  sessionLock.writeLock().lock();
  String username=session.getAddress().getNode().toLowerCase();
  SessionMap resources=null;
  try {
    resources=sessions.get(username);
    if (resources == null) {
      resources=new SessionMap();
      sessions.put(username,resources);
    }
    resources.addSession(session);
    session.getConnection().registerCloseListener(this,session);
    preAuthenticatedSessions.remove(new JID(null,session.getAddress().getDomain(),session.getStreamID().toString()).toString());
    success=true;
  }
 catch (  UnauthorizedException e) {
    Log.error(LocaleUtils.getLocalizedString("admin.error"),e);
  }
 finally {
    sessionLock.writeLock().unlock();
  }
  if (success) {
    Session defaultSession=resources.getDefaultSession();
    JID node=new JID(defaultSession.getAddress().getNode(),defaultSession.getAddress().getDomain(),null);
    routingTable.addRoute(node,defaultSession);
    routingTable.addRoute(session.getAddress(),session);
  }
  return success;
}
