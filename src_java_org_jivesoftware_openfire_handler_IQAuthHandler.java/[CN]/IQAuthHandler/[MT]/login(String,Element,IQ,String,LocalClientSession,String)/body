{
  String resource=iq.elementTextTrim("resource");
  if (resource != null) {
    try {
      resource=JID.resourceprep(resource);
    }
 catch (    StringprepException e) {
      throw new IllegalArgumentException("Invalid resource: " + resource);
    }
  }
 else {
    IQ response=IQ.createResultIQ(packet);
    response.setChildElement(packet.getChildElement().createCopy());
    response.setError(PacketError.Condition.not_acceptable);
    return response;
  }
  if (!JiveGlobals.getBooleanProperty("xmpp.auth.iqauth",true)) {
    throw new UnauthorizedException();
  }
  username=username.toLowerCase();
  AuthToken token=null;
  if (password != null && AuthFactory.isPlainSupported()) {
    token=AuthFactory.authenticate(username,password);
  }
 else   if (digest != null && AuthFactory.isDigestSupported()) {
    token=AuthFactory.authenticate(username,session.getStreamID().toString(),digest);
  }
  if (token == null) {
    throw new UnauthorizedException();
  }
  ClientSession oldSession=routingTable.getClientRoute(new JID(username,serverName,resource));
  if (oldSession != null) {
    try {
      oldSession.incrementConflictCount();
      int conflictLimit=sessionManager.getConflictKickLimit();
      if (conflictLimit != SessionManager.NEVER_KICK && oldSession.getConflictCount() > conflictLimit) {
        StreamError error=new StreamError(StreamError.Condition.conflict);
        oldSession.deliverRawText(error.toXML());
        oldSession.close();
      }
 else {
        IQ response=IQ.createResultIQ(packet);
        response.setChildElement(packet.getChildElement().createCopy());
        response.setError(PacketError.Condition.forbidden);
        return response;
      }
    }
 catch (    Exception e) {
      Log.error("Error during login",e);
    }
  }
  session.setAuthToken(token,resource);
  packet.setFrom(session.getAddress());
  return IQ.createResultIQ(packet);
}
