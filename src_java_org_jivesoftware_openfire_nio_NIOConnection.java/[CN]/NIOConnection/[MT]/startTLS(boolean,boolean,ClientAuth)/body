{
  final SslFilter filter;
  if (clientMode) {
    filter=SSLConfig.getClientModeSslFilter(Purpose.SOCKET_S2S);
  }
 else {
    final Purpose purpose=isPeerClient ? Purpose.SOCKET_C2S : Purpose.SOCKET_S2S;
    filter=SSLConfig.getServerModeSslFilter(purpose,authentication);
  }
  ioSession.getFilterChain().addBefore(EXECUTOR_FILTER_NAME,TLS_FILTER_NAME,filter);
  ioSession.setAttribute(SslFilter.DISABLE_ENCRYPTION_ONCE,Boolean.TRUE);
  if (!clientMode) {
    deliverRawText("<proceed xmlns=\"urn:ietf:params:xml:ns:xmpp-tls\"/>");
  }
}
