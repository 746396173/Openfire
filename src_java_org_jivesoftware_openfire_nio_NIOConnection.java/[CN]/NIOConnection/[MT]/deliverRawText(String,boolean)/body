{
  if (!isClosed()) {
    boolean errorDelivering=false;
    IoBuffer buffer=IoBuffer.allocate(text.length());
    buffer.setAutoExpand(true);
    try {
      buffer.put(text.getBytes(CHARSET));
      if (flashClient) {
        buffer.put((byte)'\0');
      }
      buffer.flip();
      ioSessionLock.lock();
      try {
        if (asynchronous) {
          if (!ioSession.isConnected()) {
            throw new IOException("Connection reset/closed by peer");
          }
          ioSession.write(buffer);
        }
 else {
          boolean ok=ioSession.write(buffer).awaitUninterruptibly(JiveGlobals.getIntProperty("connection.ack.timeout",2000));
          if (!ok) {
            Log.warn("No ACK was received when sending stanza to: " + this.toString());
          }
        }
      }
  finally {
        ioSessionLock.unlock();
      }
    }
 catch (    Exception e) {
      Log.debug("Error delivering raw text:\n" + text,e);
      errorDelivering=true;
    }
    if (errorDelivering && asynchronous) {
      close();
    }
  }
}
