{
  Connection con=null;
  PreparedStatement pstmt=null;
  try {
    con=DbConnectionManager.getConnection();
    pstmt=con.prepareStatement(LOAD_ROOM);
    pstmt.setString(1,room.getName());
    ResultSet rs=pstmt.executeQuery();
    if (!rs.next()) {
      throw new IllegalArgumentException("Room " + room.getName() + " was not found in the database.");
    }
    room.setID(rs.getLong(1));
    room.setDescription(rs.getString(2));
    room.setCanOccupantsChangeSubject(rs.getInt(3) == 1 ? true : false);
    room.setMaxUsers(rs.getInt(4));
    room.setPublicRoom(rs.getInt(5) == 1 ? true : false);
    room.setModerated(rs.getInt(6) == 1 ? true : false);
    room.setInvitationRequiredToEnter(rs.getInt(7) == 1 ? true : false);
    room.setCanOccupantsInvite(rs.getInt(8) == 1 ? true : false);
    room.setPasswordProtected(rs.getInt(9) == 1 ? true : false);
    room.setPassword(rs.getString(10));
    room.setCanAnyoneDiscoverJID(rs.getInt(11) == 1 ? true : false);
    room.setLogEnabled(rs.getInt(12) == 1 ? true : false);
    room.setSubject(rs.getString(13));
    List rolesToBroadcast=new ArrayList();
    String roles=Integer.toBinaryString(rs.getInt(14));
    if (roles.charAt(0) == '1') {
      rolesToBroadcast.add("moderator");
    }
    if (roles.length() > 1 && roles.charAt(1) == '1') {
      rolesToBroadcast.add("participant");
    }
    if (roles.length() > 2 && roles.charAt(2) == '1') {
      rolesToBroadcast.add("visitor");
    }
    room.setRolesToBroadcastPresence(rolesToBroadcast);
    room.setPersistent(true);
    rs.close();
    pstmt.close();
    pstmt=con.prepareStatement(LOAD_AFFILIATIONS);
    pstmt.setLong(1,room.getID());
    rs=pstmt.executeQuery();
    while (rs.next()) {
      String jid=rs.getString(1);
      int affiliation=rs.getInt(2);
      try {
switch (affiliation) {
case MUCRole.OWNER:
          room.addOwner(jid,room.getRole());
        break;
case MUCRole.ADMINISTRATOR:
      room.addAdmin(jid,room.getRole());
    break;
case MUCRole.OUTCAST:
  room.addOutcast(jid,null,room.getRole());
break;
default :
Log.error("Unkown affiliation value " + affiliation + " for user "+ jid+ " in persistent room "+ room.getID());
}
}
 catch (Exception e) {
Log.error(e);
}
}
rs.close();
pstmt.close();
pstmt=con.prepareStatement(LOAD_MEMBERS);
pstmt.setLong(1,room.getID());
rs=pstmt.executeQuery();
while (rs.next()) {
try {
room.addMember(rs.getString(1),rs.getString(2),room.getRole());
}
 catch (Exception e) {
Log.error(e);
}
}
rs.close();
}
 catch (SQLException sqle) {
Log.error(sqle);
}
 finally {
try {
if (pstmt != null) pstmt.close();
}
 catch (Exception e) {
Log.error(e);
}
try {
if (con != null) con.close();
}
 catch (Exception e) {
Log.error(e);
}
}
}
