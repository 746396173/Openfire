{
  if (!room.isPersistent() || !room.wasSavedToDB()) {
    return;
  }
  if (MUCRole.NONE == oldAffiliation) {
    if (MUCRole.MEMBER == newAffiliation) {
      Connection con=null;
      PreparedStatement pstmt=null;
      try {
        con=DbConnectionManager.getConnection();
        pstmt=con.prepareStatement(ADD_MEMBER);
        pstmt.setLong(1,room.getID());
        pstmt.setString(2,bareJID);
        pstmt.setString(3,nickname);
        pstmt.executeUpdate();
      }
 catch (      SQLException sqle) {
        Log.error(sqle);
      }
 finally {
        try {
          if (pstmt != null)           pstmt.close();
        }
 catch (        Exception e) {
          Log.error(e);
        }
        try {
          if (con != null)           con.close();
        }
 catch (        Exception e) {
          Log.error(e);
        }
      }
    }
 else {
      Connection con=null;
      PreparedStatement pstmt=null;
      try {
        con=DbConnectionManager.getConnection();
        pstmt=con.prepareStatement(ADD_AFFILIATION);
        pstmt.setLong(1,room.getID());
        pstmt.setString(2,bareJID);
        pstmt.setInt(3,newAffiliation);
        pstmt.executeUpdate();
      }
 catch (      SQLException sqle) {
        Log.error(sqle);
      }
 finally {
        try {
          if (pstmt != null)           pstmt.close();
        }
 catch (        Exception e) {
          Log.error(e);
        }
        try {
          if (con != null)           con.close();
        }
 catch (        Exception e) {
          Log.error(e);
        }
      }
    }
  }
 else {
    if (MUCRole.MEMBER == newAffiliation && MUCRole.MEMBER == oldAffiliation) {
      Connection con=null;
      PreparedStatement pstmt=null;
      try {
        con=DbConnectionManager.getConnection();
        pstmt=con.prepareStatement(UPDATE_MEMBER);
        pstmt.setString(1,nickname);
        pstmt.setLong(2,room.getID());
        pstmt.setString(3,bareJID);
        pstmt.executeUpdate();
      }
 catch (      SQLException sqle) {
        Log.error(sqle);
      }
 finally {
        try {
          if (pstmt != null)           pstmt.close();
        }
 catch (        Exception e) {
          Log.error(e);
        }
        try {
          if (con != null)           con.close();
        }
 catch (        Exception e) {
          Log.error(e);
        }
      }
    }
 else     if (MUCRole.MEMBER == newAffiliation) {
      Connection con=null;
      PreparedStatement pstmt=null;
      boolean abortTransaction=false;
      try {
        con=DbConnectionManager.getTransactionConnection();
        pstmt=con.prepareStatement(DELETE_AFFILIATION);
        pstmt.setLong(1,room.getID());
        pstmt.setString(2,bareJID);
        pstmt.executeUpdate();
        pstmt.close();
        pstmt=con.prepareStatement(ADD_MEMBER);
        pstmt.setLong(1,room.getID());
        pstmt.setString(2,bareJID);
        pstmt.setString(3,nickname);
        pstmt.executeUpdate();
      }
 catch (      SQLException sqle) {
        Log.error(sqle);
        abortTransaction=true;
      }
 finally {
        try {
          if (pstmt != null)           pstmt.close();
        }
 catch (        Exception e) {
          Log.error(e);
        }
        DbConnectionManager.closeTransactionConnection(con,abortTransaction);
      }
    }
 else     if (MUCRole.MEMBER == oldAffiliation) {
      Connection con=null;
      PreparedStatement pstmt=null;
      boolean abortTransaction=false;
      try {
        con=DbConnectionManager.getTransactionConnection();
        pstmt=con.prepareStatement(DELETE_MEMBER);
        pstmt.setLong(1,room.getID());
        pstmt.setString(2,bareJID);
        pstmt.executeUpdate();
        pstmt.close();
        pstmt=con.prepareStatement(ADD_AFFILIATION);
        pstmt.setLong(1,room.getID());
        pstmt.setString(2,bareJID);
        pstmt.setInt(3,newAffiliation);
        pstmt.executeUpdate();
      }
 catch (      SQLException sqle) {
        Log.error(sqle);
        abortTransaction=true;
      }
 finally {
        try {
          if (pstmt != null)           pstmt.close();
        }
 catch (        Exception e) {
          Log.error(e);
        }
        DbConnectionManager.closeTransactionConnection(con,abortTransaction);
      }
    }
 else {
      Connection con=null;
      PreparedStatement pstmt=null;
      try {
        con=DbConnectionManager.getConnection();
        pstmt=con.prepareStatement(UPDATE_AFFILIATION);
        pstmt.setInt(1,newAffiliation);
        pstmt.setLong(2,room.getID());
        pstmt.setString(3,bareJID);
        pstmt.executeUpdate();
      }
 catch (      SQLException sqle) {
        Log.error(sqle);
      }
 finally {
        try {
          if (pstmt != null)           pstmt.close();
        }
 catch (        Exception e) {
          Log.error(e);
        }
        try {
          if (con != null)           con.close();
        }
 catch (        Exception e) {
          Log.error(e);
        }
      }
    }
  }
}
