{
  super("Personal Eventing Handler");
  pepServices=new ConcurrentHashMap<String,PEPService>();
  info=new IQHandlerInfo("pubsub","http://jabber.org/protocol/pubsub");
  Thread thread=new Thread("PEP avaiable sessions handler "){
    public void run(){
      final XMPPServer server=XMPPServer.getInstance();
      while (!server.isShuttingDown()) {
        try {
          JID availableSessionJID=availableSessions.take();
          try {
            Roster roster=server.getRosterManager().getRoster(availableSessionJID.getNode());
            for (            RosterItem item : roster.getRosterItems()) {
              if (server.isLocal(item.getJid()) && (item.getSubStatus() == RosterItem.SUB_BOTH || item.getSubStatus() == RosterItem.SUB_TO)) {
                PEPService pepService=getPEPService(item.getJid().toBareJID());
                if (pepService != null) {
                  pepService.sendLastPublishedItems(availableSessionJID);
                }
              }
            }
          }
 catch (          UserNotFoundException e) {
          }
        }
 catch (        Exception e) {
          Log.error(e.getMessage(),e);
        }
      }
    }
  }
;
  thread.setDaemon(true);
  thread.start();
}
