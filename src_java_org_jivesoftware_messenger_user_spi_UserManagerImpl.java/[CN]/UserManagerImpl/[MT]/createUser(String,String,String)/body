{
  User newUser=null;
  username=NodePrep.prep(username);
  username=StringUtils.replace(username,"&nbsp;","");
  try {
    getUser(username);
    throw new UserAlreadyExistsException();
  }
 catch (  UserNotFoundException unfe) {
    try {
      if (email == null || email.length() == 0) {
        email=" ";
      }
      Connection con=null;
      PreparedStatement pstmt=null;
      try {
        con=DbConnectionManager.getConnection();
        pstmt=con.prepareStatement(INSERT_USER);
        pstmt.setString(1,username);
        pstmt.setString(2,password);
        pstmt.setString(3,"");
        pstmt.setString(4,email);
        Date now=new Date();
        pstmt.setString(5,StringUtils.dateToMillis(now));
        pstmt.setString(6,StringUtils.dateToMillis(now));
        pstmt.execute();
      }
 catch (      Exception e) {
        Log.error(LocaleUtils.getLocalizedString("admin.error"),e);
      }
 finally {
        try {
          if (pstmt != null) {
            pstmt.close();
          }
        }
 catch (        Exception e) {
          Log.error(e);
        }
        try {
          if (con != null) {
            con.close();
          }
        }
 catch (        Exception e) {
          Log.error(e);
        }
      }
      newUser=getUser(username);
    }
 catch (    UserNotFoundException e) {
      throw new UnauthorizedException("Created an account but could not load it. username: " + username + " pass: "+ password+ " email: "+ email,e);
    }
  }
  return newUser;
}
