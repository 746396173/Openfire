{
  if (update.getFrom() == null) {
    return;
  }
  if (localServer.isLocal(update.getFrom())) {
    boolean keepTrack=false;
    WeakHashMap<ChannelHandler,Set<String>> map;
    String name=update.getFrom().getNode();
    if (name != null && !"".equals(name)) {
      name=name.toLowerCase();
      try {
        Roster roster=rosterManager.getRoster(name);
        RosterItem rosterItem=null;
        try {
          rosterItem=roster.getRosterItem(update.getTo());
        }
 catch (        UserNotFoundException e) {
        }
        if (rosterItem == null || RosterItem.SUB_NONE == rosterItem.getSubStatus() || RosterItem.SUB_TO == rosterItem.getSubStatus()) {
          keepTrack=true;
        }
      }
 catch (      UserNotFoundException e) {
        Log.warn("Presence being sent from unknown user " + name,e);
      }
catch (      PacketException e) {
        Log.error(LocaleUtils.getLocalizedString("admin.error"),e);
      }
    }
 else     if (update.getFrom().getResource() != null) {
      keepTrack=true;
    }
    if (keepTrack) {
      map=directedPresences.get(update.getFrom().toString());
      if (map == null) {
        map=new WeakHashMap<ChannelHandler,Set<String>>();
        map.put(handler,new ConcurrentHashSet<String>());
        directedPresences.put(update.getFrom().toString(),map);
      }
      if (Presence.Type.unavailable.equals(update.getType())) {
        if (handler instanceof ClientSession) {
          map.remove(handler);
          if (map.isEmpty()) {
            directedPresences.remove(update.getFrom().toString());
          }
        }
 else {
          Set<String> jids=map.get(handler);
          if (jids != null) {
            jids.remove(jid);
          }
        }
      }
 else {
        if (map.get(handler) == null) {
          map.put(handler,new ConcurrentHashSet<String>());
        }
        map.get(handler).add(jid);
      }
    }
  }
}
