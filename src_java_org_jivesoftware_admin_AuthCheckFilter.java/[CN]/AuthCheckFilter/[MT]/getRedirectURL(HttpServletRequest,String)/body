{
  StringBuffer buf=new StringBuffer();
  try {
    StringBuffer rURL=request.getRequestURL();
    int pos=rURL.lastIndexOf("/");
    if ((pos + 1) <= rURL.length()) {
      buf.append(rURL.substring(pos + 1,rURL.length()));
    }
    String qs=request.getQueryString();
    if (qs != null) {
      buf.append("?").append(qs);
    }
  }
 catch (  Exception e) {
    Log.error(e);
  }
  try {
    String url=loginPage + "?url=" + URLEncoder.encode(buf.toString(),"ISO-8859-1")+ (optionalParams != null ? "&" + optionalParams : "");
    return url;
  }
 catch (  Exception e) {
    Log.error(e);
    return null;
  }
}
