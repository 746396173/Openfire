{
  Log.debug("Processing packet in ClientToComponentUpdateProcessor for " + _mySubdomain);
  IQ myPacket=(IQ)packet;
  IQ response=IQ.createResultIQ(myPacket);
  String to=myPacket.getTo().toString();
  String username=getUsernameFromJid(to);
  List<Node> nodes=findNodesInDocument(myPacket.getElement().getDocument(),"//roster:item");
  for (  Node n : nodes) {
    Roster roster;
    String jid=n.valueOf("@jid");
    String name=n.valueOf("@name");
    String subvalue=n.valueOf("@subscription");
    if (subvalue.equals("both")) {
      try {
        if (jid.equals(myPacket.getFrom().toString())) {
          break;
        }
        roster=_rosterManager.getRoster(username);
        List<String> grouplist=new ArrayList<String>();
        List<Node> groupnodes=findNodesInDocument(n.getDocument(),"//roster:group");
        for (        Node ne : groupnodes) {
          String groupName=ne.getText();
          grouplist.add(groupName);
        }
        boolean rosterPersisten=JiveGlobals.getBooleanProperty("plugin.remoteroster.persistent",true);
        Log.debug("Adding/Updating User " + jid + " to roster "+ to);
        try {
          RosterItem item=roster.getRosterItem(new JID(jid));
          item.setGroups(grouplist);
          roster.updateRosterItem(item);
          break;
        }
 catch (        UserNotFoundException exc) {
        }
        RosterItem item=roster.createRosterItem(new JID(jid),name,grouplist,false,rosterPersisten);
        item.setSubStatus(RosterItem.SUB_BOTH);
        roster.updateRosterItem(item);
      }
 catch (      Exception e) {
        Log.debug("Could not add user to Roster although no entry should exist..." + username,e);
        e.printStackTrace();
      }
    }
 else     if (subvalue.equals("remove")) {
      try {
        roster=_rosterManager.getRoster(username);
        Log.debug("Removing contact " + username + " from contact list.");
        roster.deleteRosterItem(new JID(jid),false);
      }
 catch (      UserNotFoundException e) {
        Log.debug("Could not find user while cleaning up the roster in GoJara for user " + username,e);
        response.setType(IQ.Type.error);
      }
catch (      SharedGroupException e) {
      }
    }
    dispatchPacket(response);
  }
}
