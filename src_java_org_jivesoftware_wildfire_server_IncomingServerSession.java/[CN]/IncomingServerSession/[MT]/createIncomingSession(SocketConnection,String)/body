{
  StreamID streamID=SessionManager.getInstance().nextStreamID();
  IncomingServerSession session=SessionManager.getInstance().createIncomingServerSession(connection,streamID);
  StringBuilder openingStream=new StringBuilder();
  openingStream.append("<stream:stream");
  openingStream.append(" xmlns:stream=\"http://etherx.jabber.org/streams\"");
  openingStream.append(" xmlns=\"jabber:server\"");
  openingStream.append(" from=\"").append(serverName).append("\"");
  openingStream.append(" id=\"").append(streamID).append("\"");
  openingStream.append(" version=\"1.0\">");
  connection.deliverRawText(openingStream.toString());
  connection.setTlsPolicy(ServerDialback.isEnabled() ? Connection.TLSPolicy.optional : Connection.TLSPolicy.required);
  String policyName=JiveGlobals.getProperty("xmpp.server.compression.policy",Connection.CompressionPolicy.disabled.toString());
  Connection.CompressionPolicy compressionPolicy=Connection.CompressionPolicy.valueOf(policyName);
  connection.setCompressionPolicy(compressionPolicy);
  StringBuilder sb=new StringBuilder();
  sb.append("<stream:features>");
  sb.append("<starttls xmlns=\"urn:ietf:params:xml:ns:xmpp-tls\">");
  if (!ServerDialback.isEnabled()) {
    sb.append("<required/>");
  }
  sb.append("</starttls>");
  sb.append(SASLAuthentication.getSASLMechanisms(session));
  sb.append("</stream:features>");
  connection.deliverRawText(sb.toString());
  session.setLocalDomain(serverName);
  return session;
}
