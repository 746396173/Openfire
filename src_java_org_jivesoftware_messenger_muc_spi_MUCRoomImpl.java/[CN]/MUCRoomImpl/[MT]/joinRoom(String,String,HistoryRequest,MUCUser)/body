{
  MUCRoleImpl joinRole=null;
  lock.writeLock().lock();
  try {
    if (isDestroyed || (getMaxUsers() > 0 && getOccupantsCount() >= getMaxUsers())) {
      throw new NotAllowedException();
    }
    boolean isOwner=owners.contains(user.getAddress().toBareJID());
    if (roomLocked) {
      if (!isOwner) {
        throw new RoomLockedException();
      }
    }
    if (occupants.containsKey(nickname.toLowerCase())) {
      throw new UserAlreadyExistsException();
    }
    if (isPasswordProtected()) {
      if (password == null || !password.equals(getPassword())) {
        throw new UnauthorizedException();
      }
    }
    if (members.containsValue(nickname)) {
      if (!nickname.equals(members.get(user.getAddress().toBareJID()))) {
        throw new ConflictException();
      }
    }
    int role;
    int affiliation;
    if (isOwner) {
      role=MUCRole.MODERATOR;
      affiliation=MUCRole.OWNER;
    }
 else     if (server.getSysadmins().contains(user.getAddress().toBareJID())) {
      role=MUCRole.MODERATOR;
      affiliation=MUCRole.OWNER;
    }
 else     if (admins.contains(user.getAddress().toBareJID())) {
      role=MUCRole.MODERATOR;
      affiliation=MUCRole.ADMINISTRATOR;
    }
 else     if (members.containsKey(user.getAddress().toBareJID())) {
      role=MUCRole.PARTICIPANT;
      affiliation=MUCRole.MEMBER;
    }
 else     if (outcasts.contains(user.getAddress().toBareJID())) {
      throw new ForbiddenException();
    }
 else {
      if (isMembersOnly()) {
        throw new RegistrationRequiredException();
      }
      role=(isModerated() ? MUCRole.VISITOR : MUCRole.PARTICIPANT);
      affiliation=MUCRole.NONE;
    }
    joinRole=new MUCRoleImpl(server,this,nickname,role,affiliation,(MUCUserImpl)user,router);
    for (    MUCRole occupantsRole : occupants.values()) {
      Presence occupantsPresence=(Presence)occupantsRole.getPresence().createCopy();
      if (hasToCheckRoleToBroadcastPresence()) {
        Element frag=occupantsPresence.getChildElement("x","http://jabber.org/protocol/muc#user");
        if (!canBroadcastPresence(frag.element("item").attributeValue("role"))) {
          continue;
        }
      }
      occupantsPresence.setFrom(occupantsRole.getRoleAddress());
      if (!canAnyoneDiscoverJID() && MUCRole.MODERATOR != joinRole.getRole()) {
        Element frag=occupantsPresence.getChildElement("x","http://jabber.org/protocol/muc#user");
        frag.element("item").addAttribute("jid",null);
      }
      joinRole.send(occupantsPresence);
    }
    occupants.put(nickname.toLowerCase(),joinRole);
    List<MUCRole> list=occupantsByBareJID.get(user.getAddress().toBareJID());
    if (list == null) {
      list=new ArrayList<MUCRole>();
      occupantsByBareJID.put(user.getAddress().toBareJID(),list);
    }
    list.add(joinRole);
    occupantsByFullJID.put(user.getAddress(),joinRole);
  }
  finally {
    lock.writeLock().unlock();
  }
  if (joinRole != null) {
    boolean isRoomNew=roomLocked && occupants.size() == 1;
    List params=new ArrayList();
    params.add(nickname);
    try {
      Presence joinPresence=joinRole.getPresence().createCopy();
      if (isRoomNew) {
        Element frag=joinPresence.getChildElement("x","http://jabber.org/protocol/muc#user");
        frag.addElement("status").addAttribute("code","201");
      }
      joinPresence.setFrom(joinRole.getRoleAddress());
      broadcastPresence(joinPresence);
    }
 catch (    Exception e) {
      Log.error(LocaleUtils.getLocalizedString("admin.error"),e);
    }
    if (canBroadcastPresence(joinRole.getRoleAsString())) {
      serverBroadcast(LocaleUtils.getLocalizedString("muc.join",params));
    }
    if (isRoomNew) {
      Message message=new Message();
      message.setType(Message.Type.groupchat);
      message.setBody(LocaleUtils.getLocalizedString("muc.locked"));
      message.setFrom(role.getRoleAddress());
      message.setTo(user.getAddress());
      router.route(message);
    }
 else     if (canAnyoneDiscoverJID()) {
      Message message=new Message();
      message.setType(Message.Type.groupchat);
      message.setBody(LocaleUtils.getLocalizedString("muc.warnnonanonymous"));
      message.setFrom(role.getRoleAddress());
      message.setTo(user.getAddress());
      Element frag=message.addChildElement("x","http://jabber.org/protocol/muc#user");
      frag.addElement("status").addAttribute("code","100");
      router.route(message);
    }
    if (historyRequest == null) {
      Iterator history=roomHistory.getMessageHistory();
      while (history.hasNext()) {
        joinRole.send((Message)history.next());
      }
    }
 else {
      historyRequest.sendHistory(joinRole,roomHistory);
    }
  }
  return joinRole;
}
