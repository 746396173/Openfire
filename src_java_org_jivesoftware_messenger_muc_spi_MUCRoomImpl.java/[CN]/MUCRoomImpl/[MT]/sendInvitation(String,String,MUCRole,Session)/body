{
  if (!isInvitationRequiredToEnter() || canOccupantsInvite() || MUCRole.ADMINISTRATOR == senderRole.getAffiliation() || MUCRole.OWNER == senderRole.getAffiliation()) {
    Message message=new MessageImpl();
    message.setOriginatingSession(session);
    message.setSender(role.getRoleAddress());
    message.setRecipient(XMPPAddress.parseJID(to));
    MetaDataFragment frag=new MetaDataFragment("http://jabber.org/protocol/muc#user","x");
    frag.setProperty("x.invite:from",senderRole.getChatUser().getAddress().toBareStringPrep());
    if (reason != null && reason.length() > 0) {
      frag.setProperty("x.invite.reason",reason);
    }
    if (isPasswordProtected()) {
      frag.setProperty("x.password",getPassword());
    }
    message.addFragment(frag);
    frag=new MetaDataFragment("jabber:x:conference","x");
    frag.setProperty("x:jid",role.getRoleAddress().toBareStringPrep());
    message.addFragment(frag);
    router.route(message);
  }
 else {
    throw new ForbiddenException();
  }
}
