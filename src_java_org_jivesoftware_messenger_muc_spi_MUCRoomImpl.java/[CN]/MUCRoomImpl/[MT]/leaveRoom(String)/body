{
  MUCRole leaveRole=null;
  lock.writeLock().lock();
  try {
    leaveRole=occupants.remove(nickname.toLowerCase());
    if (leaveRole == null) {
      throw new UserNotFoundException();
    }
    removeOccupantRole(leaveRole);
    if (occupants.isEmpty() && !isPersistent()) {
      endTime=System.currentTimeMillis();
      server.removeChatRoom(name);
    }
  }
  finally {
    lock.writeLock().unlock();
  }
  if (leaveRole != null) {
    try {
      Presence presence=(Presence)leaveRole.getPresence().createCopy();
      presence.setType(Presence.Type.unavailable);
      presence.setFrom(leaveRole.getRoleAddress());
      broadcastPresence(presence);
      leaveRole.kick();
      List params=new ArrayList();
      params.add(nickname);
      if (canBroadcastPresence(leaveRole.getRoleAsString())) {
        serverBroadcast(LocaleUtils.getLocalizedString("muc.leave",params));
      }
    }
 catch (    Exception e) {
      Log.error(e);
    }
  }
}
