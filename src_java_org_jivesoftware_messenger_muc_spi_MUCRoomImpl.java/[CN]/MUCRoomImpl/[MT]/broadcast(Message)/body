{
  lock.readLock().lock();
  try {
    for (    MUCRole occupant : occupants.values()) {
      message.setRecipient(occupant.getChatUser().getAddress());
      router.route(message);
    }
    if (isLogEnabled()) {
      MUCRole senderRole;
      XMPPAddress senderAddress;
      senderRole=occupants.get(message.getSender().getResourcePrep());
      if (senderRole == null) {
        senderAddress=getRole().getRoleAddress();
      }
 else {
        senderAddress=senderRole.getChatUser().getAddress();
      }
      server.logConversation(this,message,senderAddress);
    }
  }
  finally {
    lock.readLock().unlock();
  }
}
