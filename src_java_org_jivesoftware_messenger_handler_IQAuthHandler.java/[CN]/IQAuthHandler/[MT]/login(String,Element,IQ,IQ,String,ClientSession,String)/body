{
  String resource=iq.elementTextTrim("resource");
  if (resource != null) {
    try {
      resource=Stringprep.resourceprep(resource);
    }
 catch (    StringprepException e) {
      throw new IllegalArgumentException("Invalid resource: " + resource);
    }
  }
  if (sessionManager.isActiveRoute(username,resource)) {
    ClientSession oldSession=null;
    try {
      String domain=localServer.getServerInfo().getName();
      oldSession=sessionManager.getSession(username,domain,resource);
      oldSession.incrementConflictCount();
      int conflictLimit=sessionManager.getConflictKickLimit();
      if (conflictLimit != SessionManager.NEVER_KICK && oldSession.getConflictCount() > conflictLimit) {
        Connection conn=oldSession.getConnection();
        if (conn != null) {
          conn.close();
        }
      }
 else {
        response=IQ.createResultIQ(packet);
        response.setChildElement(packet.getChildElement().createCopy());
        response.setError(PacketError.Condition.forbidden);
      }
    }
 catch (    Exception e) {
      Log.error("Error during login",e);
    }
  }
  if (response == null) {
    AuthToken token=null;
    if (password != null && AuthFactory.isPlainSupported()) {
      token=AuthFactory.authenticate(username,password);
    }
 else     if (digest != null && AuthFactory.isDigestSupported()) {
      token=AuthFactory.authenticate(username,session.getStreamID().toString(),digest);
    }
    if (token == null) {
      throw new UnauthorizedException();
    }
 else {
      session.setAuthToken(token,userManager,resource);
      packet.setFrom(session.getAddress());
      response=IQ.createResultIQ(packet);
    }
  }
  return response;
}
