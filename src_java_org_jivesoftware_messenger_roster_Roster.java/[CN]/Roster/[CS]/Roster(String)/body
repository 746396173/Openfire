{
  presenceManager=XMPPServer.getInstance().getPresenceManager();
  sessionManager=SessionManager.getInstance();
  this.username=username;
  Collection<Group> sharedGroups=null;
  try {
    User rosterUser=UserManager.getInstance().getUser(getUsername());
    sharedGroups=XMPPServer.getInstance().getRosterManager().getSharedGroups(rosterUser);
  }
 catch (  UserNotFoundException e) {
    sharedGroups=new ArrayList<Group>();
  }
  rosterItemProvider=RosterItemProvider.getInstance();
  Iterator items=rosterItemProvider.getItems(username);
  while (items.hasNext()) {
    RosterItem item=(RosterItem)items.next();
    for (    Group group : sharedGroups) {
      if (group.isUser(item.getJid().getNode())) {
        item.addSharedGroup(group.getProperties().get("sharedRoster.displayName"));
      }
    }
    rosterItems.put(item.getJid().toBareJID(),item);
  }
  Map<JID,List<Group>> sharedUsers=getSharedUsers(sharedGroups);
  for (  JID jid : sharedUsers.keySet()) {
    try {
      RosterItem.SubType type=RosterItem.SUB_TO;
      User user=UserManager.getInstance().getUser(jid.getNode());
      String nickname="".equals(user.getName()) ? jid.getNode() : user.getName();
      RosterItem item=new RosterItem(jid,RosterItem.SUB_BOTH,RosterItem.ASK_NONE,RosterItem.RECV_NONE,nickname,null);
      if (sharedUsers.get(jid).isEmpty()) {
        type=RosterItem.SUB_FROM;
      }
 else {
        for (        Group group : sharedUsers.get(jid)) {
          item.addSharedGroup(group.getProperties().get("sharedRoster.displayName"));
          if (group.isUser(username)) {
            type=RosterItem.SUB_BOTH;
          }
        }
      }
      item.setSubStatus(type);
      rosterItems.put(item.getJid().toBareJID(),item);
    }
 catch (    UserNotFoundException e) {
      Log.error("Groups (" + sharedUsers.get(jid) + ") include non-existent username ("+ jid.getNode()+ ")");
    }
  }
}
