{
  if (rosterItems.putIfAbsent(item.getJid().toBareJID(),item) == null) {
    rosterItems.remove(item.getJid().toBareJID());
    throw new UserNotFoundException(item.getJid().toBareJID());
  }
  rosterItemProvider.updateItem(username,item);
  if (!(item.getSubStatus() == RosterItem.SUB_NONE && item.getAskStatus() == RosterItem.ASK_NONE)) {
    org.xmpp.packet.Roster roster=new org.xmpp.packet.Roster();
    roster.setType(IQ.Type.set);
    roster.addItem(item.getJid(),item.getNickname(),getAskStatus(item.getAskStatus()),org.xmpp.packet.Roster.Subscription.valueOf(item.getSubStatus().getName()),item.getGroups());
    broadcast(roster);
  }
  if (item.getSubStatus() == RosterItem.SUB_BOTH || item.getSubStatus() == RosterItem.SUB_TO) {
    if (presenceManager == null) {
      presenceManager=XMPPServer.getInstance().getPresenceManager();
    }
    presenceManager.probePresence(username,item.getJid());
  }
}
