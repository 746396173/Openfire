{
  Component existingComponent=components.get(subdomain);
  if (existingComponent != null && existingComponent != component) {
    throw new ComponentException("Domain already taken by another component: " + existingComponent);
  }
  components.put(subdomain,component);
  JID componentJID=new JID(subdomain + "." + serverDomain);
  XMPPServer.getInstance().getRoutingTable().addRoute(componentJID,new RoutableComponent(componentJID,component));
  try {
    component.initialize(componentJID,this);
    component.start();
    for (    ComponentEventListener listener : listeners) {
      listener.componentRegistered(component,componentJID);
    }
    checkPresences();
    checkDiscoSupport(component,componentJID);
  }
 catch (  Exception e) {
    components.remove(subdomain);
    XMPPServer.getInstance().getRoutingTable().removeRoute(componentJID);
    if (e instanceof ComponentException) {
      throw (ComponentException)e;
    }
    throw new ComponentException(e);
  }
}
