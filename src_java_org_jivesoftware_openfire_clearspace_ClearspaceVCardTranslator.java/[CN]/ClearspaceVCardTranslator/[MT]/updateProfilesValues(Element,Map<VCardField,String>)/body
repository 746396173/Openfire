{
  Action action=Action.NO_ACTION;
  List<Element> profilesList=profiles.elements("profiles");
  for (  Element profile : profilesList) {
    int fieldID=Integer.valueOf(profile.elementText("fieldID"));
    ClearspaceField field=ClearspaceField.valueOf(fieldID);
    if (field == null) {
      continue;
    }
    Element value=profile.element("value");
    if (value == null) {
      value=profile.element("values");
    }
    String newValue;
    String oldValue;
switch (field) {
case TITLE:
      if (modifyProfileValue(vCardValues,profiles,value,VCardField.TITLE)) {
        action=Action.MODIFY;
      }
    break;
case DEPARTMENT:
  if (modifyProfileValue(vCardValues,profiles,value,VCardField.ORG_ORGUNIT)) {
    action=Action.MODIFY;
  }
break;
case ADDRESS:
if (modifyProfileValue(vCardValues,profiles,value,VCardField.ADR_WORK)) {
action=Action.MODIFY;
}
break;
case HOME_ADDRESS:
if (modifyProfileValue(vCardValues,profiles,value,VCardField.ADR_HOME)) {
action=Action.MODIFY;
}
break;
case TIME_ZONE:
if (modifyProfileValue(vCardValues,profiles,value,VCardField.TZ)) {
action=Action.MODIFY;
}
break;
case URL:
if (modifyProfileValue(vCardValues,profiles,value,VCardField.URL)) {
action=Action.MODIFY;
}
break;
case ALT_EMAIL:
newValue=vCardValues.get(VCardField.EMAIL_USERID);
oldValue=value.getTextTrim();
String mailType=getFieldType(oldValue);
newValue=addFieldType(newValue,mailType);
if (!oldValue.equalsIgnoreCase(newValue)) {
value.setText(newValue == null ? "" : newValue);
action=Action.MODIFY;
}
vCardValues.remove(VCardField.EMAIL_USERID);
break;
case PHONE:
String newHomePhone=vCardValues.get(VCardField.PHONE_HOME);
String newWorkPhone=vCardValues.get(VCardField.PHONE_WORK);
String newWorkFax=vCardValues.get(VCardField.FAX_WORK);
String newWorkMobile=vCardValues.get(VCardField.MOBILE_WORK);
String newWorkPager=vCardValues.get(VCardField.PAGER_WORK);
newValue=null;
oldValue=value.getTextTrim();
String oldType=getFieldType(oldValue);
if ("work".equalsIgnoreCase(oldType)) {
newValue=addFieldType(newWorkPhone,oldType);
}
 else if ("home".equalsIgnoreCase(oldType)) {
newValue=addFieldType(newHomePhone,oldType);
}
 else if ("fax".equalsIgnoreCase(oldType)) {
newValue=addFieldType(newWorkFax,oldType);
}
 else if ("mobile".equalsIgnoreCase(oldType)) {
newValue=addFieldType(newWorkMobile,oldType);
}
 else if ("pager".equalsIgnoreCase(oldType)) {
newValue=addFieldType(newWorkPager,oldType);
}
 else if ("other".equalsIgnoreCase(oldType)) {
vCardValues.remove(VCardField.PHONE_HOME);
vCardValues.remove(VCardField.PHONE_WORK);
vCardValues.remove(VCardField.FAX_WORK);
vCardValues.remove(VCardField.MOBILE_WORK);
vCardValues.remove(VCardField.PAGER_WORK);
break;
}
if (!oldValue.equals(newValue)) {
value.setText(newValue == null ? "" : newValue);
action=Action.MODIFY;
}
vCardValues.remove(VCardField.PHONE_HOME);
vCardValues.remove(VCardField.PHONE_WORK);
vCardValues.remove(VCardField.FAX_WORK);
vCardValues.remove(VCardField.MOBILE_WORK);
vCardValues.remove(VCardField.PAGER_WORK);
break;
}
}
if (vCardValues.containsKey(VCardField.TITLE)) {
String newValue=vCardValues.get(VCardField.TITLE);
if (addProfile(profiles,ClearspaceField.TITLE,newValue)) {
action=Action.MODIFY;
}
}
if (vCardValues.containsKey(VCardField.ORG_ORGUNIT)) {
String newValue=vCardValues.get(VCardField.ORG_ORGUNIT);
if (addProfile(profiles,ClearspaceField.DEPARTMENT,newValue)) {
action=Action.MODIFY;
}
}
if (vCardValues.containsKey(VCardField.ADR_WORK)) {
String newValue=vCardValues.get(VCardField.ADR_WORK);
if (addProfile(profiles,ClearspaceField.ADDRESS,newValue)) {
action=Action.MODIFY;
}
}
if (vCardValues.containsKey(VCardField.ADR_HOME)) {
String newValue=vCardValues.get(VCardField.ADR_HOME);
if (addProfile(profiles,ClearspaceField.HOME_ADDRESS,newValue)) {
action=Action.MODIFY;
}
}
if (vCardValues.containsKey(VCardField.TZ)) {
String newValue=vCardValues.get(VCardField.TZ);
if (addProfile(profiles,ClearspaceField.TIME_ZONE,newValue)) {
action=Action.MODIFY;
}
}
if (vCardValues.containsKey(VCardField.URL)) {
String newValue=vCardValues.get(VCardField.URL);
if (addProfile(profiles,ClearspaceField.URL,newValue)) {
action=Action.MODIFY;
}
}
if (vCardValues.containsKey(VCardField.EMAIL_USERID)) {
String newValue=vCardValues.get(VCardField.EMAIL_USERID);
newValue=addFieldType(newValue,"work");
if (addProfile(profiles,ClearspaceField.ALT_EMAIL,newValue)) {
action=Action.MODIFY;
}
}
if (vCardValues.containsKey(VCardField.PHONE_WORK)) {
String newValue=vCardValues.get(VCardField.PHONE_WORK);
newValue=addFieldType(newValue,"work");
if (addProfile(profiles,ClearspaceField.PHONE,newValue)) {
action=Action.MODIFY;
}
}
 else if (vCardValues.containsKey(VCardField.PHONE_HOME)) {
String newValue=vCardValues.get(VCardField.PHONE_HOME);
newValue=addFieldType(newValue,"home");
if (addProfile(profiles,ClearspaceField.PHONE,newValue)) {
action=Action.MODIFY;
}
}
 else if (vCardValues.containsKey(VCardField.FAX_WORK)) {
String newValue=vCardValues.get(VCardField.FAX_WORK);
newValue=addFieldType(newValue,"fax");
if (addProfile(profiles,ClearspaceField.PHONE,newValue)) {
action=Action.MODIFY;
}
}
 else if (vCardValues.containsKey(VCardField.MOBILE_WORK)) {
String newValue=vCardValues.get(VCardField.MOBILE_WORK);
newValue=addFieldType(newValue,"mobile");
if (addProfile(profiles,ClearspaceField.PHONE,newValue)) {
action=Action.MODIFY;
}
}
 else if (vCardValues.containsKey(VCardField.PAGER_WORK)) {
String newValue=vCardValues.get(VCardField.PAGER_WORK);
newValue=addFieldType(newValue,"pager");
if (addProfile(profiles,ClearspaceField.PHONE,newValue)) {
action=Action.MODIFY;
}
}
return action;
}
