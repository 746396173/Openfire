{
  Presence presence=(Presence)xmppPacket;
  try {
    XMPPAddress senderJID=presence.getSender();
    XMPPAddress recipientJID=presence.getRecipient();
    XMPPPacket.Type type=presence.getType();
    Roster roster=getRoster(senderJID);
    if (roster != null) {
      manageSub(recipientJID,true,type,roster);
    }
    roster=getRoster(recipientJID);
    if (roster != null) {
      manageSub(senderJID,false,type,roster);
    }
    try {
      ChannelHandler handler=routingTable.getRoute(recipientJID);
      handler.process((XMPPPacket)presence.createDeepCopy());
    }
 catch (    NoSuchRouteException e) {
      deliverer.deliver((XMPPPacket)presence.createDeepCopy());
    }
  }
 catch (  Exception e) {
    Log.error(LocaleUtils.getLocalizedString("admin.error"),e);
  }
}
