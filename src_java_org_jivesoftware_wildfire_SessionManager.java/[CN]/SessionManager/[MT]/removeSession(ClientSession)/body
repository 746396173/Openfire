{
  if (session == null || serverName == null) {
    return false;
  }
  boolean auth_removed=false;
  if (anonymousSessions.remove(session.getAddress().getResource()) != null) {
    SessionEventDispatcher.dispatchEvent(session,SessionEventDispatcher.EventType.anonymous_session_destroyed);
    auth_removed=true;
  }
 else {
    String username=session.getAddress().getNode();
    if (username != null) {
      SessionMap sessionMap=sessions.get(username);
      if (sessionMap != null) {
synchronized (username.intern()) {
          auth_removed=sessionMap.removeSession(session);
        }
        if (sessionMap.isEmpty()) {
          sessions.remove(username);
        }
      }
      if (auth_removed) {
        SessionEventDispatcher.dispatchEvent(session,SessionEventDispatcher.EventType.session_destroyed);
      }
    }
  }
  boolean preauth_removed=preAuthenticatedSessions.remove(session.getAddress().getResource()) != null;
  Presence presence=session.getPresence();
  if (presence.isAvailable()) {
    Presence offline=new Presence();
    offline.setFrom(session.getAddress());
    offline.setTo(new JID(null,serverName,null));
    offline.setType(Presence.Type.unavailable);
    router.route(offline);
  }
  return auth_removed || preauth_removed;
}
