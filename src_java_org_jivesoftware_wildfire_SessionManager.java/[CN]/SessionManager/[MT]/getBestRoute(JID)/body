{
  if (serverName == null || !serverName.equals(recipient.getDomain())) {
    return null;
  }
  ClientSession session=null;
  String resource=recipient.getResource();
  String username=recipient.getNode();
  if (resource != null && (username == null || !userManager.isRegisteredUser(username))) {
    session=anonymousSessions.get(resource);
    if (session == null) {
      session=getSession(recipient);
    }
  }
 else {
    SessionMap sessionMap=sessions.get(username);
    if (sessionMap != null) {
      if (resource == null) {
synchronized (username.intern()) {
          session=sessionMap.getDefaultSession(false);
        }
      }
 else {
        session=sessionMap.getSession(resource);
        if (session == null) {
synchronized (username.intern()) {
            session=sessionMap.getDefaultSession(false);
          }
        }
      }
    }
  }
  if (session != null && session.getConnection().isClosed()) {
    removeSession(session);
    return getBestRoute(recipient);
  }
  return session;
}
