{
  if (session.getAddress() != null && routingTable != null && session.getAddress().toBareJID().trim().length() != 0) {
    routingTable.removeRoute(session.getAddress());
    try {
      if (session.getUsername() == null) {
        return;
      }
      SessionMap sessionMap=sessions.get(session.getUsername());
      if (sessionMap == null) {
        JID userJID=new JID(session.getUsername(),serverName,"");
        if (routingTable.getRoute(userJID) != null) {
          routingTable.removeRoute(new JID(session.getAddress().getNode(),session.getAddress().getDomain(),""));
        }
      }
 else       if (sessionMap.getAvailableSessions().isEmpty()) {
        routingTable.removeRoute(new JID(session.getAddress().getNode(),session.getAddress().getDomain(),""));
        broadcastPresenceToOtherResource(session);
      }
 else {
        sessionMap.sessionUnavailable(session);
        Session defaultSession=sessionMap.getDefaultSession(true);
        routingTable.addRoute(new JID(defaultSession.getAddress().getNode(),defaultSession.getAddress().getDomain(),""),defaultSession);
        broadcastPresenceToOtherResource(session);
      }
    }
 catch (    UserNotFoundException e) {
    }
  }
}
