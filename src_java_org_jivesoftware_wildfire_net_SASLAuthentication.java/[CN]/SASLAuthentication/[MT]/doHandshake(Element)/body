{
  boolean isComplete=false;
  boolean success=false;
  while (!isComplete) {
    if (doc.getNamespace().asXML().equals(SASL_NAMESPACE)) {
      ElementType type=ElementType.valueof(doc.getName());
switch (type) {
case AUTH:
        String mechanism=doc.attributeValue("mechanism");
      if (mechanism.equalsIgnoreCase("PLAIN")) {
        success=doPlainAuthentication(doc);
        isComplete=true;
      }
 else       if (mechanism.equalsIgnoreCase("ANONYMOUS")) {
        success=doAnonymousAuthentication();
        isComplete=true;
      }
 else       if (mechanism.equalsIgnoreCase("EXTERNAL")) {
        success=doExternalAuthentication(doc);
        isComplete=true;
      }
 else {
        try {
          Map<String,String> props=new TreeMap<String,String>();
          props.put(Sasl.QOP,"auth");
          SaslServer ss=Sasl.createSaslServer(mechanism,"xmpp",session.getServerName(),props,new XMPPCallbackHandler());
          byte[] challenge=ss.evaluateResponse(new byte[0]);
          sendChallenge(challenge);
          session.setSessionData("SaslServer",ss);
        }
 catch (        SaslException e) {
          isComplete=true;
          Log.warn("SaslException",e);
          authenticationFailed();
        }
      }
    break;
case RESPONSE:
  SaslServer ss=(SaslServer)session.getSessionData("SaslServer");
if (ss != null) {
  boolean ssComplete=ss.isComplete();
  String response=doc.getTextTrim();
  try {
    byte[] data=StringUtils.decodeBase64(response).getBytes(CHARSET);
    if (data == null) {
      data=new byte[0];
    }
    if (ssComplete) {
      authenticationSuccessful(ss.getAuthorizationID());
      success=true;
      isComplete=true;
    }
 else {
      byte[] challenge=ss.evaluateResponse(data);
      sendChallenge(challenge);
    }
  }
 catch (  SaslException e) {
    isComplete=true;
    Log.warn("SaslException",e);
    authenticationFailed();
  }
}
 else {
  isComplete=true;
  Log.fatal("SaslServer is null, should be valid object instead.");
  authenticationFailed();
}
break;
default :
break;
}
if (!isComplete) {
doc=reader.parseDocument().getRootElement();
}
}
 else {
isComplete=true;
Log.debug("Unknown namespace sent in auth element: " + doc.asXML());
authenticationFailed();
}
}
session.removeSessionData("SaslServer");
return success;
}
