{
  if (!(session instanceof IncomingServerSession)) {
    return false;
  }
  String hostname=doc.getTextTrim();
  if (hostname == null || hostname.length() == 0) {
    sendChallenge(new byte[0]);
    doc=reader.parseDocument().getRootElement();
    if (doc != null && doc.getTextTrim().length() > 0) {
      hostname=doc.getTextTrim();
    }
  }
  if (hostname != null && hostname.length() > 0) {
    hostname=StringUtils.decodeBase64(hostname);
    for (    Certificate certificate : connection.getSSLSession().getPeerCertificates()) {
      if (hostname.equals(ServerTrustManager.getPeerIdentity((X509Certificate)certificate))) {
        authenticationSuccessful(hostname);
        return true;
      }
    }
  }
  authenticationFailed();
  return false;
}
