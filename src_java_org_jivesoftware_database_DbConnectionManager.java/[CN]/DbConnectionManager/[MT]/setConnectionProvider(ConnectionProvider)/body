{
synchronized (providerLock) {
    if (connectionProvider != null) {
      connectionProvider.destroy();
      connectionProvider=null;
    }
    connectionProvider=provider;
    connectionProvider.start();
    Connection con=null;
    try {
      con=connectionProvider.getConnection();
      setMetaData(con);
      try {
        upgradeDatabase(con);
      }
 catch (      Exception e) {
        Log.error(LocaleUtils.getLocalizedString("upgrade.database.failure"),e);
        System.out.println(LocaleUtils.getLocalizedString("upgrade.database.failure"));
      }
    }
 catch (    Exception e) {
      Log.error(e);
    }
 finally {
      try {
        if (con != null) {
          con.close();
        }
      }
 catch (      Exception e) {
        Log.error(e);
      }
    }
  }
  JiveGlobals.setXMLProperty("connectionProvider.className",provider.getClass().getName());
}
