{
  Log.debug("Received message packet: " + packet.toXML());
  List<Packet> reply=new ArrayList<Packet>();
  JID from=packet.getFrom();
  JID to=packet.getTo();
  try {
    TransportSession session=sessionManager.getSession(from);
    if (!session.isLoggedIn()) {
      Message m=new Message();
      m.setError(Condition.service_unavailable);
      m.setTo(from);
      m.setFrom(getJID());
      m.setBody("You are not currently logged into the transport.");
      reply.add(m);
    }
 else     if (to.getNode() == null) {
      if (packet.getBody() != null) {
        session.sendServerMessage(packet.getBody());
      }
    }
 else {
      if (packet.getBody() != null) {
        session.sendMessage(to,packet.getBody());
      }
 else {
        Element eEvent=packet.getChildElement("x",XEVENT);
        if (eEvent != null) {
          if (eEvent.element("composing") != null) {
            session.sendChatState(to,ChatStateType.composing);
          }
 else {
            session.sendChatState(to,ChatStateType.paused);
          }
        }
 else {
          if (packet.getChildElement("composing",CHATSTATES) != null) {
            session.sendChatState(to,ChatStateType.composing);
          }
 else           if (packet.getChildElement("active",CHATSTATES) != null) {
            session.sendChatState(to,ChatStateType.active);
          }
 else           if (packet.getChildElement("inactive",CHATSTATES) != null) {
            session.sendChatState(to,ChatStateType.inactive);
          }
 else           if (packet.getChildElement("paused",CHATSTATES) != null) {
            session.sendChatState(to,ChatStateType.paused);
          }
 else           if (packet.getChildElement("gone",CHATSTATES) != null) {
            session.sendChatState(to,ChatStateType.gone);
          }
        }
      }
    }
  }
 catch (  NotFoundException e) {
    Log.debug("Unable to find session.");
    Message m=new Message();
    m.setError(Condition.service_unavailable);
    m.setTo(from);
    m.setFrom(getJID());
    m.setBody("You are not currently logged into the transport.");
    reply.add(m);
  }
  return reply;
}
