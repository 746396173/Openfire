{
  if (!XMPPServer.getInstance().getServerInfo().getName().equals(jid.getDomain())) {
    throw new IllegalAccessException("Domain of jid registering does not match domain of server.");
  }
  if (!isUsernameValid(username)) {
    throw new IllegalArgumentException("Username specified is not valid for this transport type.");
  }
  Collection<Registration> registrations=registrationManager.getRegistrations(jid,this.transportType);
  Boolean foundReg=false;
  for (  Registration registration : registrations) {
    if (!registration.getUsername().equals(username)) {
      registrationManager.deleteRegistration(registration);
    }
 else {
      registration.setPassword(password);
      foundReg=true;
    }
  }
  if (!foundReg) {
    registrationManager.createRegistration(jid,this.transportType,username,password,nickname);
  }
  try {
    cleanUpRoster(jid,!noRosterItem);
  }
 catch (  UserNotFoundException ee) {
    throw new UserNotFoundException("Unable to find roster.");
  }
  if (!noRosterItem) {
    try {
      addOrUpdateRosterItem(jid,this.getJID(),this.getDescription(),"Transports");
    }
 catch (    UserNotFoundException e) {
      throw new UserNotFoundException("User not registered with server.");
    }
  }
  Presence p=new Presence(Presence.Type.probe);
  p.setTo(jid);
  p.setFrom(getJID());
  sendPacket(p);
}
