{
  if (update.getFrom() == null) {
    return;
  }
  if (localServer.isLocal(update.getFrom())) {
    String name=update.getFrom().getNode();
    try {
      if (name != null && !"".equals(name)) {
        name=name.toLowerCase();
        Roster roster=rosterManager.getRoster(name);
        if (!roster.isRosterItem(update.getTo())) {
          Set set=(Set)directedPresences.get(update.getFrom().toString());
          if (set == null) {
            set=new CopyOnWriteArraySet();
            directedPresences.put(update.getFrom().toString(),set);
          }
          if (Presence.Type.unavailable.equals(update.getType())) {
            if (handler instanceof SessionImpl) {
              set.remove(new HandlerWeakReference(handler));
              if (set.isEmpty()) {
                directedPresences.remove(update.getFrom().toString());
              }
            }
          }
 else {
            set.add(new HandlerWeakReference(handler));
          }
        }
      }
    }
 catch (    UserNotFoundException e) {
      Log.warn("Presence being sent from unknown user " + name,e);
    }
catch (    PacketException e) {
      Log.error(LocaleUtils.getLocalizedString("admin.error"),e);
    }
  }
}
