{
  Presence presence=(Presence)xmppPacket;
  try {
    ClientSession session=sessionManager.getSession(presence.getFrom());
    Presence.Type type=presence.getType();
    if (type == null) {
      broadcastUpdate(presence.createCopy());
      if (session != null) {
        session.setPresence(presence);
        if (!session.isInitialized()) {
          initSession(session);
          session.setInitialized(true);
        }
      }
      if (presence.getTo() == null && localServer.isLocal(presence.getFrom())) {
        presenceManager.deleteLastUnavailablePresence(presence.getFrom().getNode());
      }
    }
 else     if (Presence.Type.unavailable == type) {
      broadcastUpdate(presence.createCopy());
      broadcastUnavailableForDirectedPresences(presence);
      if (session != null) {
        session.setPresence(presence);
      }
      if (presence.getTo() == null && localServer.isLocal(presence.getFrom())) {
        if (!presence.getElement().elements().isEmpty()) {
          presenceManager.saveLastUnavailablePresence(presence.getFrom().getNode(),presence);
        }
      }
    }
 else {
      presence=presence.createCopy();
      if (session != null) {
        presence.setFrom(new JID(null,session.getServerName(),null));
        presence.setTo(session.getAddress());
      }
 else {
        JID sender=presence.getFrom();
        presence.setFrom(presence.getTo());
        presence.setTo(sender);
      }
      presence.setError(PacketError.Condition.bad_request);
      deliverer.deliver(presence);
    }
  }
 catch (  Exception e) {
    Log.error(LocaleUtils.getLocalizedString("admin.error"),e);
  }
}
