{
  if (!"".equals(session.getAddress().getName())) {
    String username=session.getAddress().getNamePrep();
    CachedRoster roster=rosterManager.getRoster(username);
    Iterator items=roster.getRosterItems();
    while (items.hasNext()) {
      RosterItem item=(RosterItem)items.next();
      if (item.getRecvStatus() == RosterItem.RECV_SUBSCRIBE) {
        session.getConnection().deliver(createSubscribePresence(item.getJid(),true));
      }
 else       if (item.getRecvStatus() == RosterItem.RECV_UNSUBSCRIBE) {
        session.getConnection().deliver(createSubscribePresence(item.getJid(),false));
      }
      if (item.getSubStatus() == RosterItem.SUB_TO || item.getSubStatus() == RosterItem.SUB_BOTH) {
        presenceManager.probePresence(username,item.getJid());
      }
    }
    Iterator msgs=messageStore.getMessages(username);
    while (msgs.hasNext()) {
      Message msg=(Message)msgs.next();
      session.getConnection().deliver(msg);
    }
  }
}
