{
  if (!"".equals(session.getAddress().getNode())) {
    String username=session.getAddress().getNode();
    Roster roster=rosterManager.getRoster(username);
    Iterator items=roster.getRosterItems();
    while (items.hasNext()) {
      RosterItem item=(RosterItem)items.next();
      if (item.getRecvStatus() == RosterItem.RECV_SUBSCRIBE) {
        session.getConnection().deliver(createSubscribePresence(item.getJid(),true));
      }
 else       if (item.getRecvStatus() == RosterItem.RECV_UNSUBSCRIBE) {
        session.getConnection().deliver(createSubscribePresence(item.getJid(),false));
      }
      if (item.getSubStatus() == RosterItem.SUB_TO || item.getSubStatus() == RosterItem.SUB_BOTH) {
        presenceManager.probePresence(username,item.getJid());
      }
    }
    Collection<Message> messages=messageStore.getMessages(username);
    for (    Message message : messages) {
      session.getConnection().deliver(message);
    }
  }
}
