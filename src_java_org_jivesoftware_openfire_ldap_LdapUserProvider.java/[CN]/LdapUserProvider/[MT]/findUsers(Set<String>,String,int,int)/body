{
  if (fields.isEmpty() || query == null || "".equals(query)) {
    return Collections.emptyList();
  }
  if (!searchFields.keySet().containsAll(fields)) {
    throw new IllegalArgumentException("Search fields " + fields + " are not valid.");
  }
  if (!query.endsWith("*")) {
    query=query + "*";
  }
  int pageSize=JiveGlobals.getXMLProperty("ldap.pagedResultsSize",-1);
  Boolean clientSideSort=JiveGlobals.getXMLProperty("ldap.clientSideSorting",false);
  List<String> usernames=new ArrayList<String>();
  LdapContext ctx=null;
  LdapContext ctx2=null;
  try {
    ctx=manager.getContext(baseDN);
    List<Control> tmpRequestControls=new ArrayList<Control>();
    if (!clientSideSort) {
      tmpRequestControls.add(new SortControl(new String[]{manager.getUsernameField()},Control.NONCRITICAL));
    }
    if (pageSize > -1) {
      tmpRequestControls.add(new PagedResultsControl(pageSize,Control.NONCRITICAL));
    }
    Control[] requestControls=tmpRequestControls.toArray(new Control[tmpRequestControls.size()]);
    ctx.setRequestControls(requestControls);
    SearchControls searchControls=new SearchControls();
    if (manager.isSubTreeSearch()) {
      searchControls.setSearchScope(SearchControls.SUBTREE_SCOPE);
    }
 else {
      searchControls.setSearchScope(SearchControls.ONELEVEL_SCOPE);
    }
    searchControls.setReturningAttributes(new String[]{manager.getUsernameField()});
    String searchFilter=MessageFormat.format(manager.getSearchFilter(),"*");
    StringBuilder filter=new StringBuilder();
    filter.append("(&(");
    filter.append(searchFilter);
    filter.append(")");
    if (fields.size() > 1) {
      filter.append("(|");
    }
    for (    String field : fields) {
      String attribute=searchFields.get(field);
      filter.append("(").append(attribute).append("=").append(query).append(")");
    }
    if (fields.size() > 1) {
      filter.append(")");
    }
    filter.append(")");
    NamingEnumeration answer=ctx.search("",filter.toString(),searchControls);
    int skip=-1;
    int lastRes=-1;
    if (!clientSideSort) {
      skip=startIndex;
      lastRes=startIndex + numResults;
    }
    byte[] cookie=null;
    int count=0;
    do {
      while (answer.hasMoreElements()) {
        count++;
        if (skip > -1 && count < skip) {
          continue;
        }
        if (lastRes > -1 && count > lastRes) {
          break;
        }
        String username=(String)((SearchResult)answer.next()).getAttributes().get(manager.getUsernameField()).get();
        usernames.add(JID.escapeNode(username));
      }
      Control[] controls=ctx.getResponseControls();
      if (controls != null) {
        for (        Control control : controls) {
          if (control instanceof PagedResultsResponseControl) {
            PagedResultsResponseControl prrc=(PagedResultsResponseControl)control;
            cookie=prrc.getCookie();
            ctx.setRequestControls(new Control[]{new PagedResultsControl(pageSize,cookie,Control.CRITICAL)});
            break;
          }
        }
      }
    }
 while (cookie != null);
    if (count <= lastRes && alternateBaseDN != null) {
      ctx2=manager.getContext(alternateBaseDN);
      ctx2.setRequestControls(requestControls);
      answer=ctx2.search("",filter.toString(),searchControls);
      cookie=null;
      do {
        while (answer.hasMoreElements()) {
          count++;
          if (skip > -1 && count < skip) {
            continue;
          }
          if (lastRes > -1 && count > lastRes) {
            break;
          }
          String username=(String)((SearchResult)answer.next()).getAttributes().get(manager.getUsernameField()).get();
          String suffix=manager.getUsernameSuffix();
          if (suffix.length() > 0 && username.endsWith(suffix)) {
            username=username.substring(0,username.length() - suffix.length());
          }
          usernames.add(JID.escapeNode(username));
        }
        Control[] controls=ctx.getResponseControls();
        if (controls != null) {
          for (          Control control : controls) {
            if (control instanceof PagedResultsResponseControl) {
              PagedResultsResponseControl prrc=(PagedResultsResponseControl)control;
              cookie=prrc.getCookie();
              ctx.setRequestControls(new Control[]{new PagedResultsControl(pageSize,cookie,Control.CRITICAL)});
              break;
            }
          }
        }
      }
 while (cookie != null);
    }
    answer.close();
    if (clientSideSort) {
      Collections.sort(usernames);
    }
  }
 catch (  Exception e) {
    Log.error(e);
  }
 finally {
    try {
      if (ctx != null) {
        ctx.setRequestControls(null);
        ctx.close();
      }
    }
 catch (    Exception ignored) {
    }
    try {
      if (ctx2 != null) {
        ctx2.setRequestControls(null);
        ctx2.close();
      }
    }
 catch (    Exception ignored) {
    }
  }
  return new UserCollection(usernames.toArray(new String[usernames.size()]));
}
