{
  SnacPacket packet=e.getSnacPacket();
  Log.debug("got snac packet type " + Integer.toHexString(packet.getFamily()) + "/"+ Integer.toHexString(packet.getCommand())+ ": "+ e.getSnacCommand());
  SnacCommand cmd=e.getSnacCommand();
  if (cmd instanceof ServerReadyCmd) {
    ServerReadyCmd src=(ServerReadyCmd)cmd;
    setSnacFamilies(src.getSnacFamilies());
    SnacFamilyInfo[] familyInfos=SnacFamilyInfoFactory.getDefaultFamilyInfos(src.getSnacFamilies());
    setSnacFamilyInfos(familyInfos);
    oscarSession.registerSnacFamilies(this);
    request(new ClientVersionsCmd(familyInfos));
    request(new RateInfoRequest());
  }
 else   if (cmd instanceof RecvImIcbm) {
    RecvImIcbm icbm=(RecvImIcbm)cmd;
    String sn=icbm.getSenderInfo().getScreenname();
    InstantMessage message=icbm.getMessage();
    String msg=null;
    msg=OscarTools.stripHtml(message.getMessage());
    Message jmessage=new Message();
    jmessage.setTo(oscarSession.getRegistration().getJID());
    jmessage.setBody(msg);
    jmessage.setType(Message.Type.chat);
    jmessage.setFrom(this.oscarSession.getTransport().convertIDToJID(sn));
    oscarSession.getTransport().sendPacket((Packet)jmessage);
    String str=dateFormat.format(new Date()) + " IM from " + sn+ ": "+ msg;
    Log.debug(str);
  }
 else   if (cmd instanceof WarningNotification) {
    WarningNotification wn=(WarningNotification)cmd;
    MiniUserInfo warner=wn.getWarner();
    if (warner == null) {
      Log.debug("*** You were warned anonymously to " + wn.getNewLevel() + "%");
    }
 else {
      Log.debug("*** " + warner.getScreenname() + " warned you up to "+ wn.getNewLevel()+ "%");
    }
  }
 else   if (cmd instanceof BuddyStatusCmd) {
    BuddyStatusCmd bsc=(BuddyStatusCmd)cmd;
    FullUserInfo info=bsc.getUserInfo();
    buddystore.put(info.getScreenname(),info);
    Presence p=new Presence();
    p.setTo(oscarSession.getJID());
    p.setFrom(oscarSession.getTransport().convertIDToJID(info.getScreenname()));
    if (info.getAwayStatus() == true) {
      p.setShow(Presence.Show.away);
    }
    ExtraInfoBlock[] extraInfo=info.getExtraInfoBlocks();
    if (extraInfo != null) {
      for (      ExtraInfoBlock i : extraInfo) {
        ExtraInfoData data=i.getExtraData();
        if (i.getType() == ExtraInfoBlock.TYPE_AVAILMSG) {
          ByteBlock msgBlock=data.getData();
          int len=BinaryTools.getUShort(msgBlock,0);
          byte[] msgBytes=msgBlock.subBlock(2,len).toByteArray();
          String msg;
          try {
            msg=new String(msgBytes,"UTF-8");
          }
 catch (          UnsupportedEncodingException e1) {
            continue;
          }
          if (msg.length() > 0) {
            p.setStatus(msg);
          }
        }
      }
    }
    oscarSession.getTransport().sendPacket(p);
  }
 else   if (cmd instanceof BuddyOfflineCmd) {
    BuddyOfflineCmd boc=(BuddyOfflineCmd)cmd;
    buddystore.remove(boc.getScreenname());
    Presence p=new Presence(Presence.Type.unavailable);
    p.setTo(oscarSession.getJID());
    p.setFrom(oscarSession.getTransport().convertIDToJID(boc.getScreenname()));
    oscarSession.getTransport().sendPacket(p);
  }
 else   if (cmd instanceof RateChange) {
    RateChange rc=(RateChange)cmd;
    Log.debug("rate change: current avg is " + rc.getRateInfo().getCurrentAvg());
  }
}
