{
  if (packet == null) {
    throw new NullPointerException();
  }
  Session session=sessionManager.getSession(packet.getFrom());
  if (session == null || session.getStatus() == Session.STATUS_AUTHENTICATED) {
    JID recipientJID=packet.getTo();
    if (recipientJID.getNode() == null && recipientJID.getResource() == null && serverName.equals(recipientJID.getDomain())) {
      sendMessageToAdmins(packet);
      return;
    }
    try {
      routingTable.getBestRoute(recipientJID).process(packet);
    }
 catch (    Exception e) {
      try {
        messageStrategy.storeOffline(packet);
      }
 catch (      Exception e1) {
        Log.error(e1);
      }
    }
  }
 else {
    packet.setTo(session.getAddress());
    packet.setFrom((JID)null);
    packet.setError(PacketError.Condition.not_authorized);
    try {
      session.process(packet);
    }
 catch (    UnauthorizedException ue) {
      Log.error(ue);
    }
  }
}
