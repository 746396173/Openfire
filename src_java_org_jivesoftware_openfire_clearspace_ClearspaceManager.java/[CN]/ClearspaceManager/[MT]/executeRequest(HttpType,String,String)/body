{
  if (Log.isDebugEnabled()) {
    Log.debug("Outgoing REST call [" + type + "] to "+ urlSuffix+ ": "+ xmlParams);
  }
  String wsUrl=getConnectionURI() + WEBSERVICES_PATH + urlSuffix;
  String secret=getSharedSecret();
  HttpClient client=new HttpClient();
  HttpMethod method;
  client.getParams().setAuthenticationPreemptive(true);
  Credentials credentials=new UsernamePasswordCredentials(OPENFIRE_USERNAME,secret);
  AuthScope scope=new AuthScope(host,port,AuthScope.ANY_REALM);
  client.getState().setCredentials(scope,credentials);
switch (type) {
case GET:
    method=new GetMethod(wsUrl);
  break;
case POST:
PostMethod pm=new PostMethod(wsUrl);
StringRequestEntity requestEntity=new StringRequestEntity(xmlParams);
pm.setRequestEntity(requestEntity);
method=pm;
break;
case PUT:
PutMethod pm1=new PutMethod(wsUrl);
StringRequestEntity requestEntity1=new StringRequestEntity(xmlParams);
pm1.setRequestEntity(requestEntity1);
method=pm1;
break;
case DELETE:
method=new DeleteMethod(wsUrl);
break;
default :
throw new IllegalArgumentException();
}
method.setRequestHeader("Accept","text/xml");
method.setDoAuthentication(true);
try {
client.executeMethod(method);
String body=method.getResponseBodyAsString();
if (Log.isDebugEnabled()) {
Log.debug("Outgoing REST call results: " + body);
}
if (method.getStatusCode() != 200) {
if (method.getStatusCode() == 401) {
throw new ConnectionException("Invalid password to connect to Clearspace.",ConnectionException.ErrorType.AUTHENTICATION);
}
 else if (method.getStatusCode() == 404) {
throw new ConnectionException("Web service not found in Clearspace.",ConnectionException.ErrorType.PAGE_NOT_FOUND);
}
 else if (method.getStatusCode() == 503) {
throw new ConnectionException("Web service not avaible in Clearspace.",ConnectionException.ErrorType.SERVICE_NOT_AVAIBLE);
}
 else {
throw new ConnectionException("Error connecting to Clearspace, http status code: " + method.getStatusCode(),new HTTPConnectionException(method.getStatusCode()),ConnectionException.ErrorType.OTHER);
}
}
 else if (body.contains("Clearspace Upgrade Console")) {
throw new ConnectionException("Clearspace is in an update state.",ConnectionException.ErrorType.UPDATE_STATE);
}
Element response=localParser.get().parseDocument(body).getRootElement();
checkFault(response);
return response;
}
 catch (DocumentException e) {
throw new ConnectionException("Error parsing the response of Clearspace.",e,ConnectionException.ErrorType.OTHER);
}
catch (HttpException e) {
throw new ConnectionException("Error performing http request to Clearspace",e,ConnectionException.ErrorType.OTHER);
}
catch (UnknownHostException e) {
throw new ConnectionException("Unknown Host " + getConnectionURI() + " trying to connect to Clearspace",e,ConnectionException.ErrorType.UNKNOWN_HOST);
}
catch (IOException e) {
throw new ConnectionException("Error peforming http request to Clearspace.",e,ConnectionException.ErrorType.OTHER);
}
 finally {
method.releaseConnection();
}
}
