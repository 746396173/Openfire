{
  if (setupMode && !(pluginDir.getName().equals("admin"))) {
    return;
  }
  Log.debug("Loading plugin " + pluginDir.getName());
  Plugin plugin=null;
  try {
    File pluginConfig=new File(pluginDir,"plugin.xml");
    if (pluginConfig.exists()) {
      SAXReader saxReader=new SAXReader();
      Document pluginXML=saxReader.read(pluginConfig);
      PluginClassLoader pluginLoader=new PluginClassLoader(pluginDir);
      String className=pluginXML.selectSingleNode("/plugin/class").getText();
      plugin=(Plugin)pluginLoader.loadClass(className).newInstance();
      plugin.initialize(this,pluginDir);
      plugins.put(pluginDir.getName(),plugin);
      classloaders.put(plugin,pluginLoader);
      File webXML=new File(pluginDir,"web" + File.separator + "web.xml");
      if (webXML.exists()) {
        PluginServlet.registerServlets(this,plugin,webXML);
      }
      Element adminElement=(Element)pluginXML.selectSingleNode("/plugin/adminconsole");
      if (adminElement != null) {
        Element imageEl=(Element)adminElement.selectSingleNode("/plugin/adminconsole/global/logo-image");
        if (imageEl != null) {
          imageEl.setText("plugins/" + pluginDir.getName() + "/"+ imageEl.getText());
        }
        imageEl=(Element)adminElement.selectSingleNode("/plugin/adminconsole/global/login-image");
        if (imageEl != null) {
          imageEl.setText("plugins/" + pluginDir.getName() + "/"+ imageEl.getText());
        }
        List urls=adminElement.selectNodes("//@url");
        for (int i=0; i < urls.size(); i++) {
          Attribute attr=(Attribute)urls.get(i);
          attr.setValue("plugins/" + pluginDir.getName() + "/"+ attr.getValue());
        }
        AdminConsole.addModel(adminElement);
      }
    }
 else {
      Log.warn("Plugin " + pluginDir + " could not be loaded: no plugin.xml file found");
    }
  }
 catch (  Exception e) {
    Log.error("Error loading plugin",e);
  }
}
