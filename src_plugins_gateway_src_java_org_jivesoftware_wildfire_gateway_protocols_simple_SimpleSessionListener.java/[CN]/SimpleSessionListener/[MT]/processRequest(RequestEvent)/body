{
  ServerTransaction serverTransaction=requestEvent.getServerTransaction();
  Dialog dialog=null;
  if (serverTransaction != null) {
    Log.debug("SimpleSessionListener(" + myUsername + ").processRequest:  Getting dialog");
    dialog=serverTransaction.getDialog();
  }
  int responseCode=200;
  Log.debug("SimpleSessionListener(" + myUsername + ").processRequest:  Received a request event:  \n"+ requestEvent.getRequest().toString());
  String fromAddr="";
  Request request=requestEvent.getRequest();
  if (request.getHeader(FromHeader.NAME) != null) {
    FromHeader fromHeader=(FromHeader)request.getHeader(FromHeader.NAME);
    Address fromAddress=fromHeader.getAddress();
    String displayName=fromAddress.getDisplayName();
    URI fromUri=fromAddress.getURI();
    if (fromUri != null) {
      if (fromUri.isSipURI()) {
        SipURI fromSipUri=(SipURI)fromUri;
        fromAddr=fromSipUri.getUser() + "@" + fromSipUri.getHost();
      }
 else {
        fromAddr=fromUri.toString();
      }
    }
  }
  Log.debug("SimpleSessionListener(" + myUsername + ").processRequest:  FromAddr = "+ fromAddr);
  Log.debug("SimpleSessionListener(" + myUsername + ").processRequest:  Request method = '"+ request.getMethod()+ "'");
  if (request.getMethod().equals(Request.MESSAGE)) {
    Log.debug("SimpleSessionListener(" + myUsername + ").processRequest:  Starting MESSAGE request handling process.");
    JID senderJid=mySimpleSession.getTransport().convertIDToJID(fromAddr);
    String msgContent=new String((byte[])request.getContent());
    Log.debug("SimpleSessionListener(" + myUsername + ").processRequest:  Forwarding MESSAGE request as XMPP message, setting from = "+ senderJid+ " and content = '"+ msgContent+ "'");
    mySimpleSession.getTransport().sendMessage(mySimpleSession.getJID(),senderJid,msgContent);
    mySimpleSession.sendResponse(responseCode,request,serverTransaction);
  }
 else   if (request.getMethod().equals(Request.NOTIFY)) {
    Presence presence=new Presence();
    presence.setFrom(mySimpleSession.getTransport().convertIDToJID(fromAddr));
    presence.setTo(mySimpleSession.getJID());
    SubscriptionStateHeader subscriptionStateHeader=(SubscriptionStateHeader)request.getHeader(SubscriptionStateHeader.NAME);
    Log.debug("SimpleSessionListener(" + myUsername + ").processRequest:  NOTIFY request handling process started.");
    if (subscriptionStateHeader.getState().equalsIgnoreCase(SubscriptionStateHeader.ACTIVE)) {
      Log.debug("SimpleSessionListener(" + myUsername + ").processRequest:  NOTIFY Active!");
      int expires=subscriptionStateHeader.getExpires();
      Log.debug("SimpleSessionListener(" + myUsername + ").processRequest:  NOTIFY Expiry = "+ expires);
      try {
        if (expires > 0) {
          String content="";
          if (request.getContent() != null)           content=new String((byte[])request.getContent());
          if (content.length() > 0) {
            SimplePresence simplePresence=SimplePresence.parseSimplePresence(content);
            ((SimpleTransport)mySimpleSession.getTransport()).convertSIPStatusToJap(presence,simplePresence);
          }
        }
 else {
          presence.setType(Presence.Type.unsubscribed);
        }
        Log.debug("SimpleSessionListener(" + myUsername + ").processRequest:  Sending XMPP presence packet.");
      }
 catch (      Exception ex) {
        Log.debug("SimpleSessionListener(" + myUsername + ").processRequest:  Exception occured when processing NOTIFY packet...",ex);
      }
    }
 else     if (subscriptionStateHeader.getState().equalsIgnoreCase(SubscriptionStateHeader.TERMINATED)) {
      presence.setType(Presence.Type.unsubscribed);
    }
    mySimpleSession.getTransport().sendPacket(presence);
    mySimpleSession.sendResponse(responseCode,request,serverTransaction);
  }
 else   if (request.getMethod().equals(Request.SUBSCRIBE)) {
    Log.debug("SimpleSessionListener for " + myUsername + ":  SUBSCRIBE request handling process.");
    ServerTransaction transaction=mySimpleSession.sendResponse(202,request,serverTransaction);
    Log.debug("SimpleSessionListener for " + myUsername + ":  SUBSCRIBE should be followed by a NOTIFY");
    try {
      if (transaction != null)       mySimpleSession.sendNotify(transaction.getDialog());
 else       mySimpleSession.sendNotify(dialog);
    }
 catch (    Exception e) {
      Log.debug("SimpleSessionListener for " + myUsername + ":  Unable to prepare NOTIFY packet.",e);
    }
  }
}
