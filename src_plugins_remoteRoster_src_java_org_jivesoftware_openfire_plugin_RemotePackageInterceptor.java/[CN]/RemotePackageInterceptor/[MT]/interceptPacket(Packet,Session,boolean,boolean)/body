{
  if (!processed && incoming) {
    if (packet instanceof IQ) {
      IQ myPacket=(IQ)packet;
      if (myPacket.getFrom() == null || myPacket.getTo() == null) {
        return;
      }
      String to=myPacket.getTo().toString();
      String from=myPacket.getFrom().toString();
      if (myPacket.getType().equals(IQ.Type.get) && from.equals(_mySubdomain)) {
        if (findNodesInDocument(myPacket.getElement().getDocument(),"//roster:*").size() == 1) {
          _packetProcessor.get("sendRoster").process(packet);
        }
      }
 else       if (myPacket.getType().equals(IQ.Type.set) && from.equals(_mySubdomain)) {
        if (findNodesInDocument(myPacket.getElement().getDocument(),"//roster:item").size() >= 1) {
          _packetProcessor.get("receiveChanges").process(packet);
        }
      }
 else       if (myPacket.getType().equals(IQ.Type.set) && myPacket.getTo().toString().equals(_mySubdomain)) {
        if (packet.toXML().contains("jabber:iq:gateway:register")) {
          _registeredJids.add(from);
        }
 else         if (findNodesInDocument(myPacket.getChildElement().getDocument(),"//register:remove").size() == 1) {
          _registeredJids.remove(from);
        }
      }
 else       if (myPacket.getType().equals(IQ.Type.result) && myPacket.getFrom().toString().equals(_mySubdomain)) {
        if (_registeredJids.contains(to)) {
          Element feature=new DefaultElement("feature");
          feature.add(new DefaultAttribute("var","jabber:iq:registered"));
          myPacket.getChildElement().add(feature);
        }
      }
    }
  }
}
