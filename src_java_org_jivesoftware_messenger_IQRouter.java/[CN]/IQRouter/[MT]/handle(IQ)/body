{
  JID recipientJID=packet.getTo();
  try {
    Component component=null;
    if (recipientJID != null) {
      component=componentManager.getComponent(packet.getTo().toBareJID());
    }
    if (component != null) {
      component.processPacket(packet);
    }
 else     if (isLocalServer(recipientJID)) {
      Element childElement=packet.getChildElement();
      String namespace=null;
      if (childElement != null) {
        namespace=childElement.getNamespaceURI();
      }
      if (namespace == null) {
        Log.warn("Unknown packet " + packet);
      }
 else {
        IQHandler handler=getHandler(namespace);
        if (handler == null) {
          IQ reply=IQ.createResultIQ(packet);
          if (recipientJID == null) {
            reply.setError(PacketError.Condition.service_unavailable);
          }
 else           if (recipientJID.getNode() == null || "".equals(recipientJID.getNode())) {
            reply.setError(PacketError.Condition.feature_not_implemented);
          }
 else {
            try {
              ChannelHandler route=routingTable.getRoute(recipientJID);
              if (route instanceof BasicModule) {
                route.process(packet);
                return;
              }
            }
 catch (            NoSuchRouteException e) {
            }
            reply.setError(PacketError.Condition.service_unavailable);
          }
          Session session=sessionManager.getSession(packet.getFrom());
          if (session != null) {
            session.getConnection().deliver(reply);
          }
 else {
            Log.warn("Packet could not be delivered " + packet);
          }
        }
 else {
          handler.process(packet);
        }
      }
    }
 else {
      ChannelHandler route=routingTable.getRoute(recipientJID);
      route.process(packet);
    }
  }
 catch (  NoSuchRouteException e) {
    Log.info("Packet sent to unreachable address " + packet);
    Session session=sessionManager.getSession(packet.getFrom());
    if (session != null) {
      try {
        packet.setError(PacketError.Condition.service_unavailable);
        session.getConnection().deliver(packet);
      }
 catch (      UnauthorizedException ex) {
        Log.error(LocaleUtils.getLocalizedString("admin.error.routing"),e);
      }
    }
  }
catch (  Exception e) {
    Log.error(LocaleUtils.getLocalizedString("admin.error.routing"),e);
    try {
      Session session=sessionManager.getSession(packet.getFrom());
      if (session != null) {
        Connection conn=session.getConnection();
        if (conn != null) {
          conn.close();
        }
      }
    }
 catch (    UnauthorizedException e1) {
    }
  }
}
