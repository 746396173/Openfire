{
  ChannelHandler route=null;
  String nodeJID=node.getNode() == null ? "" : node.getNode();
  String resourceJID=node.getResource() == null ? "" : node.getResource();
  try {
    Object nameRoutes=routes.get(node.getDomain());
    if (nameRoutes instanceof ConcurrentHashMap) {
      Object resourceRoutes=((Map)nameRoutes).get(nodeJID);
      if (resourceRoutes instanceof ConcurrentHashMap) {
        route=(ChannelHandler)((Map)resourceRoutes).remove(resourceJID);
        if (((Map)resourceRoutes).isEmpty()) {
          ((Map)nameRoutes).remove(nodeJID);
          if (((Map)nameRoutes).isEmpty()) {
            routes.remove(node.getDomain());
          }
        }
      }
 else {
        ((Map)nameRoutes).remove(nodeJID);
      }
    }
 else     if (nameRoutes != null) {
      if (("".equals(nodeJID) && "".equals(resourceJID)) || ((RoutableChannelHandler)nameRoutes).getAddress().equals(node)) {
        routes.remove(node.getDomain());
      }
    }
  }
 catch (  Exception e) {
    Log.error("Error removing route",e);
  }
  return route;
}
