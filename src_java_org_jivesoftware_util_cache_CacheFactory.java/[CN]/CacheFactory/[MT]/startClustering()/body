{
  clusteringStarted=false;
  clusteringStarting=true;
  try {
    cacheFactoryStrategy=(CacheFactoryStrategy)Class.forName(clusteredCacheFactoryClass,true,getClusteredCacheStrategyClassLoader()).newInstance();
    clusteringStarted=cacheFactoryStrategy.startCluster();
  }
 catch (  Exception e) {
    Log.error("Unable to start clustering - continuing in local mode",e);
  }
  if (!clusteringStarted) {
    try {
      cacheFactoryStrategy=(CacheFactoryStrategy)Class.forName(localCacheFactoryClass).newInstance();
    }
 catch (    Exception e) {
      Log.error("Fatal error - Failed to join the cluster and failed to use local cache",e);
    }
  }
 else {
    if (statsThread == null) {
      statsThread=new Thread("Cache Stats"){
        private volatile boolean destroyed=false;
        public void run(){
          XMPPServer.getInstance().addServerListener(new XMPPServerListener(){
            public void serverStarted(){
            }
            public void serverStopping(){
              destroyed=true;
            }
          }
);
          ClusterManager.addListener(new ClusterEventListener(){
            public void joinedCluster(){
            }
            public void joinedCluster(            byte[] nodeID){
            }
            public void leftCluster(){
              destroyed=true;
              ClusterManager.removeListener(this);
            }
            public void leftCluster(            byte[] nodeID){
            }
            public void markedAsSeniorClusterMember(){
            }
          }
);
          while (!destroyed && ClusterManager.isClusteringEnabled()) {
            try {
              cacheFactoryStrategy.updateCacheStats(caches);
            }
 catch (            Exception e) {
              Log.error(e.getMessage(),e);
            }
            try {
              sleep(10000);
            }
 catch (            InterruptedException ie) {
            }
          }
          statsThread=null;
          Log.debug("Cache stats thread terminated.");
        }
      }
;
      statsThread.setDaemon(true);
      statsThread.start();
    }
  }
  clusteringStarting=false;
}
