{
  for (  SubscriptionInfo si : persistenceManager.getRegistrar().getAllGatewaySessions()) {
    try {
      GatewaySession session=persistenceManager.getRegistrar().getGatewaySession(si.jid);
      if (!session.isConnected()) {
        continue;
      }
      for (      ForeignContact fc : session.getContacts()) {
        try {
          Roster roster=rosterManager.getRoster(si.jid.getNode());
          try {
            RosterItem gwitem=roster.getRosterItem(fc.getJid());
            if (gwitem.getSubStatus() != RosterItem.SUB_BOTH) {
              gwitem.setSubStatus(RosterItem.SUB_BOTH);
            }
            if (gwitem.getAskStatus() != RosterItem.ASK_NONE) {
              gwitem.setAskStatus(RosterItem.ASK_NONE);
            }
            roster.updateRosterItem(gwitem);
          }
 catch (          UserNotFoundException e) {
            try {
              RosterItem gwitem=roster.createRosterItem(fc.getJid(),true);
              gwitem.setSubStatus(RosterItem.SUB_BOTH);
              gwitem.setAskStatus(RosterItem.ASK_NONE);
              roster.updateRosterItem(gwitem);
            }
 catch (            UserAlreadyExistsException ee) {
              Log.error("getRosterItem claims user exists, but couldn't find via getRosterItem?");
            }
catch (            Exception ee) {
              Log.error("createRosterItem caused exception: " + ee.getMessage());
            }
          }
        }
 catch (        UserNotFoundException e) {
          Log.error("Someone attempted to register with the gateway who is not registered with the server: " + si.jid);
        }
      }
    }
 catch (    Exception e) {
    }
  }
}
