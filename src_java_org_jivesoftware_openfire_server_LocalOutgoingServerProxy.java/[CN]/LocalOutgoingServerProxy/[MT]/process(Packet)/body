{
  if (this.session != null) {
    this.session.process(packet);
    return;
  }
  if (packets == null) {
    packets=new LinkedBlockingQueue<Packet>();
    log.info("Queued packet for {}.",domain.toString());
  }
  packets.add(packet.createCopy());
  if (isTrying == false) {
    final String fromDomain=packet.getFrom().getDomain().toString();
    final String toDomain=packet.getTo().getDomain().toString();
    if ((failureTimestamp == -1) || ((System.currentTimeMillis() - failureTimestamp) >= 5000)) {
      isTrying=true;
      log.debug("Spinning up new session to {}",domain.toString());
      pool.execute(new Runnable(){
        public void run(){
          log.debug("Initiating connection thread for {} -> {} ({})",fromDomain,toDomain,domain.toString());
          try {
            ServerSession s=LocalOutgoingServerSession.authenticateDomain(fromDomain,toDomain);
            if (s != null) {
              sessionReady(s);
            }
 else {
              sessionFailed();
            }
          }
 catch (          Exception e) {
            log.debug("Session for {} failed with:",domain.toString(),e);
            sessionFailed();
          }
          log.debug("Finished connection thread for {}",domain.toString());
          return;
        }
      }
);
    }
 else {
      sessionFailed();
    }
  }
 else {
    packets.add(packet);
  }
}
