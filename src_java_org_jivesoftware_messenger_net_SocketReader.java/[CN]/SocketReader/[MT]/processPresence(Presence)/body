{
  if (connection.getTlsPolicy() == Connection.TLSPolicy.required && !connection.isSecure()) {
    closeNeverSecuredConnection();
    return;
  }
  try {
    InterceptorManager.getInstance().invokeInterceptors(packet,session,true,false);
    router.route(packet);
    InterceptorManager.getInstance().invokeInterceptors(packet,session,true,true);
    session.incrementClientPacketCount();
  }
 catch (  PacketRejectedException e) {
    Presence reply=new Presence();
    reply.setID(packet.getID());
    reply.setTo(session.getAddress());
    reply.setFrom(packet.getTo());
    reply.setError(PacketError.Condition.not_allowed);
    session.process(reply);
    if (e.getRejectionMessage() != null && e.getRejectionMessage().trim().length() > 0) {
      Message notification=new Message();
      notification.setTo(session.getAddress());
      notification.setFrom(packet.getTo());
      notification.setBody(e.getRejectionMessage());
      session.process(notification);
    }
  }
}
