{
  connection.deliverRawText("<compressed xmlns='http://jabber.org/protocol/compress'/>");
  XmlPullParser xpp=reader.getXPPParser();
  if (connection.getTLSStreamHandler() == null) {
    xpp.setInput(new InputStreamReader(new ZipInputStream(socket.getInputStream()),CHARSET));
  }
 else {
    xpp.setInput(new InputStreamReader(new ZipInputStream(connection.getTLSStreamHandler().getInputStream()),CHARSET));
  }
  for (int eventType=xpp.getEventType(); eventType != XmlPullParser.START_TAG; ) {
    eventType=xpp.next();
  }
  StringBuilder sb=new StringBuilder(340);
  sb.append(geStreamHeader());
  sb.append("<stream:features>");
  if (session.getStatus() != Session.STATUS_AUTHENTICATED) {
    sb.append(SASLAuthentication.getSASLMechanisms(session));
  }
  String specificFeatures=session.getAvailableStreamFeatures();
  if (specificFeatures != null) {
    sb.append(specificFeatures);
  }
  sb.append("</stream:features>");
  connection.deliverRawText(sb.toString());
}
