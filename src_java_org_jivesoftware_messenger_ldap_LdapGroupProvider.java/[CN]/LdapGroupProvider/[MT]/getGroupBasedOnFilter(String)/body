{
  ArrayList<Group> groups=new ArrayList<Group>();
  boolean debug=Log.isDebugEnabled();
  if (debug) {
    Log.debug("Trying to find all groups in the system.");
  }
  DirContext ctx=null;
  NamingEnumeration answer=null;
  try {
    ctx=manager.getContext();
    if (manager.isDebugEnabled()) {
      Log.debug("Starting LDAP search...");
      Log.debug("Using groupSearchFilter: " + searchFilter);
    }
    SearchControls searchControls=new SearchControls();
    String returnedAtts[]={manager.getNameField(),manager.getGroupDescriptionField(),manager.getGroupMemberField()};
    searchControls.setReturningAttributes(returnedAtts);
    answer=ctx.search("",searchFilter,searchControls);
    if (manager.isDebugEnabled()) {
      Log.debug("... search finished");
      Log.debug("Starting to populate groups with users.");
    }
  }
 catch (  Exception e) {
    if (manager.isDebugEnabled())     Log.debug("Error while searching for groups.",e);
    return groups;
  }
  while (answer.hasMoreElements()) {
    String name="";
    try {
      Attributes a=(((SearchResult)answer.next()).getAttributes());
      String description;
      try {
        name=((String)((a.get(manager.getNameField())).get()));
        description=((String)((a.get(manager.getGroupDescriptionField())).get()));
      }
 catch (      Exception e) {
        description="";
      }
      ArrayList<String> members=new ArrayList<String>();
      Attribute member=a.get(manager.getGroupMemberField());
      NamingEnumeration ne=member.getAll();
      while (ne.hasMore()) {
        String userName=(String)ne.next();
        if (!manager.getPosixEnabled()) {
          StringTokenizer st=new StringTokenizer(userName,",");
          Attributes attrs=ctx.getAttributes(st.nextToken(),new String[]{manager.getUsernameField()});
          Attribute a1=attrs.get(manager.getUsernameField());
          if (a1 != null)           userName=(String)a1.get();
        }
        try {
          User user=userManager.getUser(userName);
          members.add(user.getUsername());
        }
 catch (        UserNotFoundException e) {
          if (manager.isDebugEnabled())           Log.debug("User not found: " + userName);
        }
      }
      Group g=new Group(this,name,description,members,new ArrayList<String>());
      groups.add(g);
    }
 catch (    Exception e) {
      if (manager.isDebugEnabled())       Log.debug("Error while populating group, " + name + ".",e);
    }
  }
  if (manager.isDebugEnabled())   Log.debug("Finished populating group(s) with users.");
  try {
    ctx.close();
  }
 catch (  Exception e) {
  }
  return groups;
}
