{
  PacketFactoryImpl packetFactory=new PacketFactoryImpl();
  XMLInputFactory x=packetFactory.getXMLFactory();
  XMLStreamReader xpp=x.createXMLStreamReader(new StringReader(string));
  XMPPPacket packet=null;
  while (true) {
    for (int eventType=xpp.next(); eventType != XMLStreamConstants.START_ELEMENT; eventType=xpp.next()) {
      if (eventType == XMLStreamConstants.CHARACTERS) {
        if (!xpp.isWhiteSpace()) {
          throw new XMLStreamException(LocaleUtils.getLocalizedString("admin.error.packet.text"));
        }
      }
 else       if (eventType == XMLStreamConstants.END_DOCUMENT) {
        return null;
      }
    }
    String tag=xpp.getLocalName();
    if ("message".equals(tag)) {
      packet=packetFactory.getMessage(xpp);
    }
 else     if ("presence".equals(tag)) {
      packet=packetFactory.getPresence(xpp);
    }
 else     if ("iq".equals(tag)) {
      packet=packetFactory.getIQ(xpp);
    }
 else {
      throw new XMLStreamException(LocaleUtils.getLocalizedString("admin.error.packet.tag") + tag);
    }
    return packet;
  }
}
