{
  if (isEnabled()) {
    setEnabled(false);
synchronized (this) {
      Deque<StreamManager.UnackedPacket> unacknowledgedStanzas=getUnacknowledgedServerStanzas();
      if (!unacknowledgedStanzas.isEmpty()) {
        for (        StreamManager.UnackedPacket unacked : unacknowledgedStanzas) {
          if (unacked.packet instanceof Message) {
            Message m=(Message)unacked.packet;
            Element delayInformation=m.addChildElement("delay","urn:xmpp:delay");
            delayInformation.addAttribute("stamp",XMPPDateTimeFormat.format(unacked.timestamp));
            delayInformation.addAttribute("from",serverAddress.toBareJID());
          }
          router.route(unacked.packet);
        }
      }
    }
  }
}
