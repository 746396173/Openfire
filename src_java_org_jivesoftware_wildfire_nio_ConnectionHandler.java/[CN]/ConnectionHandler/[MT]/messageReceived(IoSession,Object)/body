{
  StanzaHandler handler=(StanzaHandler)session.getAttribute(HANDLER);
  int hashCode=Thread.currentThread().hashCode();
  XMPPPacketReader parser=parsers.get(hashCode);
  if (parser == null) {
    parser=new XMPPPacketReader();
    parser.setXPPFactory(factory);
    parsers.put(hashCode,parser);
  }
  try {
    handler.process((String)message,parser);
  }
 catch (  Exception e) {
    Log.error("Closing connection due to error while processing message: " + message,e);
    Connection connection=(Connection)session.getAttribute(CONNECTION);
    connection.close();
  }
}
