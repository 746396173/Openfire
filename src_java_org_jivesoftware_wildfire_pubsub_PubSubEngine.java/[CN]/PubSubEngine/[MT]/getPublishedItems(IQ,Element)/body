{
  String nodeID=itemsElement.attributeValue("node");
  Node node;
  if (nodeID == null) {
    node=service.getRootCollectionNode();
  }
 else {
    node=service.getNode(nodeID);
    if (node == null) {
      sendErrorPacket(iq,PacketError.Condition.item_not_found,null);
      return;
    }
  }
  if (node.isCollectionNode()) {
    Element pubsubError=DocumentHelper.createElement(QName.get("unsupported","http://jabber.org/protocol/pubsub#errors"));
    pubsubError.addAttribute("feature","retrieve-items");
    sendErrorPacket(iq,PacketError.Condition.feature_not_implemented,pubsubError);
    return;
  }
  JID subscriberJID=iq.getFrom();
  JID owner=new JID(subscriberJID.toBareJID());
  AccessModel accessModel=node.getAccessModel();
  if (!accessModel.canAccessItems(node,owner,subscriberJID)) {
    sendErrorPacket(iq,accessModel.getSubsriptionError(),accessModel.getSubsriptionErrorDetail());
    return;
  }
  NodeAffiliate affiliate=node.getAffiliate(owner);
  if (affiliate != null && affiliate.getAffiliation() == NodeAffiliate.Affiliation.outcast) {
    sendErrorPacket(iq,PacketError.Condition.forbidden,null);
    return;
  }
  LeafNode leafNode=(LeafNode)node;
  boolean forceToIncludePayload=false;
  List<PublishedItem> items=null;
  String max_items=itemsElement.attributeValue("max_items");
  int recentItems=0;
  if (max_items != null) {
    try {
      recentItems=Integer.parseInt(max_items);
    }
 catch (    NumberFormatException e) {
      Log.warn("Assuming that all items were requested",e);
      max_items=null;
    }
  }
  if (max_items != null) {
    items=leafNode.getPublishedItems(recentItems);
  }
 else {
    List requestedItems=itemsElement.elements("item");
    if (requestedItems.isEmpty()) {
      items=leafNode.getPublishedItems();
    }
 else {
      forceToIncludePayload=true;
      for (Iterator it=requestedItems.iterator(); it.hasNext(); ) {
        Element element=(Element)it.next();
        String itemID=element.attributeValue("id");
        PublishedItem item=leafNode.getPublishedItem(itemID);
        if (item != null) {
          items.add(item);
        }
      }
    }
  }
  leafNode.sendPublishedItems(iq,items,forceToIncludePayload);
}
