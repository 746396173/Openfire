{
  Preferences prefs=Preferences.systemNodeForPackage(this.getClass());
  byte[] rawKey=prefs.getByteArray(".key",null);
  if (rawKey == null) {
    logger.log(GatewayLevel.SECURITY,"persistencemanager.gennewkey");
    KeyGenerator kg=KeyGenerator.getInstance("AES");
    SecretKey key=kg.generateKey();
    rawKey=key.getEncoded();
    prefs.putByteArray(".key",rawKey);
  }
  SecretKeySpec key=new SecretKeySpec(rawKey,"AES");
  Cipher c=Cipher.getInstance("AES");
  c.init(Cipher.ENCRYPT_MODE,key);
  CipherOutputStream os=new CipherOutputStream(new FileOutputStream(db),c);
  ObjectOutputStream oos=new ObjectOutputStream(os);
  oos.writeObject(contactManager);
  oos.writeObject(registrar);
  oos.flush();
  oos.close();
}
