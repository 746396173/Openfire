{
  if (!(session instanceof ClientSession) && !(session instanceof IncomingServerSession)) {
    return "";
  }
  StringBuilder sb=new StringBuilder(195);
  sb.append("<mechanisms xmlns=\"urn:ietf:params:xml:ns:xmpp-sasl\">");
  if (session instanceof IncomingServerSession) {
    if (session.isSecure()) {
      boolean usingSelfSigned;
      final Certificate[] chain=session.getConnection().getLocalCertificates();
      if (chain == null || chain.length == 0) {
        usingSelfSigned=true;
      }
 else {
        try {
          usingSelfSigned=CertificateManager.isSelfSignedCertificate(SSLConfig.getKeyStore(),(X509Certificate)chain[0]);
        }
 catch (        KeyStoreException ex) {
          Log.warn("Exception occurred while trying to determine whether local certificate is self-signed. Proceeding as if it is.",ex);
          usingSelfSigned=true;
        }
catch (        IOException ex) {
          Log.warn("Exception occurred while trying to determine whether local certificate is self-signed. Proceeding as if it is.",ex);
          usingSelfSigned=true;
        }
      }
      if (!usingSelfSigned) {
        sb.append("<mechanism>EXTERNAL</mechanism>");
      }
    }
  }
 else {
    for (    String mech : getSupportedMechanisms()) {
      sb.append("<mechanism>");
      sb.append(mech);
      sb.append("</mechanism>");
    }
  }
  sb.append("</mechanisms>");
  return sb.toString();
}
