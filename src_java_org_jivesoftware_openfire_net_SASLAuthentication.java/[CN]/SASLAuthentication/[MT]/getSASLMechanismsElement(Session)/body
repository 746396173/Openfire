{
  if (!(session instanceof ClientSession) && !(session instanceof IncomingServerSession)) {
    return null;
  }
  Element mechs=DocumentHelper.createElement(new QName("mechanisms",new Namespace("","urn:ietf:params:xml:ns:xmpp-sasl")));
  if (session instanceof IncomingServerSession) {
    if (session.isSecure()) {
      boolean usingSelfSigned=true;
      try {
        X509Certificate trusted=CertificateManager.getEndEntityCertificate(((LocalSession)session).getConnection().getPeerCertificates(),SSLConfig.getKeyStore(),SSLConfig.gets2sTrustStore());
        usingSelfSigned=trusted == null;
      }
 catch (      IOException ex) {
        Log.warn("Exception occurred while trying to determine whether remote certificate is trusted. Proceeding as if it is.",ex);
        usingSelfSigned=true;
      }
      if (!usingSelfSigned) {
        Element mechanism=mechs.addElement("mechanism");
        mechanism.setText("EXTERNAL");
      }
    }
  }
 else {
    for (    String mech : getSupportedMechanisms()) {
      Element mechanism=mechs.addElement("mechanism");
      mechanism.setText(mech);
    }
  }
  return mechs;
}
