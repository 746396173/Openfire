{
  if (!(session instanceof ClientSession) && !(session instanceof IncomingServerSession)) {
    return null;
  }
  Element mechs=DocumentHelper.createElement(new QName("mechanisms",new Namespace("","urn:ietf:params:xml:ns:xmpp-sasl")));
  if (session instanceof LocalIncomingServerSession) {
    if (session.isSecure()) {
      LocalIncomingServerSession svr=(LocalIncomingServerSession)session;
      final KeyStore keyStore=SSLConfig.getStore(Purpose.SOCKETBASED_IDENTITYSTORE);
      final KeyStore trustStore=SSLConfig.getStore(Purpose.SOCKETBASED_S2S_TRUSTSTORE);
      final X509Certificate trusted=CertificateManager.getEndEntityCertificate(svr.getConnection().getPeerCertificates(),keyStore,trustStore);
      boolean haveTrustedCertificate=trusted != null;
      if (trusted != null && svr.getDefaultIdentity() != null) {
        haveTrustedCertificate=verifyCertificate(trusted,svr.getDefaultIdentity());
      }
      if (haveTrustedCertificate) {
        Element mechanism=mechs.addElement("mechanism");
        mechanism.setText("EXTERNAL");
      }
    }
  }
 else {
    for (    String mech : getSupportedMechanisms()) {
      Element mechanism=mechs.addElement("mechanism");
      mechanism.setText(mech);
    }
  }
  return mechs;
}
