{
  List<User> users=new ArrayList<User>();
  Element incomingForm=packet.getChildElement();
  boolean isDataFormQuery=(incomingForm.element(QName.get("x","jabber:x:data")) != null);
  Hashtable<String,String> searchList=extractSearchQuery(incomingForm);
  Enumeration<String> searchIter=searchList.keys();
  while (searchIter.hasMoreElements()) {
    String field=(String)searchIter.nextElement();
    String query=(String)searchList.get(field);
    Collection<User> foundUsers=new ArrayList<User>();
    if (userManager != null) {
      if (query.length() > 0 && !query.equals("jabber:iq:search")) {
        foundUsers.addAll(userManager.findUsers(new HashSet<String>(Arrays.asList((field))),query));
      }
    }
 else {
      foundUsers.addAll(findUsers(field,query));
    }
    for (    User user : foundUsers) {
      if (!users.contains(user)) {
        users.add(user);
      }
    }
  }
  if (isDataFormQuery) {
    return replyDataFormResult(users,packet);
  }
 else {
    return replyNonDataFormResult(users,packet);
  }
}
