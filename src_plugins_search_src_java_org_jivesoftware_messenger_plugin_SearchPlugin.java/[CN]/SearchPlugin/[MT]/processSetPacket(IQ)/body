{
  List<User> users=new ArrayList<User>();
  Element incomingForm=packet.getChildElement();
  boolean isDataFormQuery=(incomingForm.element(QName.get("x","jabber:x:data")) != null);
  Hashtable<String,String> searchList=extractSearchQuery(incomingForm);
  Enumeration<String> searchIter=searchList.keys();
  while (searchIter.hasMoreElements()) {
    String field=(String)searchIter.nextElement();
    String query=(String)searchList.get(field);
    Iterator foundIter=null;
    if (userManager != null) {
      if (query.length() > 0 && !query.equals("jabber:iq:search")) {
        foundIter=userManager.findUsers(new HashSet<String>(Arrays.asList((field))),query).iterator();
      }
    }
 else {
      foundIter=findUsers(field,query).iterator();
    }
    if (foundIter != null) {
      while (foundIter.hasNext()) {
        User user=(User)foundIter.next();
        if (!users.contains(user)) {
          users.add(user);
        }
      }
    }
  }
  if (isDataFormQuery) {
    return replyDataFormResult(users,packet);
  }
 else {
    return replyNonDataFormResult(users,packet);
  }
}
