{
  XDataFormImpl searchResults=new XDataFormImpl(DataForm.TYPE_RESULT);
  XFormFieldImpl field=new XFormFieldImpl("jid");
  field.setLabel("JID");
  searchResults.addReportedField(field);
  for (  String fieldName : searchFields) {
    field=new XFormFieldImpl(fieldName);
    field.setLabel(initCap(fieldName));
    searchResults.addReportedField(field);
  }
  List<User> users=new ArrayList<User>();
  Element incomingForm=packet.getChildElement();
  Element form=incomingForm.element(QName.get("x","jabber:x:data"));
  Iterator fields=form.elementIterator("field");
  while (fields.hasNext()) {
    Element searchField=(Element)fields.next();
    Iterator iter=searchField.elementIterator("value");
    while (iter.hasNext()) {
      Element queryField=(Element)iter.next();
      Iterator foundIter=null;
      if (userManager != null) {
        String query=queryField.getTextTrim();
        if (query.length() > 0) {
          foundIter=userManager.findUsers(new HashSet<String>(Arrays.asList(searchField.attributeValue("var"))),query).iterator();
        }
      }
 else {
        foundIter=findUsers(searchField.attributeValue("var"),queryField.getTextTrim()).iterator();
      }
      if (foundIter != null) {
        while (foundIter.hasNext()) {
          User user=(User)foundIter.next();
          if (!users.contains(user)) {
            users.add(user);
          }
        }
      }
    }
  }
  Iterator userIter=users.iterator();
  while (userIter.hasNext()) {
    User user=(User)userIter.next();
    String username=user.getUsername();
    ArrayList<XFormFieldImpl> items=new ArrayList<XFormFieldImpl>();
    XFormFieldImpl fieldJID=new XFormFieldImpl("jid");
    fieldJID.addValue(username + "@" + server.getServerInfo().getName());
    items.add(fieldJID);
    XFormFieldImpl fieldUsername=new XFormFieldImpl("Username");
    fieldUsername.addValue(username);
    items.add(fieldUsername);
    XFormFieldImpl fieldName=new XFormFieldImpl("Name");
    fieldName.addValue(user.getName());
    items.add(fieldName);
    XFormFieldImpl fieldEmail=new XFormFieldImpl("Email");
    fieldEmail.addValue(user.getEmail());
    items.add(fieldEmail);
    searchResults.addItemFields(items);
  }
  Element reply=DocumentHelper.createElement(QName.get("query","jabber:iq:search"));
  reply.add(searchResults.asXMLElement());
  IQ replyPacket=IQ.createResultIQ(packet);
  replyPacket.setChildElement(reply);
  return replyPacket;
}
