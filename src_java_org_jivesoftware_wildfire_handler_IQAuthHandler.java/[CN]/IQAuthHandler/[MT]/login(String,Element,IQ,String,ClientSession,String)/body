{
  String resource=iq.elementTextTrim("resource");
  if (resource != null) {
    try {
      resource=Stringprep.resourceprep(resource);
    }
 catch (    StringprepException e) {
      throw new IllegalArgumentException("Invalid resource: " + resource);
    }
  }
 else {
    IQ response=IQ.createResultIQ(packet);
    response.setChildElement(packet.getChildElement().createCopy());
    response.setError(PacketError.Condition.not_acceptable);
    return response;
  }
  username=username.toLowerCase();
  AuthToken token=null;
  if (password != null && AuthFactory.isPlainSupported()) {
    token=AuthFactory.authenticate(username,password);
  }
 else   if (digest != null && AuthFactory.isDigestSupported()) {
    token=AuthFactory.authenticate(username,session.getStreamID().toString(),digest);
  }
  if (token == null) {
    throw new UnauthorizedException();
  }
  if (sessionManager.isActiveRoute(username,resource)) {
    ClientSession oldSession;
    try {
      String domain=localServer.getServerInfo().getName();
      oldSession=sessionManager.getSession(username,domain,resource);
      oldSession.incrementConflictCount();
      int conflictLimit=sessionManager.getConflictKickLimit();
      if (conflictLimit != SessionManager.NEVER_KICK && oldSession.getConflictCount() > conflictLimit) {
        Connection conn=oldSession.getConnection();
        if (conn != null) {
          StreamError error=new StreamError(StreamError.Condition.conflict);
          conn.deliverRawText(error.toXML());
          conn.close();
        }
      }
 else {
        IQ response=IQ.createResultIQ(packet);
        response.setChildElement(packet.getChildElement().createCopy());
        response.setError(PacketError.Condition.forbidden);
        return response;
      }
    }
 catch (    Exception e) {
      Log.error("Error during login",e);
    }
  }
  session.setAuthToken(token,resource);
  packet.setFrom(session.getAddress());
  return IQ.createResultIQ(packet);
}
