{
  JID recipientJID=packet.getTo();
  if (recipientJID != null && recipientJID.getNode() == null && recipientJID.getResource() == null && serverName.equals(recipientJID.getDomain())) {
    if (packet.getElement().element("addresses") != null) {
      multicastRouter.route(packet);
      return;
    }
  }
  try {
    Presence.Type type=packet.getType();
    if (type == null || Presence.Type.unavailable == type) {
      if (recipientJID == null || recipientJID.getDomain() == null || "".equals(recipientJID.getDomain()) || (recipientJID.getNode() == null && recipientJID.getResource() == null) && serverName.equals(recipientJID.getDomain())) {
        updateHandler.process(packet);
      }
 else {
        Session session=sessionManager.getSession(packet.getFrom());
        if (session != null && session.getStatus() == Session.STATUS_CLOSED) {
          Log.warn("Rejected available presence: " + packet + " - "+ session);
          return;
        }
        for (        JID jid : routingTable.getRoutes(recipientJID)) {
          updateHandler.directedPresenceSent(packet,jid,recipientJID.toString());
          routingTable.routePacket(jid,packet);
        }
      }
    }
 else     if (Presence.Type.subscribe == type || Presence.Type.unsubscribe == type || Presence.Type.subscribed == type || Presence.Type.unsubscribed == type) {
      subscribeHandler.process(packet);
    }
 else     if (Presence.Type.probe == type) {
      if (!XMPPServer.getInstance().isLocal(recipientJID)) {
        routingTable.routePacket(recipientJID,packet);
      }
 else {
        presenceManager.handleProbe(packet);
      }
    }
 else {
      routingTable.routePacket(recipientJID,packet);
    }
  }
 catch (  Exception e) {
    Log.error(LocaleUtils.getLocalizedString("admin.error.routing"),e);
    Session session=sessionManager.getSession(packet.getFrom());
    if (session != null) {
      session.close();
    }
  }
}
