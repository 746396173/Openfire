{
  try {
    JID recipient=packet.getTo();
    if (server.matchesComponent(recipient) || server.isRemote(recipient)) {
      routingTable.routePacket(recipient,packet);
    }
 else     if (recipient == null || (recipient.getNode() == null && recipient.getResource() == null)) {
      routingTable.routePacket(packet.getFrom(),packet);
    }
 else     if (recipient.getResource() != null || !(packet instanceof Presence)) {
      routingTable.routePacket(recipient,packet);
    }
 else {
      for (      JID route : routingTable.getRoutes(recipient)) {
        routingTable.routePacket(route,packet);
      }
    }
  }
 catch (  Exception e) {
    Log.error(LocaleUtils.getLocalizedString("admin.error.deliver") + "\n" + packet.toString(),e);
  }
}
