{
  XmlPullParser xpp=reader.getXPPParser();
  Session session;
  String domain=xpp.getAttributeValue("","to");
  Writer writer=connection.getWriter();
  StringBuffer sb=new StringBuffer();
  sb.append("<?xml version='1.0' encoding='");
  sb.append(CHARSET);
  sb.append("'?>");
  sb.append("<stream:stream ");
  sb.append("xmlns:stream=\"http://etherx.jabber.org/streams\" ");
  sb.append("xmlns=\"jabber:component:accept\" from=\"");
  sb.append(domain);
  sb.append("\">");
  if (domain == null) {
    sb.append("<stream:error>");
    sb.append("<bad-format xmlns=\"urn:ietf:params:xml:ns:xmpp-streams\"/>");
    sb.append("</stream:error>");
    sb.append("</stream:stream>");
    writer.write(sb.toString());
    writer.flush();
    connection.close();
    return null;
  }
  String secretKey=JiveGlobals.getProperty("component.external.secretKey");
  if (secretKey == null) {
    Log.error("Setup for external components is incomplete. Property " + "component.external.secretKey  does not exist.");
    sb.append("<stream:error>");
    sb.append("<internal-server-error xmlns=\"urn:ietf:params:xml:ns:xmpp-streams\"/>");
    sb.append("</stream:error>");
    sb.append("</stream:stream>");
    writer.write(sb.toString());
    writer.flush();
    connection.close();
    return null;
  }
  if (ComponentManager.getInstance().getComponent(domain) != null) {
    sb.append("<stream:error>");
    sb.append("<conflict xmlns=\"urn:ietf:params:xml:ns:xmpp-streams\"/>");
    sb.append("</stream:error>");
    sb.append("</stream:stream>");
    writer.write(sb.toString());
    writer.flush();
    connection.close();
    return null;
  }
  session=SessionManager.getInstance().createComponentSession(connection);
  session.setAddress(new JID(null,domain + "." + XMPPServer.getInstance().getServerInfo().getName(),null));
  try {
    sb=new StringBuffer();
    sb.append("<?xml version='1.0' encoding='");
    sb.append(CHARSET);
    sb.append("'?>");
    sb.append("<stream:stream ");
    sb.append("xmlns:stream=\"http://etherx.jabber.org/streams\" ");
    sb.append("xmlns=\"jabber:component:accept\" from=\"");
    sb.append(domain);
    sb.append("\" id=\"");
    sb.append(session.getStreamID().toString());
    sb.append("\">");
    writer.write(sb.toString());
    writer.flush();
    Element doc=reader.parseDocument().getRootElement();
    String digest="handshake".equals(doc.getName()) ? doc.getStringValue() : "";
    String anticipatedDigest=AuthFactory.createDigest(session.getStreamID().getID(),secretKey);
    if (!anticipatedDigest.equalsIgnoreCase(digest)) {
      sb=new StringBuffer();
      sb.append("<stream:error>");
      sb.append("<not-authorized xmlns=\"urn:ietf:params:xml:ns:xmpp-streams\"/>");
      sb.append("</stream:error>");
      sb.append("</stream:stream>");
      writer.write(sb.toString());
      writer.flush();
      connection.close();
      return null;
    }
 else {
      ExternalComponent component=((ComponentSession)session).getExternalComponent();
      ComponentManager.getInstance().addComponent(domain,component);
      component.setServiceName(domain);
      session.setStatus(Session.STATUS_AUTHENTICATED);
      writer.write("<handshake></handshake>");
      writer.flush();
      return session;
    }
  }
 catch (  Exception e) {
    Log.error("An error occured while creating a ComponentSession",e);
    connection.close();
    return null;
  }
}
