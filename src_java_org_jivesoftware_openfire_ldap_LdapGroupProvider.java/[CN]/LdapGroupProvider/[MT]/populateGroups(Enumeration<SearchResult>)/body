{
  if (manager.isDebugEnabled()) {
    Log.debug("LdapGroupProvider: Starting to populate groups with users.");
  }
  int pageSize=JiveGlobals.getXMLProperty("ldap.pagedResultsSize",-1);
  LdapContext ctx=null;
  LdapContext ctx2=null;
  try {
    TreeMap<String,Group> groups=new TreeMap<String,Group>();
    ctx=manager.getContext(baseDN);
    List<Control> tmpRequestControls=new ArrayList<Control>();
    if (pageSize > -1) {
      tmpRequestControls.add(new PagedResultsControl(pageSize,Control.NONCRITICAL));
    }
    Control[] requestControls=tmpRequestControls.toArray(new Control[tmpRequestControls.size()]);
    ctx.setRequestControls(requestControls);
    byte[] cookie=null;
    do {
      while (answer.hasMoreElements()) {
        String name="";
        try {
          Group group=processGroup(ctx,answer.nextElement().getAttributes());
          name=group.getName();
          groups.put(name,group);
        }
 catch (        Exception e) {
          Log.error("LdapGroupProvider: Error while populating group, " + name + ".",e);
        }
      }
      Control[] controls=ctx.getResponseControls();
      if (controls != null) {
        for (        Control control : controls) {
          if (control instanceof PagedResultsResponseControl) {
            PagedResultsResponseControl prrc=(PagedResultsResponseControl)control;
            cookie=prrc.getCookie();
            ctx.setRequestControls(new Control[]{new PagedResultsControl(pageSize,cookie,Control.CRITICAL)});
            break;
          }
        }
      }
    }
 while (cookie != null);
    if (alternateBaseDN != null) {
      ctx2=manager.getContext(alternateBaseDN);
      ctx2.setRequestControls(requestControls);
      cookie=null;
      do {
        while (answer.hasMoreElements()) {
          String name="";
          try {
            Group group=processGroup(ctx,answer.nextElement().getAttributes());
            name=group.getName();
            groups.put(name,group);
          }
 catch (          Exception e) {
            Log.error("LdapGroupProvider: Error while populating group, " + name + ".",e);
          }
        }
        Control[] controls=ctx.getResponseControls();
        if (controls != null) {
          for (          Control control : controls) {
            if (control instanceof PagedResultsResponseControl) {
              PagedResultsResponseControl prrc=(PagedResultsResponseControl)control;
              cookie=prrc.getCookie();
              ctx.setRequestControls(new Control[]{new PagedResultsControl(pageSize,cookie,Control.CRITICAL)});
              break;
            }
          }
        }
      }
 while (cookie != null);
    }
    if (manager.isDebugEnabled()) {
      Log.debug("LdapGroupProvider: Finished populating group(s) with users.");
    }
    return groups.values();
  }
 catch (  Exception e) {
    Log.error("Exception while attempting to populate groups and members: ",e);
    return new ArrayList<Group>();
  }
 finally {
    try {
      if (ctx != null) {
        ctx.close();
      }
      if (ctx2 != null) {
        ctx2.close();
      }
    }
 catch (    Exception e) {
    }
  }
}
