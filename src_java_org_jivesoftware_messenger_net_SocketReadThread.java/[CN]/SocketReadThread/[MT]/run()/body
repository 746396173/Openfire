{
  try {
    factory=XmlPullParserFactory.newInstance();
    reader=new XPPPacketReader();
    reader.setXPPFactory(factory);
    reader.getXPPParser().setInput(new InputStreamReader(sock.getInputStream(),charset));
    createSession();
    if (session != null) {
      readStream();
    }
  }
 catch (  EOFException eof) {
  }
catch (  XmlPullParserException ie) {
    if (clearSignout == false) {
      if (session != null && session.getStatus() == Session.STATUS_AUTHENTICATED) {
        Presence presence=session.getPresence();
        if (presence != null) {
          Presence packet=presence.createCopy();
          packet.setType(Presence.Type.unavailable);
          packet.setFrom(session.getAddress());
          CompositePacket<Presence> compPacket=new CompositePacket<Presence>(packet,session);
          router.route(compPacket);
          clearSignout=true;
        }
      }
    }
  }
catch (  Exception e) {
    if (session != null) {
      Log.warn(LocaleUtils.getLocalizedString("admin.error.stream"),e);
    }
  }
 finally {
    if (session != null) {
      Log.debug("Logging off " + session.getAddress() + " on "+ connection);
      try {
        sleep(3000);
        session.getConnection().close();
      }
 catch (      Exception e) {
        Log.warn(LocaleUtils.getLocalizedString("admin.error.connection") + "\n" + sock.toString());
      }
    }
 else {
      Log.error(LocaleUtils.getLocalizedString("admin.error.connection") + "\n" + sock.toString());
    }
  }
}
