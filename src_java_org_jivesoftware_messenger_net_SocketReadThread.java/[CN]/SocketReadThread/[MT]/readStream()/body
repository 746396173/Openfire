{
  while (true) {
    Document document=reader.parseDocument();
    if (document != null) {
      Element doc=document.getRootElement();
      String tag=doc.getName();
      if ("message".equals(tag)) {
        Message packet=new Message(doc);
        packet.setFrom(session.getAddress());
        auditor.audit(packet);
        router.route(packet);
        session.incrementClientPacketCount();
      }
 else       if ("presence".equals(tag)) {
        Presence packet=new Presence(doc);
        packet.setFrom(session.getAddress());
        auditor.audit(packet);
        router.route(packet);
        session.incrementClientPacketCount();
        clearSignout=(Presence.Type.unavailable == packet.getType() ? true : false);
      }
 else       if ("iq".equals(tag)) {
        IQ packet=getIQ(doc);
        packet.setFrom(session.getAddress());
        auditor.audit(packet);
        router.route(packet);
        session.incrementClientPacketCount();
      }
 else {
        throw new XmlPullParserException(LocaleUtils.getLocalizedString("admin.error.packet.tag") + tag);
      }
    }
  }
}
