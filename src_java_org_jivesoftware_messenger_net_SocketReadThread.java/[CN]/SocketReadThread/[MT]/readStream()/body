{
  while (true) {
    Element doc=reader.parseDocument().getRootElement();
    if (doc == null) {
      return;
    }
    String tag=doc.getName();
    if ("message".equals(tag)) {
      Message packet=new Message(doc);
      packet.setFrom(session.getAddress());
      auditor.audit(packet,session);
      router.route(packet);
      session.incrementClientPacketCount();
    }
 else     if ("presence".equals(tag)) {
      Presence packet=new Presence(doc);
      packet.setFrom(session.getAddress());
      auditor.audit(packet,session);
      router.route(packet);
      session.incrementClientPacketCount();
      clearSignout=(Presence.Type.unavailable == packet.getType() ? true : false);
    }
 else     if ("iq".equals(tag)) {
      IQ packet=getIQ(doc);
      packet.setFrom(session.getAddress());
      auditor.audit(packet,session);
      router.route(packet);
      session.incrementClientPacketCount();
    }
 else {
      throw new XmlPullParserException(LocaleUtils.getLocalizedString("admin.error.packet.tag") + tag);
    }
  }
}
