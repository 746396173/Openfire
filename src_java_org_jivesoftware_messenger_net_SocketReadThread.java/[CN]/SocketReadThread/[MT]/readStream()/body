{
  while (true) {
    Element doc=reader.parseDocument().getRootElement();
    if (doc == null) {
      return;
    }
    String tag=doc.getName();
    if ("message".equals(tag)) {
      Message packet=null;
      try {
        packet=new Message(doc);
      }
 catch (      IllegalArgumentException e) {
        Message reply=new Message();
        reply.setID(doc.attributeValue("id"));
        reply.setTo(session.getAddress());
        reply.getElement().addAttribute("from",doc.attributeValue("to"));
        reply.setError(PacketError.Condition.jid_malformed);
        session.process(reply);
        continue;
      }
      packet.setFrom(session.getAddress());
      try {
        InterceptorManager.getInstance().invokeInterceptors(packet,session,true,false);
        router.route(packet);
        InterceptorManager.getInstance().invokeInterceptors(packet,session,true,true);
        session.incrementClientPacketCount();
      }
 catch (      PacketRejectedException e) {
        Message reply=new Message();
        reply.setID(packet.getID());
        reply.setTo(session.getAddress());
        reply.setFrom(packet.getTo());
        reply.setError(PacketError.Condition.not_allowed);
        session.process(reply);
      }
    }
 else     if ("presence".equals(tag)) {
      Presence packet=null;
      try {
        packet=new Presence(doc);
      }
 catch (      IllegalArgumentException e) {
        Presence reply=new Presence();
        reply.setID(doc.attributeValue("id"));
        reply.setTo(session.getAddress());
        reply.getElement().addAttribute("from",doc.attributeValue("to"));
        reply.setError(PacketError.Condition.jid_malformed);
        session.process(reply);
        continue;
      }
      packet.setFrom(session.getAddress());
      try {
        InterceptorManager.getInstance().invokeInterceptors(packet,session,true,false);
        router.route(packet);
        InterceptorManager.getInstance().invokeInterceptors(packet,session,true,true);
        session.incrementClientPacketCount();
        clearSignout=(Presence.Type.unavailable == packet.getType() ? true : false);
      }
 catch (      PacketRejectedException e) {
        Presence reply=new Presence();
        reply.setID(packet.getID());
        reply.setTo(session.getAddress());
        reply.setFrom(packet.getTo());
        reply.setError(PacketError.Condition.not_allowed);
        session.process(reply);
      }
    }
 else     if ("iq".equals(tag)) {
      IQ packet=null;
      try {
        packet=getIQ(doc);
      }
 catch (      IllegalArgumentException e) {
        IQ reply=new IQ();
        if (!doc.elements().isEmpty()) {
          reply.setChildElement(((Element)doc.elements().get(0)).createCopy());
        }
        reply.setID(doc.attributeValue("id"));
        reply.setTo(session.getAddress());
        if (doc.attributeValue("to") != null) {
          reply.getElement().addAttribute("from",doc.attributeValue("to"));
        }
        reply.setError(PacketError.Condition.jid_malformed);
        session.process(reply);
        continue;
      }
      packet.setFrom(session.getAddress());
      try {
        InterceptorManager.getInstance().invokeInterceptors(packet,session,true,false);
        router.route(packet);
        InterceptorManager.getInstance().invokeInterceptors(packet,session,true,true);
        session.incrementClientPacketCount();
      }
 catch (      PacketRejectedException e) {
        IQ reply=new IQ();
        reply.setChildElement(packet.getChildElement().createCopy());
        reply.setID(packet.getID());
        reply.setTo(session.getAddress());
        reply.setFrom(packet.getTo());
        reply.setError(PacketError.Condition.not_allowed);
        session.process(reply);
      }
    }
 else {
      throw new XmlPullParserException(LocaleUtils.getLocalizedString("admin.error.packet.tag") + tag);
    }
  }
}
