{
  IQ result=null;
  try {
    IQ.Type type=packet.getType();
    if (type.equals(IQ.Type.set)) {
      result=IQ.createResultIQ(packet);
      User user=userManager.getUser(packet.getFrom().getNode());
      Element vcard=packet.getChildElement();
      if (vcard != null) {
        try {
          VCardManager.getInstance().setVCard(user.getUsername(),vcard);
        }
 catch (        Exception e) {
          Log.error(e);
          result.setError(PacketError.Condition.internal_server_error);
        }
      }
    }
 else     if (type.equals(IQ.Type.get)) {
      JID recipient=packet.getTo();
      if (recipient == null) {
        recipient=packet.getFrom();
      }
      result=IQ.createResultIQ(packet);
      Element vcard=DocumentHelper.createElement(QName.get("vCard","vcard-temp"));
      result.setChildElement(vcard);
      if (recipient != null && userManager.isRegisteredUser(recipient.getNode())) {
        User user=userManager.getUser(recipient.getNode());
        VCardManager vManager=VCardManager.getInstance();
        Element userVCard=vManager.getVCard(user.getUsername());
        if (userVCard != null) {
          result.setChildElement(userVCard);
        }
      }
    }
 else {
      result=IQ.createResultIQ(packet);
      result.setChildElement(packet.getChildElement().createCopy());
      result.setError(PacketError.Condition.not_acceptable);
    }
  }
 catch (  UserNotFoundException e) {
    result=IQ.createResultIQ(packet);
    result.setChildElement(packet.getChildElement().createCopy());
    result.setError(PacketError.Condition.item_not_found);
  }
  return result;
}
