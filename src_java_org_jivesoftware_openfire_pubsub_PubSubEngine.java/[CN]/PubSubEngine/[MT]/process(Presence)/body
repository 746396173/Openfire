{
  if (presence.isAvailable()) {
    JID subscriber=presence.getFrom();
    Map<String,String> fullPresences=barePresences.get(subscriber.toBareJID());
    if (fullPresences == null) {
synchronized (subscriber.toBareJID().intern()) {
        fullPresences=barePresences.get(subscriber.toBareJID());
        if (fullPresences == null) {
          fullPresences=new ConcurrentHashMap<String,String>();
          barePresences.put(subscriber.toBareJID(),fullPresences);
        }
      }
    }
    Presence.Show show=presence.getShow();
    fullPresences.put(subscriber.toString(),show == null ? "online" : show.name());
  }
 else   if (presence.getType() == Presence.Type.unavailable) {
    JID subscriber=presence.getFrom();
    Map<String,String> fullPresences=barePresences.get(subscriber.toBareJID());
    if (fullPresences != null) {
      fullPresences.remove(subscriber.toString());
      if (fullPresences.isEmpty()) {
        barePresences.remove(subscriber.toBareJID());
      }
    }
  }
}
