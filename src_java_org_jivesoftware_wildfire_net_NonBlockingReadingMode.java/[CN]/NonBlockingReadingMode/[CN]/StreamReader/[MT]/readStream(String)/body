{
  if (msg.trim().startsWith(STREAM_START)) {
    if (!sessionCreated) {
      sessionCreated=true;
      socketReader.reader.getXPPParser().setInput(new StringReader(msg + ((msg.indexOf("</stream:stream") == -1) ? "</stream:stream>" : "")));
      socketReader.createSession();
    }
 else     if (awaytingSasl) {
      awaytingSasl=false;
      saslSuccessful();
    }
 else     if (awaitingForCompleteCompression) {
      awaitingForCompleteCompression=false;
      compressionSuccessful();
    }
    return;
  }
  Element doc=socketReader.reader.parseDocument(msg).getRootElement();
  if (doc == null) {
    return;
  }
  String tag=doc.getName();
  if ("starttls".equals(tag)) {
    if (negotiateTLS()) {
      tlsNegotiated();
    }
 else {
      socketReader.open=false;
      socketReader.session=null;
    }
  }
 else   if ("auth".equals(tag)) {
    if (authenticateClient(doc)) {
      awaytingSasl=true;
    }
 else     if (socketReader.connection.isClosed()) {
      socketReader.open=false;
      socketReader.session=null;
    }
  }
 else   if ("compress".equals(tag)) {
    if (compressClient(doc)) {
      awaitingForCompleteCompression=true;
    }
  }
 else {
    socketReader.process(doc);
  }
}
