{
  Connection con=null;
  PreparedStatement pstmt=null;
  ResultSet rs=null;
  Map<Long,LocalMUCRoom> rooms=new HashMap<Long,LocalMUCRoom>();
  try {
    Long serviceID=XMPPServer.getInstance().getMultiUserChatManager().getMultiUserChatServiceID(chatserver.getServiceName());
    con=DbConnectionManager.getConnection();
    pstmt=con.prepareStatement(LOAD_ALL_ROOMS);
    pstmt.setLong(1,serviceID);
    pstmt.setString(2,StringUtils.dateToMillis(emptyDate));
    rs=pstmt.executeQuery();
    while (rs.next()) {
      LocalMUCRoom room=new LocalMUCRoom(chatserver,rs.getString(4),packetRouter);
      room.setID(rs.getLong(1));
      room.setCreationDate(new Date(Long.parseLong(rs.getString(2).trim())));
      room.setModificationDate(new Date(Long.parseLong(rs.getString(3).trim())));
      room.setNaturalLanguageName(rs.getString(5));
      room.setDescription(rs.getString(6));
      room.setLockedDate(new Date(Long.parseLong(rs.getString(7).trim())));
      if (rs.getString(8) != null) {
        room.setEmptyDate(new Date(Long.parseLong(rs.getString(8).trim())));
      }
 else {
        room.setEmptyDate(null);
      }
      room.setCanOccupantsChangeSubject(rs.getInt(9) == 1);
      room.setMaxUsers(rs.getInt(10));
      room.setPublicRoom(rs.getInt(11) == 1);
      room.setModerated(rs.getInt(12) == 1);
      room.setMembersOnly(rs.getInt(13) == 1);
      room.setCanOccupantsInvite(rs.getInt(14) == 1);
      room.setPassword(rs.getString(15));
      room.setCanAnyoneDiscoverJID(rs.getInt(16) == 1);
      room.setLogEnabled(rs.getInt(17) == 1);
      room.setSubject(rs.getString(18));
      List<String> rolesToBroadcast=new ArrayList<String>();
      String roles=Integer.toBinaryString(rs.getInt(19));
      if (roles.charAt(0) == '1') {
        rolesToBroadcast.add("moderator");
      }
      if (roles.length() > 1 && roles.charAt(1) == '1') {
        rolesToBroadcast.add("participant");
      }
      if (roles.length() > 2 && roles.charAt(2) == '1') {
        rolesToBroadcast.add("visitor");
      }
      room.setRolesToBroadcastPresence(rolesToBroadcast);
      room.setLoginRestrictedToNickname(rs.getInt(20) == 1);
      room.setChangeNickname(rs.getInt(21) == 1);
      room.setRegistrationEnabled(rs.getInt(22) == 1);
      room.setPersistent(true);
      rooms.put(room.getID(),room);
    }
    DbConnectionManager.fastcloseStmt(rs,pstmt);
    pstmt=con.prepareStatement(LOAD_ALL_HISTORY);
    long from=System.currentTimeMillis() - (86400000 * 2);
    pstmt.setLong(1,serviceID);
    pstmt.setString(2,StringUtils.dateToMillis(new Date(from)));
    rs=pstmt.executeQuery();
    while (rs.next()) {
      LocalMUCRoom room=rooms.get(rs.getLong(1));
      if (room == null) {
        continue;
      }
      String senderJID=rs.getString(2);
      String nickname=rs.getString(3);
      Date sentDate=new Date(Long.parseLong(rs.getString(4).trim()));
      String subject=rs.getString(5);
      String body=rs.getString(6);
      try {
        if (room.isLogEnabled()) {
          room.getRoomHistory().addOldMessage(senderJID,nickname,sentDate,subject,body);
        }
      }
 catch (      Exception e) {
        Log.error(e.getMessage(),e);
      }
    }
    DbConnectionManager.fastcloseStmt(rs,pstmt);
    for (    MUCRoom loadedRoom : rooms.values()) {
      if (!loadedRoom.getRoomHistory().hasChangedSubject() && loadedRoom.getSubject() != null && loadedRoom.getSubject().length() > 0) {
        loadedRoom.getRoomHistory().addOldMessage(loadedRoom.getRole().getRoleAddress().toString(),null,loadedRoom.getModificationDate(),loadedRoom.getSubject(),null);
      }
    }
    pstmt=con.prepareStatement(LOAD_ALL_AFFILIATIONS);
    pstmt.setLong(1,serviceID);
    rs=pstmt.executeQuery();
    while (rs.next()) {
      long roomID=rs.getLong(1);
      JID jid=new JID(rs.getString(2));
      MUCRole.Affiliation affiliation=MUCRole.Affiliation.valueOf(rs.getInt(3));
      LocalMUCRoom room=rooms.get(roomID);
      if (room == null) {
        continue;
      }
      try {
switch (affiliation) {
case owner:
          room.addOwner(jid,room.getRole());
        break;
case admin:
      room.addAdmin(jid,room.getRole());
    break;
case outcast:
  room.addOutcast(jid,null,room.getRole());
break;
default :
Log.error("Unkown affiliation value " + affiliation + " for user "+ jid+ " in persistent room "+ room.getID());
}
}
 catch (Exception e) {
Log.error(e.getMessage(),e);
}
}
DbConnectionManager.fastcloseStmt(rs,pstmt);
pstmt=con.prepareStatement(LOAD_ALL_MEMBERS);
pstmt.setLong(1,serviceID);
rs=pstmt.executeQuery();
while (rs.next()) {
LocalMUCRoom room=rooms.get(rs.getLong(1));
if (room == null) {
continue;
}
try {
room.addMember(new JID(rs.getString(2)),rs.getString(3),room.getRole());
}
 catch (Exception e) {
Log.error(e.getMessage(),e);
}
}
}
 catch (SQLException sqle) {
Log.error(sqle.getMessage(),sqle);
}
 finally {
DbConnectionManager.closeConnection(rs,pstmt,con);
}
for (MUCRoom room : rooms.values()) {
room.setSavedToDB(true);
if (room.getEmptyDate() == null) {
room.setEmptyDate(new Date());
}
}
return rooms.values();
}
