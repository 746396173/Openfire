{
  try {
    JID recipient=packet.getTo();
    if (recipient != null && !recipient.getDomain().contains(serverName)) {
      try {
        routingTable.getRoute(recipient).process(packet);
      }
 catch (      NoSuchRouteException e) {
        handleUnprocessedPacket(packet);
      }
      return;
    }
    if (recipient == null || (recipient.getNode() == null && recipient.getResource() == null)) {
      Session senderSession=sessionManager.getSession(packet.getFrom());
      if (senderSession != null && !senderSession.getConnection().isClosed()) {
        senderSession.getConnection().deliver(packet);
      }
 else {
        dropPacket(packet);
      }
    }
 else {
      Session session=sessionManager.getBestRoute(recipient);
      if (session == null) {
        handleUnprocessedPacket(packet);
      }
 else {
        try {
          session.getConnection().deliver(packet);
        }
 catch (        Exception e) {
        }
      }
    }
  }
 catch (  Exception e) {
    Log.error(LocaleUtils.getLocalizedString("admin.error.deliver") + "\n" + packet.toString(),e);
  }
}
