{
  if (e.getNewState() == ClientFlapConn.STATE_CONNECTED) {
    getFlapProcessor().sendFlap(new LoginFlapCmd());
    request(new KeyRequest(oscarSession.getRegistration().getUsername()));
  }
 else   if (e.getNewState() == ClientFlapConn.STATE_FAILED) {
    Message m=new Message();
    m.setType(Message.Type.error);
    m.setFrom(this.getMainSession().getTransport().getJID());
    m.setTo(this.getMainSession().getJIDWithHighestPriority());
    m.setBody("Connection failed: " + e.getReason());
    this.getMainSession().getTransport().sendPacket(m);
    this.getMainSession().logOut();
  }
 else   if (e.getNewState() == ClientFlapConn.STATE_NOT_CONNECTED) {
    if (!loggedin) {
      Message m=new Message();
      m.setType(Message.Type.error);
      m.setFrom(this.getMainSession().getTransport().getJID());
      m.setTo(this.getMainSession().getJIDWithHighestPriority());
      m.setBody("Connection lost: " + e.getReason());
      this.getMainSession().getTransport().sendPacket(m);
      this.getMainSession().logOut();
    }
  }
}
