{
  if (connection.getTlsPolicy() == Connection.TLSPolicy.required && !connection.isSecure()) {
    closeNeverSecuredConnection();
    return false;
  }
  boolean isComplete=false;
  boolean success=false;
  while (!isComplete) {
    SASLAuthentication.Status status=SASLAuthentication.handle(session,doc);
    if (status == SASLAuthentication.Status.needResponse) {
      doc=reader.parseDocument().getRootElement();
      if (doc == null) {
        isComplete=true;
      }
    }
 else {
      isComplete=true;
      success=status == SASLAuthentication.Status.authenticated;
    }
  }
  return success;
}
