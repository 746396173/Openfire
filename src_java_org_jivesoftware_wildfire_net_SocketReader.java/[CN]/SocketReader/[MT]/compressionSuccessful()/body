{
  XmlPullParser xpp=reader.getXPPParser();
  if (connection.getTLSStreamHandler() == null) {
    ZInputStream in=new ZInputStream(socket.getInputStream());
    in.setFlushMode(JZlib.Z_PARTIAL_FLUSH);
    xpp.setInput(new InputStreamReader(in,CHARSET));
  }
 else {
    ZInputStream in=new ZInputStream(connection.getTLSStreamHandler().getInputStream());
    in.setFlushMode(JZlib.Z_PARTIAL_FLUSH);
    xpp.setInput(new InputStreamReader(in,CHARSET));
  }
  for (int eventType=xpp.getEventType(); eventType != XmlPullParser.START_TAG; ) {
    eventType=xpp.next();
  }
  StringBuilder sb=new StringBuilder(340);
  sb.append(geStreamHeader());
  sb.append("<stream:features>");
  if (session.getStatus() != Session.STATUS_AUTHENTICATED) {
    sb.append(SASLAuthentication.getSASLMechanisms(session));
  }
  String specificFeatures=session.getAvailableStreamFeatures();
  if (specificFeatures != null) {
    sb.append(specificFeatures);
  }
  sb.append("</stream:features>");
  connection.deliverRawText(sb.toString());
}
