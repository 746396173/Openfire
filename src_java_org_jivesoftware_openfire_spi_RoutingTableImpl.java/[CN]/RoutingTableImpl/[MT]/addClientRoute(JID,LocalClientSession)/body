{
  boolean added;
  boolean available=destination.getPresence().isAvailable();
  localRoutingTable.addRoute(route.toString(),destination);
  if (destination.getAuthToken().isAnonymous()) {
    added=anonymousUsersCache.put(route.toString(),new ClientRoute(server.getNodeID(),available)) == null;
    if (route.getResource() != null && (!available || added)) {
      Lock lock=CacheFactory.getLock(route.toBareJID(),usersSessions);
      try {
        lock.lock();
        usersSessions.put(route.toBareJID(),Arrays.asList(route.toString()));
      }
  finally {
        lock.unlock();
      }
    }
  }
 else {
    added=usersCache.put(route.toString(),new ClientRoute(server.getNodeID(),available)) == null;
    if (route.getResource() != null && (!available || added)) {
      Lock lock=CacheFactory.getLock(route.toBareJID(),usersSessions);
      try {
        lock.lock();
        Collection<String> jids=usersSessions.get(route.toBareJID());
        if (jids == null) {
          if (ClusterManager.isClusteringStarted()) {
            jids=new HashSet<String>();
          }
 else {
            jids=new ConcurrentHashSet<String>();
          }
        }
        jids.add(route.toString());
        usersSessions.put(route.toBareJID(),jids);
      }
  finally {
        lock.unlock();
      }
    }
  }
  return added;
}
