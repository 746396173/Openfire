{
  boolean available=destination.getPresence().isAvailable();
  boolean added=localRoutingTable.addRoute(route.toString(),destination);
  if (destination.getAuthToken().isAnonymous()) {
    anonymousUsersCache.put(route.toString(),new ClientRoute(server.getNodeID(),available));
    if (route.getResource() != null && !available) {
      Lock lock=LockManager.getLock(route.toBareJID());
      try {
        lock.lock();
        usersSessions.put(route.toBareJID(),Arrays.asList(route.toString()));
      }
  finally {
        lock.unlock();
      }
    }
  }
 else {
    usersCache.put(route.toString(),new ClientRoute(server.getNodeID(),available));
    if (route.getResource() != null && !available) {
      Lock lock=LockManager.getLock(route.toBareJID());
      try {
        lock.lock();
        Collection<String> jids=usersSessions.get(route.toBareJID());
        if (jids == null) {
          if (ClusterManager.isClusteringStarted()) {
            jids=new HashSet<String>();
          }
 else {
            jids=new ConcurrentHashSet<String>();
          }
        }
        jids.add(route.toString());
        usersSessions.put(route.toBareJID(),jids);
      }
  finally {
        lock.unlock();
      }
    }
  }
  return added;
}
