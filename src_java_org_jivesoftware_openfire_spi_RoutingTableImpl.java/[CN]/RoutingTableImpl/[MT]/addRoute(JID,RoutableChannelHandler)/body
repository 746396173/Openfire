{
  String nodeJID=node.getNode() == null ? "" : node.getNode();
  String resourceJID=node.getResource() == null ? "" : node.getResource();
  if (destination instanceof ClientSession) {
    Object nameRoutes=routes.get(node.getDomain());
    if (nameRoutes == null) {
synchronized (node.getDomain().intern()) {
        nameRoutes=routes.get(node.getDomain());
        if (nameRoutes == null) {
          nameRoutes=new ConcurrentHashMap();
          routes.put(node.getDomain(),nameRoutes);
        }
      }
    }
    Object resourceRoutes=((Map)nameRoutes).get(nodeJID);
    if (resourceRoutes == null) {
synchronized (nodeJID.intern()) {
        resourceRoutes=((Map)nameRoutes).get(nodeJID);
        if (resourceRoutes == null) {
          resourceRoutes=new ConcurrentHashMap();
          ((Map)nameRoutes).put(nodeJID,resourceRoutes);
        }
      }
    }
    ((Map)resourceRoutes).put(resourceJID,destination);
  }
 else {
    routes.put(node.getDomain(),destination);
  }
}
