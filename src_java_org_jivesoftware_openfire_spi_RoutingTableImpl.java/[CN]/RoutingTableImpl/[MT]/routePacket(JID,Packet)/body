{
  boolean routed=false;
  JID address=packet.getTo();
  if (address == null) {
    throw new PacketException("To address cannot be null.");
  }
  if (serverName.equals(jid.getDomain())) {
    boolean onlyAvailable=true;
    if (packet instanceof IQ) {
      onlyAvailable=packet.getFrom() != null;
    }
 else     if (packet instanceof Message) {
      onlyAvailable=true;
    }
 else     if (packet instanceof Presence) {
      onlyAvailable=true;
    }
    ClientRoute clientRoute=usersCache.get(jid.toString());
    if (clientRoute == null) {
      clientRoute=anonymousUsersCache.get(jid.toString());
    }
    if (clientRoute != null) {
      if (onlyAvailable && !clientRoute.isAvailable()) {
        routed=false;
      }
 else {
        if (clientRoute.getNodeID() == server.getNodeID()) {
          localRoutingTable.getRoute(jid.toString()).process(packet);
          routed=true;
        }
 else {
          if (remotePacketRouter != null) {
            routed=remotePacketRouter.routePacket(clientRoute.getNodeID(),jid,packet);
          }
        }
      }
    }
  }
 else   if (jid.getDomain().contains(serverName)) {
    byte[] nodeID=componentsCache.get(jid.getDomain());
    if (nodeID != null) {
      if (nodeID == server.getNodeID()) {
        localRoutingTable.getRoute(jid.getDomain()).process(packet);
        routed=true;
      }
 else {
        if (remotePacketRouter != null) {
          routed=remotePacketRouter.routePacket(nodeID,jid,packet);
        }
      }
    }
  }
 else {
    byte[] nodeID=serversCache.get(jid.getDomain());
    if (nodeID != null) {
      if (nodeID == server.getNodeID()) {
        localRoutingTable.getRoute(jid.getDomain()).process(packet);
        routed=true;
      }
 else {
        if (remotePacketRouter != null) {
          routed=remotePacketRouter.routePacket(nodeID,jid,packet);
        }
      }
    }
 else {
      OutgoingSessionPromise.getInstance().process(packet);
      routed=true;
    }
  }
  if (!routed) {
    if (Log.isDebugEnabled()) {
      Log.debug("Failed to route packet to JID: " + jid + " packet: "+ packet);
    }
    if (packet instanceof IQ) {
      iqRouter.routingFailed(packet);
    }
 else     if (packet instanceof Message) {
      messageRouter.routingFailed(packet);
    }
 else     if (packet instanceof Presence) {
      presenceRouter.routingFailed(packet);
    }
  }
}
