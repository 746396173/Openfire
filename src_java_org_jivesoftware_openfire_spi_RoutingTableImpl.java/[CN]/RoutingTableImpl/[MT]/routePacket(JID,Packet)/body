{
  boolean routed=false;
  JID address=packet.getTo();
  if (address == null) {
    throw new PacketException("To address cannot be null.");
  }
  if (serverName.equals(jid.getDomain())) {
    if (jid.getResource() == null) {
      if (packet instanceof Message) {
        routed=routeToBareJID(jid,(Message)packet);
      }
 else {
        throw new PacketException("Cannot route packet of type IQ or Presence to bare JID: " + packet);
      }
    }
 else {
      boolean onlyAvailable=true;
      if (packet instanceof IQ) {
        onlyAvailable=packet.getFrom() != null && !serverName.equals(packet.getFrom().toString());
      }
 else       if (packet instanceof Message) {
        onlyAvailable=packet.getFrom() == null || !serverName.equals(packet.getFrom().toString());
      }
 else       if (packet instanceof Presence) {
        onlyAvailable=packet.getFrom() == null || !serverName.equals(packet.getFrom().toString());
      }
      ClientRoute clientRoute=usersCache.get(jid.toString());
      if (clientRoute == null) {
        clientRoute=anonymousUsersCache.get(jid.toString());
      }
      if (clientRoute != null) {
        if (onlyAvailable && !clientRoute.isAvailable()) {
          routed=false;
        }
 else {
          if (Arrays.equals(clientRoute.getNodeID(),server.getNodeID())) {
            try {
              localRoutingTable.getRoute(jid.toString()).process(packet);
              routed=true;
            }
 catch (            UnauthorizedException e) {
              Log.error(e);
            }
          }
 else {
            if (remotePacketRouter != null) {
              routed=remotePacketRouter.routePacket(clientRoute.getNodeID(),jid,packet);
            }
          }
        }
      }
    }
  }
 else   if (jid.getDomain().contains(serverName)) {
    RoutableChannelHandler route=localRoutingTable.getRoute(jid.getDomain());
    if (route != null) {
      try {
        route.process(packet);
        routed=true;
      }
 catch (      UnauthorizedException e) {
        Log.error(e);
      }
    }
 else {
      Set<byte[]> nodes=componentsCache.get(jid.getDomain());
      if (nodes != null) {
        for (        byte[] nodeID : nodes) {
          if (Arrays.equals(nodeID,server.getNodeID())) {
            try {
              localRoutingTable.getRoute(jid.getDomain()).process(packet);
              routed=true;
              break;
            }
 catch (            UnauthorizedException e) {
              Log.error(e);
            }
          }
 else {
            if (remotePacketRouter != null) {
              routed=remotePacketRouter.routePacket(nodeID,jid,packet);
              if (routed) {
                break;
              }
            }
          }
        }
      }
    }
  }
 else {
    byte[] nodeID=serversCache.get(jid.getDomain());
    if (nodeID != null) {
      if (Arrays.equals(nodeID,server.getNodeID())) {
        try {
          localRoutingTable.getRoute(jid.getDomain()).process(packet);
          routed=true;
        }
 catch (        UnauthorizedException e) {
          Log.error(e);
        }
      }
 else {
        if (remotePacketRouter != null) {
          routed=remotePacketRouter.routePacket(nodeID,jid,packet);
        }
      }
    }
 else {
      OutgoingSessionPromise.getInstance().process(packet);
      routed=true;
    }
  }
  if (!routed) {
    if (Log.isDebugEnabled()) {
      Log.debug("Failed to route packet to JID: " + jid + " packet: "+ packet);
    }
    if (packet instanceof IQ) {
      iqRouter.routingFailed(jid,packet);
    }
 else     if (packet instanceof Message) {
      messageRouter.routingFailed(jid,packet);
    }
 else     if (packet instanceof Presence) {
      presenceRouter.routingFailed(jid,packet);
    }
  }
}
