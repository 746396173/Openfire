{
  if (Log.isDebugEnabled()) {
    Log.debug("Saving VCARD: " + vCardElement.asXML());
  }
  if (!fieldsIDLoaded) {
synchronized (this) {
      if (!fieldsIDLoaded) {
        loadDefaultProfileFields();
        if (!fieldsIDLoaded) {
          throw new UnsupportedOperationException("Error loading the profiles IDs");
        }
      }
    }
  }
  try {
    long userID=ClearspaceManager.getInstance().getUserID(username);
    ClearspaceUserProvider userProvider=(ClearspaceUserProvider)UserManager.getUserProvider();
    Element userUpdateParams=userProvider.getUserUpdateParams(username);
    Element userElement=userUpdateParams.element("user");
    Element profilesUpdateParams=getProfilesUpdateParams(userID);
    Element avatarCreateParams=getAvatarCreateParams(userID);
    ClearspaceVCardTranslator.Action[] actions;
    actions=ClearspaceVCardTranslator.getInstance().translateVCard(vCardElement,profilesUpdateParams,userElement,avatarCreateParams);
    if ((actions[1] != NO_ACTION && userProvider.isReadOnly()) || (actions[2] != NO_ACTION && isAvatarReadOnly())) {
      throw new UnsupportedOperationException("ClearspaceVCardProvider: Invalid vcard changes.");
    }
    if (actions[0] != NO_ACTION) {
      updateProfiles(profilesUpdateParams);
    }
    if (actions[1] != NO_ACTION) {
      userProvider.updateUser(userUpdateParams);
    }
    if (actions[2] != NO_ACTION) {
      if (actions[2] == DELETE) {
        setActiveAvatar(userID,-1);
      }
 else {
        long avatarID=createAvatar(avatarCreateParams);
        setActiveAvatar(userID,avatarID);
      }
    }
  }
 catch (  UnsupportedOperationException e) {
    throw e;
  }
catch (  Exception e) {
    throw new UnsupportedOperationException("Error saving the VCard",e);
  }
  return loadVCard(username);
}
