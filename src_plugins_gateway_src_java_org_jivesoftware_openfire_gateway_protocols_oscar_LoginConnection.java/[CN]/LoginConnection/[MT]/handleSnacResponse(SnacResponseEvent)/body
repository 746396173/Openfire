{
  SnacCommand cmd=e.getSnacCommand();
  if (cmd instanceof KeyResponse) {
    Log.debug("Handling AIM-style auth.");
    KeyResponse kr=(KeyResponse)cmd;
    ByteBlock authkey=kr.getKey();
    ClientVersionInfo version=new ClientVersionInfo("AOL Instant Messenger, version 5.5.3415/WIN32",-1,5,5,0,3415,239);
    String pass=oscarSession.getRegistration().getPassword();
    if (oscarSession.getTransport().getType().equals(TransportType.icq)) {
      if (pass.length() > 8) {
        pass=pass.substring(0,8);
      }
    }
    request(new AuthRequest(oscarSession.getRegistration().getUsername(),pass,version,Locale.US,authkey));
  }
 else   if (cmd instanceof AuthResponse) {
    Log.debug("Got auth response!");
    AuthResponse ar=(AuthResponse)cmd;
    int error=ar.getErrorCode();
    if (error != -1) {
      String errormsg;
switch (error) {
case (AuthResponse.ERROR_ACCOUNT_DELETED):
{
          errormsg=LocaleUtils.getLocalizedString("gateway.oscar.accountdeleted","gateway");
          break;
        }
case (AuthResponse.ERROR_BAD_INPUT):
{
        errormsg=LocaleUtils.getLocalizedString("gateway.oscar.badinput","gateway");
        break;
      }
case (AuthResponse.ERROR_BAD_PASSWORD):
{
      errormsg=LocaleUtils.getLocalizedString("gateway.oscar.badpassword","gateway");
      break;
    }
case (AuthResponse.ERROR_CLIENT_TOO_OLD):
{
    errormsg=LocaleUtils.getLocalizedString("gateway.oscar.oldclient","gateway");
    break;
  }
case (AuthResponse.ERROR_CONNECTING_TOO_MUCH_A):
case (AuthResponse.ERROR_CONNECTING_TOO_MUCH_B):
{
  errormsg=LocaleUtils.getLocalizedString("gateway.oscar.connectedtoomuch","gateway");
  break;
}
case (AuthResponse.ERROR_INVALID_SN_OR_PASS_A):
case (AuthResponse.ERROR_INVALID_SN_OR_PASS_B):
{
errormsg=LocaleUtils.getLocalizedString("gateway.oscar.baduserorpass","gateway");
break;
}
case (AuthResponse.ERROR_SIGNON_BLOCKED):
{
errormsg=LocaleUtils.getLocalizedString("gateway.oscar.accountsuspended","gateway");
break;
}
default :
{
errormsg=LocaleUtils.getLocalizedString("gateway.oscar.unknownerror","gateway",Arrays.asList(error,ar.getErrorUrl()));
}
}
Message m=new Message();
m.setType(Message.Type.error);
m.setTo(getMainSession().getJID());
m.setFrom(getMainSession().getTransport().getJID());
m.setBody(errormsg);
getMainSession().getTransport().sendPacket(m);
getMainSession().sessionDisconnectedNoReconnect();
}
 else {
Log.debug("Got something else?");
getMainSession().setLoginStatus(TransportLoginStatus.LOGGED_IN);
oscarSession.startBosConn(ar.getServer(),ar.getPort(),ar.getCookie());
Log.info("OSCAR connection to " + ar.getServer() + ":"+ ar.getPort());
}
disconnect();
}
}
