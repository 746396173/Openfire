{
  IQ result=null;
  try {
    JID recipient=packet.getTo();
    IQ.Type type=packet.getType();
    if (type.equals(IQ.Type.set)) {
      User user=userManager.getUser(packet.getFrom().getNode());
      Element vcard=packet.getChildElement();
      if (vcard != null) {
        List nameStack=new ArrayList(5);
        readVCard(vcard,nameStack,user);
      }
      result=IQ.createResultIQ(packet);
    }
 else     if (type.equals(IQ.Type.get)) {
      result=IQ.createResultIQ(packet);
      Element vcard=DocumentHelper.createElement(QName.get("vCard","vcard-temp"));
      result.setChildElement(vcard);
      if (recipient != null && recipient.getNode() != null) {
        User user=userManager.getUser(recipient.getNode());
        VCardManager vManager=VCardManager.getInstance();
        Collection<String> names=vManager.getVCardPropertyNames(user.getUsername());
        for (        String name : names) {
          String path=name.replace(':','/');
          Element node=DocumentHelper.makeElement(vcard,path);
          node.setText(vManager.getVCardProperty(user.getUsername(),name));
        }
      }
    }
 else {
      result=IQ.createResultIQ(packet);
      result.setChildElement(packet.getChildElement().createCopy());
      result.setError(PacketError.Condition.not_acceptable);
    }
  }
 catch (  UserNotFoundException e) {
    result=IQ.createResultIQ(packet);
    result.setChildElement(packet.getChildElement().createCopy());
    result.setError(PacketError.Condition.item_not_found);
  }
  return result;
}
