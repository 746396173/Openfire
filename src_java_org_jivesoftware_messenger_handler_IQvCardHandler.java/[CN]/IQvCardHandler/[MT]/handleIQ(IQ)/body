{
  IQ result=null;
  try {
    JID recipient=packet.getTo();
    IQ.Type type=packet.getType();
    if (type.equals(IQ.Type.set)) {
      User user=userManager.getUser(packet.getFrom().getNode());
      Element vcard=packet.getChildElement();
      if (vcard != null) {
        List nameStack=new ArrayList(5);
        readVCard(vcard,nameStack,user);
      }
      result=IQ.createResultIQ(packet);
    }
 else     if (type.equals(IQ.Type.get)) {
      User user=userManager.getUser(recipient.getNode());
      result=IQ.createResultIQ(packet);
      Element vcard=DocumentHelper.createElement(QName.get("vCard","vcard-temp"));
      result.setChildElement(vcard);
      Iterator names=user.getVCardPropertyNames();
      while (names.hasNext()) {
        String name=(String)names.next();
        String path=name.replace(':','/');
        Element node=DocumentHelper.makeElement(vcard,path);
        node.setText(user.getVCardProperty(name));
      }
    }
 else {
      result=IQ.createResultIQ(packet);
      result.setError(PacketError.Condition.not_acceptable);
    }
  }
 catch (  UserNotFoundException e) {
    result=IQ.createResultIQ(packet);
    result.setError(PacketError.Condition.item_not_found);
  }
  return result;
}
