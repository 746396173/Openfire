{
  lastPacketTime=System.currentTimeMillis();
  JID recipient=packet.getTo();
  String group=recipient.getNode();
  if (group == null) {
    Log.info(LocaleUtils.getLocalizedString("muc.error.not-supported") + " " + packet.toString());
  }
 else {
    MUCRole role=roles.get(group.toLowerCase());
    if (role == null) {
      if (server.hasChatRoom(group)) {
        boolean declinedInvitation=false;
        Element userInfo=null;
        if (Message.Type.normal == packet.getType()) {
          userInfo=packet.getChildElement("x","http://jabber.org/protocol/muc#user");
          if (userInfo != null && userInfo.element("decline") != null) {
            declinedInvitation=true;
          }
        }
        if (declinedInvitation) {
          Element info=userInfo.element("decline");
          server.getChatRoom(group).sendInvitationRejection(info.attributeValue("to"),info.elementTextTrim("reason"),packet.getFrom());
        }
 else {
          sendErrorPacket(packet,XMPPError.Code.NOT_ACCEPTABLE);
        }
      }
 else {
        sendErrorPacket(packet,XMPPError.Code.NOT_FOUND);
      }
    }
 else {
      if (!role.getChatUser().getAddress().equals(packet.getSender())) {
        sendErrorPacket(packet,XMPPError.Code.CONFLICT);
      }
 else {
        try {
          if (packet.getSubject() != null && packet.getSubject().trim().length() > 0 && Message.GROUP_CHAT == packet.getType()) {
            role.getChatRoom().changeSubject(packet,role);
          }
 else {
            Message.Type type=packet.getType();
            String resource=packet.getRecipient().getResource();
            if (resource == null || resource.trim().length() == 0) {
              resource=null;
            }
            if (resource == null && Message.GROUP_CHAT == type) {
              role.getChatRoom().sendPublicMessage(packet,role);
            }
 else             if (resource != null && (Message.CHAT == type || Message.NORMAL == type)) {
              role.getChatRoom().sendPrivateMessage(packet,role);
            }
 else             if (resource == null && Message.NORMAL == type) {
              XMPPDOMFragment userInfo=(XMPPDOMFragment)packet.getFragment("x","http://jabber.org/protocol/muc#user");
              MUCRoomImpl room=(MUCRoomImpl)role.getChatRoom();
              if (userInfo != null && userInfo.getRootElement().element("invite") != null) {
                Element info=userInfo.getRootElement().element("invite");
                if (room.isInvitationRequiredToEnter()) {
                  room.lock.writeLock().lock();
                  try {
                    room.addMember(info.attributeValue("to"),null,role);
                  }
  finally {
                    room.lock.writeLock().unlock();
                  }
                }
                room.sendInvitation(info.attributeValue("to"),info.elementTextTrim("reason"),role,packet.getOriginatingSession());
              }
 else               if (userInfo != null && userInfo.getRootElement().element("decline") != null) {
                Element info=userInfo.getRootElement().element("decline");
                room.sendInvitationRejection(info.attributeValue("to"),info.elementTextTrim("reason"),packet.getSender(),packet.getOriginatingSession());
              }
 else {
                sendErrorPacket(packet,XMPPError.Code.BAD_REQUEST);
              }
            }
 else {
              sendErrorPacket(packet,XMPPError.Code.BAD_REQUEST);
            }
          }
        }
 catch (        ForbiddenException e) {
          sendErrorPacket(packet,XMPPError.Code.FORBIDDEN);
        }
catch (        NotFoundException e) {
          sendErrorPacket(packet,XMPPError.Code.NOT_FOUND);
        }
catch (        ConflictException e) {
          sendErrorPacket(packet,XMPPError.Code.CONFLICT);
        }
      }
    }
  }
}
