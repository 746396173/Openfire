{
  Log.info("RayoComponent routeJoinEvent " + callee + " "+ callId+ " "+ groupName+ " "+ memberCount+ " "+ farParty);
  Presence presence=new Presence();
  presence.setFrom(callId + "@rayo." + getDomain());
  presence.setTo(callee);
  Map<String,String> headers=callParticipant.getHeaders();
  headers.put("call_owner",callParticipant.getCallOwner());
  headers.put("call_action",conferenceEvent.equals(ConferenceEvent.MEMBER_LEFT) ? "leave" : "join");
  headers.put("call_protocol",callParticipant.getProtocol());
  headers.put("mixer_name",conferenceEvent.getConferenceId());
  headers.put("group_name",groupName);
  if (memberCount > 2) {
    if (conferenceEvent.equals(ConferenceEvent.MEMBER_LEFT)) {
      UnjoinedEvent event=new UnjoinedEvent(null,conferenceEvent.getConferenceId(),JoinDestinationType.MIXER);
      presence.getElement().add(rayoProvider.toXML(event));
    }
 else {
      JoinedEvent event=new JoinedEvent(null,conferenceEvent.getConferenceId(),JoinDestinationType.MIXER);
      presence.getElement().add(rayoProvider.toXML(event));
    }
    sendPacket(presence);
  }
 else {
    if (memberCount == 2) {
      if (conferenceEvent.equals(ConferenceEvent.MEMBER_LEFT)) {
        if (callId.equals(conferenceEvent.getCallId()) == false) {
          presence.getElement().add(rayoProvider.toXML(new AnsweredEvent(null,headers)));
          sendPacket(presence);
        }
      }
 else {
        if (callId.equals(conferenceEvent.getCallId())) {
          presence.getElement().add(rayoProvider.toXML(new AnsweredEvent(null,headers)));
        }
 else {
          if (farParty != null) {
            CallParticipant fp=farParty.getCallParticipant();
            if (fp.isHeld()) {
              fp.setHeld(false);
              presence.getElement().add(rayoProvider.toXML(new AnsweredEvent(null,headers)));
            }
 else {
              presence.getElement().add(rayoProvider.toXML(new AnsweredEvent(null,headers)));
            }
          }
        }
        sendPacket(presence);
      }
    }
 else     if (memberCount == 1) {
      if (conferenceEvent.equals(ConferenceEvent.MEMBER_LEFT)) {
        if (callId.equals(conferenceEvent.getCallId()) == false) {
          if (farParty != null) {
            CallParticipant fp=farParty.getCallParticipant();
            fp.setHeld(true);
            presence.getElement().add(toXML(new OnHoldEvent()));
            sendPacket(presence);
          }
        }
      }
    }
 else {
      presence.getElement().add(rayoProvider.toXML(new EndEvent(null,EndEvent.Reason.valueOf("HANGUP"),headers)));
      sendPacket(presence);
      finishCallRecord(callParticipant);
    }
  }
}
