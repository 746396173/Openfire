{
  Log.info("RayoComponent handleHandsetDialCommand " + iq.getFrom());
  IQ reply=IQ.createResultIQ(iq);
  Map<String,String> headers=command.getHeaders();
  String from=command.getFrom().toString();
  String to=command.getTo().toString();
  boolean toPhone=to.indexOf("sip:") == 0 || to.indexOf("tel:") == 0;
  boolean toXmpp=to.indexOf("xmpp:") == 0;
  String callId=headers.get("call_id");
  String callerName=headers.get("caller_name");
  String calledName=headers.get("called_name");
  String handsetId=iq.getFrom().toString();
  JoinCommand join=command.getJoin();
  if (join != null) {
    if (join.getType() == JoinDestinationType.CALL) {
    }
 else {
    }
    reply.setError(PacketError.Condition.feature_not_implemented);
  }
 else {
    if (callId == null) {
      callId="rayo-call-" + System.currentTimeMillis();
      headers.put("call_id",callId);
    }
    if (callerName == null) {
      callerName=iq.getFrom().getNode();
      headers.put("caller_name",callerName);
    }
    if (toPhone) {
      if (calledName == null) {
        calledName=to;
        headers.put("called_name",calledName);
      }
      CallParticipant cp=new CallParticipant();
      cp.setVoiceDetection(true);
      cp.setCallOwner(handsetId);
      cp.setMediaPreference("PCMU/8000/1");
      cp.setProtocol("SIP");
      cp.setCallId(callId);
      cp.setDisplayName(callerName);
      cp.setPhoneNumber(to);
      cp.setName(calledName);
      cp.setHeaders(headers);
      reply=doPhoneAndPcCall(JID.escapeNode(handsetId),cp,reply);
    }
 else     if (toXmpp) {
      headers.put("call_protocol","XMPP");
      String destination=to.substring(5);
      String source=JID.escapeNode(handsetId);
      RelayChannel channel=plugin.getRelayChannel(source);
      if (channel != null) {
        headers.put("mixer_name",channel.getHandset().mixer);
        headers.put("codec_name",channel.getHandset().codec);
        Presence presence=new Presence();
        presence.setFrom(source + "@rayo." + getDomain());
        presence.setTo(new JID(destination));
        OfferEvent offer=new OfferEvent(callId);
        try {
          offer.setFrom(new URI("xmpp:" + iq.getFrom().toString()));
          offer.setTo(new URI(to));
        }
 catch (        URISyntaxException e) {
          reply.setError(PacketError.Condition.feature_not_implemented);
          return reply;
        }
        if (calledName == null) {
          calledName=presence.getTo().getNode();
          headers.put("called_name",calledName);
        }
        offer.setHeaders(headers);
        presence.getElement().add(rayoProvider.toXML(offer));
        sendPacket(presence);
        final Element childElement=reply.setChildElement("ref","urn:xmpp:rayo:1");
        childElement.addAttribute(URI,(String)"xmpp:" + destination);
        childElement.addAttribute(ID,(String)JID.escapeNode(destination));
      }
 else {
        reply.setError(PacketError.Condition.item_not_found);
      }
    }
 else {
      reply.setError(PacketError.Condition.feature_not_implemented);
    }
  }
  return reply;
}
