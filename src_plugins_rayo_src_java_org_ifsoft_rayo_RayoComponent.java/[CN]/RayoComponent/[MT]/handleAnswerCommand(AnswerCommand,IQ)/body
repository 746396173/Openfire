{
  Log.info("RayoComponent AnswerCommand " + iq.getFrom() + " "+ iq.getTo().getNode());
  IQ reply=IQ.createResultIQ(iq);
  Map<String,String> headers=command.getHeaders();
  headers.put("call-protocol","XMPP");
  try {
    Presence presence1=new Presence();
    presence1.setFrom(iq.getTo());
    presence1.setTo(JID.unescapeNode(iq.getTo().getNode()));
    presence1.getElement().add(rayoProvider.toXML(new AnsweredEvent(null,headers)));
    sendPacket(presence1);
    Presence presence2=new Presence();
    presence2.setFrom(iq.getTo());
    presence2.setTo(iq.getFrom());
    presence2.getElement().add(rayoProvider.toXML(new AnsweredEvent(null,headers)));
    sendPacket(presence2);
    String handsetId=iq.getTo().getNode();
    RelayChannel channel=plugin.getRelayChannel(handsetId);
    if (channel != null) {
      Handset handset=channel.getHandset();
      CallHandler callHandler=channel.getCallHandler();
      if (callHandler != null) {
        Log.info("RayoComponent handleAnswerCommand found call handler " + callHandler);
        CallParticipant cp=callHandler.getCallParticipant();
        if (cp != null) {
          String username=iq.getFrom().getNode();
          ConferenceManager conferenceManager=ConferenceManager.getConference(handset.mixer,channel.getMediaPreference(),username,false);
          try {
            cp.setStartTimestamp(System.currentTimeMillis());
            cp.setHeaders(headers);
            String recording=handset.mixer + "-" + cp.getStartTimestamp()+ ".au";
            conferenceManager.recordConference(true,recording,"au");
            String source=(new JID(JID.unescapeNode(iq.getTo().getNode()))).getNode();
            String destination=iq.getFrom().getNode();
            Config.createCallRecord(source,recording,destination,cp.getStartTimestamp(),0,"dialed");
            Config.createCallRecord(destination,recording,source,cp.getStartTimestamp(),0,"received");
          }
 catch (          ParseException e1) {
            reply.setError(PacketError.Condition.internal_server_error);
          }
        }
 else         reply.setError(PacketError.Condition.item_not_found);
      }
 else       reply.setError(PacketError.Condition.item_not_found);
    }
 else     reply.setError(PacketError.Condition.item_not_found);
  }
 catch (  Exception e) {
    reply.setError(PacketError.Condition.item_not_found);
    e.printStackTrace();
  }
  return reply;
}
