{
  if (isReadOnly()) {
    throw new UnsupportedOperationException();
  }
  try {
    loadUser(username);
    throw new UserAlreadyExistsException("Username " + username + " already exists");
  }
 catch (  UserNotFoundException unfe) {
    Date now=new Date();
    Connection con=null;
    PreparedStatement pstmt=null;
    try {
      con=DbConnectionManager.getConnection();
      pstmt=con.prepareStatement(INSERT_USER);
      pstmt.setString(1,username);
      pstmt.setString(2,password);
      if (name == null) {
        pstmt.setNull(3,Types.VARCHAR);
      }
 else {
        pstmt.setString(3,name);
      }
      if (email == null) {
        pstmt.setNull(4,Types.VARCHAR);
      }
 else {
        pstmt.setString(4,email);
      }
      pstmt.setString(5,StringUtils.dateToMillis(now));
      pstmt.setString(6,StringUtils.dateToMillis(now));
      pstmt.execute();
    }
 catch (    Exception e) {
      Log.error(LocaleUtils.getLocalizedString("admin.error"),e);
    }
 finally {
      try {
        if (pstmt != null) {
          pstmt.close();
        }
      }
 catch (      Exception e) {
        Log.error(e);
      }
      try {
        if (con != null) {
          con.close();
        }
      }
 catch (      Exception e) {
        Log.error(e);
      }
    }
    return new User(username,name,email,now,now);
  }
}
