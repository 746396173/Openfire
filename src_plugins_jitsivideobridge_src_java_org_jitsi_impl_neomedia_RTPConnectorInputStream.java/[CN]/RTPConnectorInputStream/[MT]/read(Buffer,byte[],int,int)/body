{
  if (data == null)   throw new NullPointerException("data");
  if (ioError)   return -1;
  RawPacket pkt;
synchronized (pktSyncRoot) {
    pkt=this.pkt;
    this.pkt=null;
  }
  int pktLength;
  if (pkt == null) {
    pktLength=0;
  }
 else {
    boolean poolPkt=true;
    try {
      pktLength=pkt.getLength();
      if (length < pktLength) {
        poolPkt=false;
        throw new IOException("Input buffer not big enough for " + pktLength);
      }
 else {
        byte[] pktBuffer=pkt.getBuffer();
        if (pktBuffer == null) {
          throw new NullPointerException("pkt.buffer null, pkt.length " + pktLength + ", pkt.offset "+ pkt.getOffset());
        }
 else {
          System.arraycopy(pkt.getBuffer(),pkt.getOffset(),data,offset,pktLength);
          if (buffer != null)           buffer.setFlags(pkt.getFlags());
        }
      }
    }
  finally {
      if (!poolPkt) {
synchronized (pktSyncRoot) {
          if (this.pkt == null)           this.pkt=pkt;
 else           poolPkt=true;
        }
      }
      if (poolPkt) {
        poolRawPacket(pkt);
      }
    }
  }
  return pktLength;
}
