{
  IQ returnPacket=null;
  Session session=null;
  try {
    sessionManager.getSession(packet.getFrom());
  }
 catch (  Exception e) {
    IQ error=IQ.createResultIQ(packet);
    error.setError(PacketError.Condition.internal_server_error);
    return error;
  }
  IQ.Type type=packet.getType();
  try {
    User sessionUser=userManager.getUser(session.getUsername());
    CachedRoster cachedRoster=(CachedRoster)sessionUser.getRoster();
    if (IQ.Type.get == type) {
      returnPacket=cachedRoster.getReset();
      returnPacket.setType(IQ.Type.result);
      returnPacket.setTo(session.getAddress());
      returnPacket.setID(packet.getID());
      deliverer.deliver(returnPacket);
      returnPacket=null;
    }
 else     if (IQ.Type.set == type) {
      Iterator itemIter=packet.getRosterItems();
      while (itemIter.hasNext()) {
        RosterItem item=(RosterItem)itemIter.next();
        if (item.getSubStatus() == RosterItem.SUB_REMOVE) {
          removeItem(cachedRoster,packet.getFrom(),item);
        }
 else {
          if (cachedRoster.isRosterItem(item.getJid())) {
            CachedRosterItem cachedItem=(CachedRosterItem)cachedRoster.getRosterItem(item.getJid());
            cachedItem.setAsCopyOf(item);
            cachedRoster.updateRosterItem(cachedItem);
          }
 else {
            cachedRoster.createRosterItem(item);
          }
        }
      }
      returnPacket=IQ.createResultIQ(packet);
    }
  }
 catch (  UserNotFoundException e) {
    throw new UnauthorizedException(e);
  }
  return returnPacket;
}
