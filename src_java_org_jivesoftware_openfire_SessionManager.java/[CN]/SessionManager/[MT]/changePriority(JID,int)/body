{
  if (sender.getNode() == null || !userManager.isRegisteredUser(sender.getNode())) {
    return;
  }
  ClientSession defaultSession;
  String username=sender.getNode();
  SessionMap resources=sessions.get(username);
  if (resources == null) {
    return;
  }
synchronized (username.intern()) {
    resources.changePriority(sender,priority);
    defaultSession=resources.getDefaultSession(true);
  }
  JID defaultAddress=new JID(sender.getNode(),sender.getDomain(),"",true);
  if (defaultSession != null) {
    boolean hadDefault=routingTable.hasClientRoute(defaultAddress);
    routingTable.addClientRoute(defaultAddress,defaultSession);
    if (!hadDefault) {
      ClientSession session=resources.getSession(sender.getResource());
      if (session != null && session.canFloodOfflineMessages()) {
        OfflineMessageStore messageStore=XMPPServer.getInstance().getOfflineMessageStore();
        Collection<OfflineMessage> messages=messageStore.getMessages(username,true);
        for (        Message message : messages) {
          session.process(message);
        }
      }
    }
  }
 else {
    routingTable.removeClientRoute(defaultAddress);
  }
}
