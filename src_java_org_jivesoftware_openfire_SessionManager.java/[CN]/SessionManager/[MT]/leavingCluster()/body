{
  if (XMPPServer.getInstance().isShuttingDown()) {
  }
 else {
    for (    Session session : localSessionManager.getComponentsSessions()) {
      componentSessionsCache.remove(session.getAddress().toString());
    }
    for (    String address : localSessionManager.getConnnectionManagerSessions().keySet()) {
      multiplexerSessionsCache.remove(address);
    }
    for (    LocalIncomingServerSession session : localSessionManager.getIncomingServerSessions()) {
      String streamID=session.getStreamID().getID();
      incomingServerSessionsCache.remove(streamID);
      for (      String hostname : session.getValidatedDomains()) {
        Lock lock=LockManager.getLock(hostname);
        try {
          lock.lock();
          List<String> streamIDs=hostnameSessionsCache.get(hostname);
          streamIDs.remove(streamID);
          if (streamIDs.isEmpty()) {
            hostnameSessionsCache.remove(hostname);
          }
 else {
            hostnameSessionsCache.put(hostname,streamIDs);
          }
        }
  finally {
          lock.unlock();
        }
        lock=LockManager.getLock(streamID);
        try {
          lock.lock();
          Set<String> validatedDomains=validatedDomainsCache.get(streamID);
          if (validatedDomains == null) {
            validatedDomains=new HashSet<String>();
          }
          validatedDomains.remove(hostname);
          if (!validatedDomains.isEmpty()) {
            validatedDomainsCache.put(streamID,validatedDomains);
          }
 else {
            validatedDomainsCache.remove(streamID);
          }
        }
  finally {
          lock.unlock();
        }
      }
    }
    for (    ClientSession session : routingTable.getClientsRoutes(true)) {
      decrementCounter("conncounter");
      if (session.getStatus() == Session.STATUS_AUTHENTICATED) {
        decrementCounter("usercounter");
      }
    }
  }
}
