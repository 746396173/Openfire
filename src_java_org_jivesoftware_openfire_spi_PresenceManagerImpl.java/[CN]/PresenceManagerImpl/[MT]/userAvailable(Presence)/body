{
  if (presence.getTo() == null && server.isLocal(presence.getFrom())) {
    String username=presence.getFrom().getNode();
    if (username == null || !userManager.isRegisteredUser(username)) {
      return;
    }
    if (sessionManager.getSessionCount(username) > 1) {
      return;
    }
    Connection con=null;
    PreparedStatement pstmt=null;
    try {
      con=DbConnectionManager.getConnection();
      pstmt=con.prepareStatement(DELETE_OFFLINE_PRESENCE);
      pstmt.setString(1,username);
      pstmt.execute();
    }
 catch (    SQLException sqle) {
      Log.error(sqle);
    }
 finally {
      DbConnectionManager.closeConnection(pstmt,con);
    }
    offlinePresenceCache.remove(username);
    lastActivityCache.remove(username);
  }
}
