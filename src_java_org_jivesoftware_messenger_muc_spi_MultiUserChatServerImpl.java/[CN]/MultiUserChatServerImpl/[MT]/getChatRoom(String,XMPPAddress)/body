{
  MUCRoom room=null;
synchronized (rooms) {
    room=rooms.get(roomName.toLowerCase());
    if (room == null) {
      room=new MUCRoomImpl(this,roomName,router);
      if (!room.isPersistent()) {
        if (isRoomCreationRestricted() && !sysadmins.contains(userjid.toBareStringPrep())) {
          if (!allowedToCreate.contains(userjid.toBareStringPrep())) {
            throw new UnauthorizedException();
          }
        }
        room.addFirstOwner(userjid.toBareStringPrep());
      }
 else {
        MUCPersistenceManager.updateRoomInMemory(room,true);
        persistentRoomSurrogateCache.remove(room.getName());
      }
      rooms.put(roomName.toLowerCase(),room);
    }
  }
  return room;
}
